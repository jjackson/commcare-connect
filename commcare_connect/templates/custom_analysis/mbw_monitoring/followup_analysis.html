{% extends "base.html" %}
{% load static %}

{% block title %}MBW Monitoring Dashboard{% endblock %}

{% block content %}
<div class="container mx-auto p-6" x-data="mbwFollowupAnalysis()">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">MBW Monitoring Dashboard</h1>
            <p class="text-gray-600 mt-1">Followup visit completion rate tracking</p>
        </div>
        <div class="flex items-center gap-3" x-show="!loading && !loadError" x-cloak>
            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-md text-sm font-medium" x-text="opportunityName"></span>
            <button @click="refreshData()" class="button button-sm outline-style">
                <i class="fa-solid fa-arrows-rotate mr-1"></i>
                Refresh
            </button>
        </div>
    </div>

    {% if error %}
        <!-- Error Alert -->
        <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa-solid fa-exclamation-circle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700">
                        <strong>Error:</strong> {{ error }}
                    </p>
                </div>
            </div>
        </div>
    {% elif not has_context %}
        <!-- No Context Warning -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa-solid fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        Please select an opportunity from the labs context to view analysis.
                    </p>
                </div>
            </div>
        </div>
    {% else %}

    <!-- Date Range Filter -->
    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-6">
        <div class="flex flex-wrap items-end gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                <input type="date"
                       x-model="startDate"
                       class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                <input type="date"
                       x-model="endDate"
                       class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button @click="applyDateFilter()"
                    class="button primary-style"
                    :disabled="loading">
                <i class="fa-solid fa-filter mr-1"></i>
                Apply Filter
            </button>
            <button @click="resetDateFilter()"
                    class="button outline-style"
                    :disabled="loading">
                Reset to Last 30 Days
            </button>
        </div>
        <p class="text-xs text-gray-500 mt-2">
            Showing visits scheduled from <span x-text="startDate"></span> to <span x-text="endDate"></span>
        </p>
    </div>

    <!-- Loading Indicator -->
    <div class="mb-6 p-6 bg-blue-50 border border-blue-200 rounded-lg" x-show="loading" x-cloak>
        <div class="flex items-start gap-4">
            <i class="fa-solid fa-spinner fa-spin text-blue-600 text-2xl mt-1"></i>
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-blue-900 mb-2">Analyzing Followup Data</h3>
                <p class="text-sm text-blue-700" x-text="loadingMessage || 'Loading...'"></p>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg" x-show="loadError" x-cloak>
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fa-solid fa-circle-exclamation text-red-600 mr-3"></i>
                <div>
                    <strong class="text-red-800">Error:</strong>
                    <span class="ml-2 text-red-700" x-text="loadError"></span>
                </div>
            </div>
            <button @click="loadData()"
                    class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-sm font-medium">
                <i class="fa-solid fa-rotate mr-1"></i>Retry
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div x-show="!loading && !loadError" x-cloak>

        <!-- Summary Statistics -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="border-l-4 border-blue-500 pl-3">
                    <div class="text-sm text-gray-600">Total Cases</div>
                    <div class="text-2xl font-bold text-gray-900" x-text="summary.total_cases || 0"></div>
                </div>
                <div class="border-l-4 border-blue-500 pl-3">
                    <div class="text-sm text-gray-600">Total FLWs</div>
                    <div class="text-2xl font-bold text-gray-900" x-text="flwSummaries.length"></div>
                </div>
                <div class="border-l-4 border-green-500 pl-3">
                    <div class="text-sm text-gray-600">Date Range</div>
                    <div class="text-sm font-medium text-gray-900">
                        <span x-text="summary.date_range_start || '-'"></span> to <span x-text="summary.date_range_end || '-'"></span>
                    </div>
                </div>
                <div class="border-l-4 border-purple-500 pl-3">
                    <div class="text-sm text-gray-600">Avg Completion Rate</div>
                    <div class="text-2xl font-bold text-gray-900" x-text="computeOverallRate() + '%'"></div>
                </div>
            </div>
        </div>

        <!-- FLW Followup Table -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h2 class="text-xl font-semibold text-gray-900">
                    FLW Followup Rates
                    <span class="text-sm text-gray-600 font-normal">(<span x-text="flwSummaries.length"></span> FLWs)</span>
                </h2>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FLW Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completion Rate</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Completed</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Due</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ANC</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Postnatal</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Week 1</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month 1</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month 3</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Month 6</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="flw in flwSummaries" :key="flw.username">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm">
                                    <div class="font-medium text-gray-900" x-text="flw.display_name"></div>
                                    <template x-if="flw.display_name !== flw.username">
                                        <div class="text-xs text-gray-500" x-text="flw.username"></div>
                                    </template>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <div class="flex items-center">
                                        <div class="w-16 bg-gray-200 rounded-full h-2 mr-2">
                                            <div class="bg-green-500 h-2 rounded-full" :style="'width: ' + Math.min(100, flw.completion_rate) + '%'"></div>
                                        </div>
                                        <span class="font-bold" :class="flw.completion_rate >= 80 ? 'text-green-600' : flw.completion_rate >= 50 ? 'text-yellow-600' : 'text-red-600'" x-text="flw.completion_rate + '%'"></span>
                                    </div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="flw.completed_total"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="flw.due_total"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs">
                                    <div class="text-green-600"><i class="fa-solid fa-check mr-1"></i><span x-text="flw.anc_completed_on_time + flw.anc_completed_late"></span></div>
                                    <div class="text-gray-500"><i class="fa-solid fa-clock mr-1"></i><span x-text="flw.anc_due_on_time + flw.anc_due_late"></span></div>
                                    <div class="text-red-600" x-show="flw.anc_missed > 0"><i class="fa-solid fa-times mr-1"></i><span x-text="flw.anc_missed"></span></div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs">
                                    <div class="text-green-600"><i class="fa-solid fa-check mr-1"></i><span x-text="flw.postnatal_completed_on_time + flw.postnatal_completed_late"></span></div>
                                    <div class="text-gray-500"><i class="fa-solid fa-clock mr-1"></i><span x-text="flw.postnatal_due_on_time + flw.postnatal_due_late"></span></div>
                                    <div class="text-red-600" x-show="flw.postnatal_missed > 0"><i class="fa-solid fa-times mr-1"></i><span x-text="flw.postnatal_missed"></span></div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs">
                                    <div class="text-green-600"><i class="fa-solid fa-check mr-1"></i><span x-text="flw.week1_completed_on_time + flw.week1_completed_late"></span></div>
                                    <div class="text-gray-500"><i class="fa-solid fa-clock mr-1"></i><span x-text="flw.week1_due_on_time + flw.week1_due_late"></span></div>
                                    <div class="text-red-600" x-show="flw.week1_missed > 0"><i class="fa-solid fa-times mr-1"></i><span x-text="flw.week1_missed"></span></div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs">
                                    <div class="text-green-600"><i class="fa-solid fa-check mr-1"></i><span x-text="flw.month1_completed_on_time + flw.month1_completed_late"></span></div>
                                    <div class="text-gray-500"><i class="fa-solid fa-clock mr-1"></i><span x-text="flw.month1_due_on_time + flw.month1_due_late"></span></div>
                                    <div class="text-red-600" x-show="flw.month1_missed > 0"><i class="fa-solid fa-times mr-1"></i><span x-text="flw.month1_missed"></span></div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs">
                                    <div class="text-green-600"><i class="fa-solid fa-check mr-1"></i><span x-text="flw.month3_completed_on_time + flw.month3_completed_late"></span></div>
                                    <div class="text-gray-500"><i class="fa-solid fa-clock mr-1"></i><span x-text="flw.month3_due_on_time + flw.month3_due_late"></span></div>
                                    <div class="text-red-600" x-show="flw.month3_missed > 0"><i class="fa-solid fa-times mr-1"></i><span x-text="flw.month3_missed"></span></div>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-xs">
                                    <div class="text-green-600"><i class="fa-solid fa-check mr-1"></i><span x-text="flw.month6_completed_on_time + flw.month6_completed_late"></span></div>
                                    <div class="text-gray-500"><i class="fa-solid fa-clock mr-1"></i><span x-text="flw.month6_due_on_time + flw.month6_due_late"></span></div>
                                    <div class="text-red-600" x-show="flw.month6_missed > 0"><i class="fa-solid fa-times mr-1"></i><span x-text="flw.month6_missed"></span></div>
                                </td>
                            </tr>
                        </template>
                        <template x-if="flwSummaries.length === 0">
                            <tr>
                                <td colspan="10" class="px-4 py-8 text-center text-sm text-gray-500">
                                    No data available for the selected date range
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    {% endif %}
</div>
{% endblock %}

{% block inline_javascript %}
{{ block.super }}
<script>
function mbwFollowupAnalysis() {
    return {
        // Loading state
        loading: true,
        loadingMessage: '',
        loadError: null,

        // Date range
        startDate: '{{ start_date }}',
        endDate: '{{ end_date }}',

        // Data
        flwSummaries: [],
        summary: {},
        opportunityId: {{ opportunity_id|default:"null" }},
        opportunityName: '{{ opportunity_name|default:"" }}',

        // URLs
        streamApiUrl: '{{ stream_api_url|default:"" }}',
        dataApiUrl: '{{ data_api_url|default:"" }}',

        // EventSource reference
        eventSource: null,

        // Initialize
        init() {
            if (this.streamApiUrl) {
                this.loadDataWithSSE();
            }
        },

        // Compute overall completion rate
        computeOverallRate() {
            if (this.flwSummaries.length === 0) return 0;
            const totalCompleted = this.flwSummaries.reduce((sum, flw) => sum + flw.completed_total, 0);
            const totalDue = this.flwSummaries.reduce((sum, flw) => sum + flw.due_total, 0);
            if (totalDue === 0) return 0;
            return Math.round((totalCompleted / totalDue) * 100);
        },

        // Apply date filter
        applyDateFilter() {
            const url = new URL(window.location.href);
            url.searchParams.set('start_date', this.startDate);
            url.searchParams.set('end_date', this.endDate);
            window.location.href = url.toString();
        },

        // Reset date filter to last 30 days
        resetDateFilter() {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 30);

            const url = new URL(window.location.href);
            url.searchParams.set('start_date', start.toISOString().split('T')[0]);
            url.searchParams.set('end_date', end.toISOString().split('T')[0]);
            window.location.href = url.toString();
        },

        // Refresh data
        refreshData() {
            const url = new URL(window.location.href);
            url.searchParams.set('refresh', '1');
            window.location.href = url.toString();
        },

        // Load data using Server-Sent Events
        loadDataWithSSE() {
            this.loading = true;
            this.loadError = null;
            this.loadingMessage = 'Connecting...';

            if (this.eventSource) {
                this.eventSource.close();
            }

            const params = new URLSearchParams({
                start_date: this.startDate,
                end_date: this.endDate
            });
            const url = this.streamApiUrl + '?' + params.toString();
            console.log('[MBW Followup] Starting SSE connection:', url);

            this.eventSource = new EventSource(url);

            this.eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('[MBW Followup] SSE event:', data);

                    this.loadingMessage = data.message;

                    if (data.error) {
                        this.loadError = data.error;
                        this.loading = false;
                        this.eventSource.close();
                        return;
                    }

                    if (data.complete && data.data) {
                        const responseData = data.data;

                        this.flwSummaries = responseData.flw_summaries || [];
                        this.summary = {
                            total_cases: responseData.total_cases,
                            date_range_start: responseData.date_range_start,
                            date_range_end: responseData.date_range_end
                        };
                        this.opportunityId = responseData.opportunity_id;
                        this.opportunityName = responseData.opportunity_name || '';

                        this.loading = false;
                        this.eventSource.close();
                        console.log(`[MBW Followup] Loaded ${this.flwSummaries.length} FLWs`);
                    }
                } catch (e) {
                    console.error('[MBW Followup] Error parsing SSE event:', e);
                }
            };

            this.eventSource.onerror = (error) => {
                console.error('[MBW Followup] SSE error:', error);
                this.eventSource.close();
                this.loadError = 'Connection lost. Please try again.';
                this.loading = false;
            };
        }
    };
}
</script>
{% endblock %}
