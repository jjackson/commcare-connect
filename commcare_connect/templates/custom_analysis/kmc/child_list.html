{% extends "base.html" %}
{% load static %}

{% block title %}KMC - Children{% endblock %}

{% block content %}
<div class="container mx-auto p-6" x-data="kmcChildList()">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">KMC - Children</h1>
            <p class="text-gray-600 mt-1">View individual child timelines</p>
        </div>
        <div class="flex items-center gap-3" x-show="!loading && !loadError && children.length > 0" x-cloak>
            <span class="text-sm text-gray-600" x-text="children.length + ' children'"></span>
            <template x-if="fromCache">
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-md text-sm font-medium">
                    <i class="fa-solid fa-clock mr-1"></i>Cached
                </span>
            </template>
            <button @click="refreshData()" class="button button-sm outline-style">
                <i class="fa-solid fa-arrows-rotate mr-1"></i>
                Refresh
            </button>
        </div>
    </div>

    {% if not has_context %}
    <!-- No Context Warning -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fa-solid fa-exclamation-triangle text-yellow-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    Please select an opportunity from the labs context to view children.
                </p>
            </div>
        </div>
    </div>
    {% elif not has_oauth %}
    <!-- No OAuth Warning -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
        <div class="flex">
            <div class="flex-shrink-0">
                <i class="fa-solid fa-lock text-yellow-400"></i>
            </div>
            <div class="ml-3">
                <p class="text-sm text-yellow-700">
                    Please log in to CommCare Connect to load data.
                </p>
            </div>
        </div>
    </div>
    {% else %}

    <!-- Loading Indicator with Progress -->
    <div class="mb-6 p-6 bg-blue-50 border border-blue-200 rounded-lg" x-show="loading" x-cloak>
        <div class="flex items-start gap-4">
            <i class="fa-solid fa-spinner fa-spin text-blue-600 text-2xl mt-1"></i>
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-blue-900 mb-2">Loading KMC Children</h3>
                <p class="text-sm text-blue-800" x-text="loadingMessage"></p>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg" x-show="loadError" x-cloak>
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fa-solid fa-circle-exclamation text-red-600 mr-3"></i>
                <div>
                    <strong class="text-red-800">Error:</strong>
                    <span class="ml-2 text-red-700" x-text="loadError"></span>
                </div>
            </div>
            <button @click="loadData()"
                    class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-sm font-medium">
                <i class="fa-solid fa-rotate mr-1"></i>Retry
            </button>
        </div>
    </div>

    <!-- Main Table (shown after loading) -->
    <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden" x-show="!loading && !loadError" x-cloak>
        <template x-if="children.length > 0">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th @click="sortBy('child_name')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                <div class="flex items-center gap-1">
                                    Child Name
                                    <template x-if="sortColumn === 'child_name'">
                                        <i class="fa-solid" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                    </template>
                                </div>
                            </th>
                            <th @click="sortBy('flw_display_name')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                <div class="flex items-center gap-1">
                                    FLW Name
                                    <template x-if="sortColumn === 'flw_display_name'">
                                        <i class="fa-solid" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                    </template>
                                </div>
                            </th>
                            <th @click="sortBy('visit_count')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                <div class="flex items-center gap-1">
                                    Visits
                                    <template x-if="sortColumn === 'visit_count'">
                                        <i class="fa-solid" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                    </template>
                                </div>
                            </th>
                            <th @click="sortBy('starting_weight')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                <div class="flex items-center gap-1">
                                    Starting Weight
                                    <template x-if="sortColumn === 'starting_weight'">
                                        <i class="fa-solid" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                    </template>
                                </div>
                            </th>
                            <th @click="sortBy('current_weight')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                <div class="flex items-center gap-1">
                                    Current Weight
                                    <template x-if="sortColumn === 'current_weight'">
                                        <i class="fa-solid" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                    </template>
                                </div>
                            </th>
                            <th @click="sortBy('last_visit_date')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                                <div class="flex items-center gap-1">
                                    Last Visit
                                    <template x-if="sortColumn === 'last_visit_date'">
                                        <i class="fa-solid" :class="sortDirection === 'asc' ? 'fa-sort-up' : 'fa-sort-down'"></i>
                                    </template>
                                </div>
                            </th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Actions
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="child in sortedChildren" :key="child.child_id">
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 whitespace-nowrap">
                                    <div class="font-medium text-gray-900" x-text="child.child_name || 'Unknown'"></div>
                                    <div class="text-xs text-gray-500" x-text="'(' + child.child_id + ')'"></div>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="child.flw_display_name || child.flw_username || '-'"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="child.visit_count"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span x-text="child.starting_weight ? child.starting_weight + 'g' : '-'" :class="child.starting_weight ? '' : 'text-gray-400'"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                    <span x-text="child.current_weight ? child.current_weight + 'g' : '-'" :class="child.current_weight ? '' : 'text-gray-400'"></span>
                                </td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900" x-text="formatDate(child.last_visit_date)"></td>
                                <td class="px-6 py-4 whitespace-nowrap text-sm">
                                    <div class="flex gap-2">
                                        <a :href="timelineUrl(child.child_id)"
                                           class="inline-flex items-center px-3 py-1 border border-blue-300 rounded-md text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 hover:border-blue-400 transition-colors">
                                            <i class="fa-solid fa-timeline mr-1"></i> View Timeline
                                        </a>
                                        <a :href="inspectorUrl(child.child_id)"
                                           class="inline-flex items-center px-3 py-1 border border-purple-300 rounded-md text-xs font-medium text-purple-700 bg-purple-50 hover:bg-purple-100 hover:border-purple-400 transition-colors">
                                            <i class="fa-solid fa-search mr-1"></i> View in Inspector
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </template>

        <template x-if="!loading && !loadError && children.length === 0">
            <div class="px-6 py-8 text-center text-sm text-gray-500">
                No children found for this opportunity
            </div>
        </template>
    </div>

    {% endif %}
</div>
{% endblock content %}

{% block inline_javascript %}
{% if has_context and has_oauth %}
<script>
function kmcChildList() {
    return {
        children: [],
        loading: true,
        loadError: null,
        loadingMessage: 'Initializing...',
        fromCache: false,
        sortColumn: 'visit_count',
        sortDirection: 'desc',

        init() {
            this.loadData();
        },

        loadData() {
            this.loading = true;
            this.loadError = null;
            this.loadingMessage = 'Connecting...';

            const streamUrl = '{{ stream_url }}?opportunity_id={{ opportunity_id }}';
            console.log('[KMC Child List] Starting SSE load:', streamUrl);

            const eventSource = new EventSource(streamUrl);

            eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);

                    if (data.error) {
                        console.error('[KMC Child List] Error:', data.error);
                        this.loadError = data.error;
                        this.loading = false;
                        eventSource.close();
                    } else if (data.complete && data.data) {
                        console.log('[KMC Child List] Data loaded:', data.data.children?.length, 'children');
                        this.children = data.data.children || [];
                        this.fromCache = data.data.from_cache || false;
                        this.loading = false;
                        eventSource.close();
                    } else {
                        this.loadingMessage = data.message || 'Loading...';
                    }
                } catch (e) {
                    console.error('[KMC Child List] Error parsing SSE:', e);
                    this.loadError = 'Failed to parse server response';
                    this.loading = false;
                    eventSource.close();
                }
            };

            eventSource.onerror = (error) => {
                console.error('[KMC Child List] SSE error:', error);
                if (this.loading) {
                    this.loadError = 'Connection error. Please try again.';
                    this.loading = false;
                }
                eventSource.close();
            };
        },

        refreshData() {
            // Add refresh param to force cache bypass
            const url = new URL(window.location);
            url.searchParams.set('refresh', '1');
            window.location.href = url.toString();
        },

        sortBy(column) {
            if (this.sortColumn === column) {
                this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                this.sortColumn = column;
                this.sortDirection = 'desc';
            }
        },

        get sortedChildren() {
            return [...this.children].sort((a, b) => {
                let aVal = a[this.sortColumn];
                let bVal = b[this.sortColumn];

                // Handle null/undefined
                if (aVal == null && bVal == null) return 0;
                if (aVal == null) return this.sortDirection === 'asc' ? -1 : 1;
                if (bVal == null) return this.sortDirection === 'asc' ? 1 : -1;

                // String comparison for text fields
                if (typeof aVal === 'string' && typeof bVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return this.sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return this.sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        },

        formatDate(dateStr) {
            if (!dateStr) return '-';
            // Extract date part from ISO string
            if (dateStr.includes('T')) {
                return dateStr.split('T')[0];
            }
            return dateStr;
        },

        timelineUrl(childId) {
            // Build timeline URL using Django-provided base URL with placeholder
            return '{{ timeline_url_base }}'.replace('__CHILD_ID__', encodeURIComponent(childId));
        },

        inspectorUrl(childId) {
            // Build inspector URL using Django-provided query template
            const queryTemplate = '{{ inspector_query_template|escapejs }}';
            const query = queryTemplate.replace('{}', childId);
            return '/labs/explorer/visit-inspector/?query=' + encodeURIComponent(query);
        }
    };
}
</script>
{% endif %}
{% endblock inline_javascript %}
