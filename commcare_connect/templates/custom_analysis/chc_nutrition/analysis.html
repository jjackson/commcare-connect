{% extends "base.html" %}
{% load static %}

{% block title %}CHC Nutrition Analysis{% endblock %}

{% block content %}
<div class="container mx-auto p-6" x-data="chcNutritionAnalysis()">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">CHC Nutrition Analysis</h1>
            <p class="text-gray-600 mt-1">FLW-level nutrition and health metrics</p>
        </div>
        <div class="flex items-center gap-3" x-show="!loading && !loadError" x-cloak>
            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-md text-sm font-medium" x-text="opportunityName"></span>
            <template x-if="fromCache">
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-md text-sm font-medium">
                    <i class="fa-solid fa-clock mr-1"></i>Cached
                </span>
            </template>
            <button @click="refreshData()" class="button button-sm outline-style">
                <i class="fa-solid fa-arrows-rotate mr-1"></i>
                Refresh
            </button>
        </div>
    </div>

    {% if error %}
        <!-- Error Alert (Django-side errors like no context) -->
        <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa-solid fa-exclamation-circle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700">
                        <strong>Error:</strong> {{ error }}
                    </p>
                    {% if needs_oauth %}
                        <a href="{% url 'labs:commcare_initiate' %}" class="button button-sm primary-dark mt-2">
                            <i class="fa-solid fa-lock mr-1"></i>
                            Authorize CommCare Access
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    {% elif not has_context %}
        <!-- No Context Warning -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa-solid fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        Please select an opportunity from the labs context to view analysis.
                    </p>
                </div>
            </div>
        </div>
    {% else %}

    <!-- Loading Indicator with Step Progress -->
    <div class="mb-6 p-6 bg-blue-50 border border-blue-200 rounded-lg" x-show="loading" x-cloak>
        <div class="flex items-start gap-4">
            <i class="fa-solid fa-spinner fa-spin text-blue-600 text-2xl mt-1"></i>
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-blue-900 mb-2">Loading CHC Nutrition Analysis</h3>
                <div class="space-y-1 text-sm">
                    <!-- Step 1: Checking cache -->
                    <div class="flex items-center gap-2" :class="loadingStep >= 1 ? 'text-blue-800' : 'text-gray-400'">
                        <i class="fa-solid" :class="{
                            'fa-check text-green-600': loadingStep > 1,
                            'fa-spinner fa-spin text-blue-600': loadingStep === 1,
                            'fa-circle text-gray-300': loadingStep < 1
                        }"></i>
                        <span>Checking cache...</span>
                    </div>
                    <!-- Step 2: Fetching data -->
                    <div class="flex items-center gap-2" :class="loadingStep >= 2 ? 'text-blue-800' : 'text-gray-400'">
                        <i class="fa-solid" :class="{
                            'fa-check text-green-600': loadingStep > 2,
                            'fa-spinner fa-spin text-blue-600': loadingStep === 2,
                            'fa-circle text-gray-300': loadingStep < 2
                        }"></i>
                        <span x-text="downloadProgress || 'Fetching data from Connect API...'"></span>
                    </div>
                    <!-- Step 3: Processing -->
                    <div class="flex items-center gap-2" :class="loadingStep >= 3 ? 'text-blue-800' : 'text-gray-400'">
                        <i class="fa-solid" :class="{
                            'fa-check text-green-600': loadingStep > 3,
                            'fa-spinner fa-spin text-blue-600': loadingStep === 3,
                            'fa-circle text-gray-300': loadingStep < 3
                        }"></i>
                        <span x-text="processingMessage || 'Processing visits...'"></span>
                    </div>
                    <!-- Step 4: Complete -->
                    <div class="flex items-center gap-2" :class="loadingStep >= 4 ? 'text-blue-800' : 'text-gray-400'">
                        <i class="fa-solid" :class="{
                            'fa-check text-green-600': loadingStep >= 4,
                            'fa-circle text-gray-300': loadingStep < 4
                        }"></i>
                        <span>Complete!</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg" x-show="loadError" x-cloak>
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fa-solid fa-circle-exclamation text-red-600 mr-3"></i>
                <div>
                    <strong class="text-red-800">Error:</strong>
                    <span class="ml-2 text-red-700" x-text="loadError"></span>
                </div>
            </div>
            <button @click="loadData()"
                    class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-sm font-medium">
                <i class="fa-solid fa-rotate mr-1"></i>Retry
            </button>
        </div>
    </div>

    <!-- Main Content (shown after loading) -->
    <div x-show="!loading && !loadError" x-cloak>

        <!-- Summary Statistics -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-6" x-show="nutritionSummary">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
                <!-- General Stats -->
                <div class="border-l-4 border-blue-500 pl-3">
                    <div class="text-sm text-gray-600">Total FLWs</div>
                    <div class="text-2xl font-bold text-gray-900" x-text="summary.total_flws || 0"></div>
                </div>
                <div class="border-l-4 border-blue-500 pl-3">
                    <div class="text-sm text-gray-600">Total Visits</div>
                    <div class="text-2xl font-bold text-gray-900" x-text="summary.total_visits || 0"></div>
                </div>
                <div class="border-l-4 border-blue-500 pl-3">
                    <div class="text-sm text-gray-600">Avg Visits/FLW</div>
                    <div class="text-2xl font-bold text-gray-900" x-text="summary.avg_visits_per_flw || 0"></div>
                </div>
                <div class="border-l-4 border-blue-500 pl-3">
                    <div class="text-sm text-gray-600">Total Approved</div>
                    <div class="text-2xl font-bold text-gray-900" x-text="summary.total_approved || 0"></div>
                </div>

                <!-- Nutrition Metrics -->
                <div class="border-l-4 border-red-600 pl-3" title="Severe Acute Malnutrition (MUAC < 11.5 cm)">
                    <div class="text-sm text-gray-600">SAM Rate</div>
                    <div class="text-2xl font-bold text-red-600">
                        <span x-text="nutritionSummary.sam_rate || 0"></span>%
                        <span class="text-base text-gray-500">(<span x-text="nutritionSummary.total_sam || 0"></span>)</span>
                    </div>
                </div>
                <div class="border-l-4 border-yellow-500 pl-3" title="Moderate Acute Malnutrition (MUAC 11.5-12.5 cm)">
                    <div class="text-sm text-gray-600">MAM Rate</div>
                    <div class="text-2xl font-bold text-yellow-600">
                        <span x-text="nutritionSummary.mam_rate || 0"></span>%
                        <span class="text-base text-gray-500">(<span x-text="nutritionSummary.total_mam || 0"></span>)</span>
                    </div>
                </div>
                <div class="border-l-4 border-orange-500 pl-3">
                    <div class="text-sm text-gray-600">Children Unwell</div>
                    <div class="text-2xl font-bold text-gray-900" x-text="nutritionSummary.total_children_unwell || 0"></div>
                </div>
                <div class="border-l-4 border-purple-500 pl-3">
                    <div class="text-sm text-gray-600">Under Treatment</div>
                    <div class="text-2xl font-bold text-gray-900" x-text="nutritionSummary.total_under_treatment || 0"></div>
                </div>
            </div>
        </div>

        <!-- FLW Analysis Table -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                <h2 class="text-xl font-semibold text-gray-900">
                    FLW-Level Analysis
                    <span class="text-sm text-gray-600 font-normal">(<span x-text="flws.length"></span> FLWs)</span>
                </h2>
                <div x-show="selectedFlws.length > 0" x-cloak class="flex items-center gap-3">
                    <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-md text-sm font-medium">
                        <span x-text="selectedFlws.length"></span> selected
                    </span>
                    <button @click="selectedFlws = []" class="text-sm text-gray-500 hover:text-gray-700">
                        Clear selection
                    </button>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-10">
                                <input type="checkbox"
                                       :checked="allSelected"
                                       :indeterminate="someSelected"
                                       @click="toggleSelectAll()"
                                       class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer"
                                       title="Select all FLWs">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FLW Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Visits</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Approved</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Days Active</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MUAC Count</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Avg MUAC (cm)</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Severe Acute Malnutrition (MUAC < 11.5 cm)">SAM</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Moderate Acute Malnutrition (MUAC 11.5-12.5 cm)">MAM</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">MUAC Distribution</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Female % of (Male + Female)">Gender Split</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="flw in flws" :key="flw.username">
                            <tr class="hover:bg-gray-50" :class="{'bg-blue-50': isFlwSelected(flw.username)}">
                                <td class="px-4 py-3 text-center">
                                    <input type="checkbox"
                                           :checked="isFlwSelected(flw.username)"
                                           @click="toggleFlwSelection(flw.username)"
                                           class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 cursor-pointer">
                                </td>
                                <td class="px-4 py-3 text-sm">
                                    <div class="font-medium text-gray-900" x-text="flw.display_name"></div>
                                    <template x-if="flw.display_name !== flw.username">
                                        <div class="text-xs text-gray-500" x-text="flw.username"></div>
                                    </template>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="flw.total_visits"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                    <span x-text="flw.approval_rate"></span>% <span class="text-gray-500">(<span x-text="flw.approved_visits"></span>)</span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="flw.days_active"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="flw.custom_fields.muac_measurements_count || 0"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                    <template x-if="flw.custom_fields.avg_muac_cm">
                                        <span x-text="flw.custom_fields.avg_muac_cm.toFixed(1)"></span>
                                    </template>
                                    <template x-if="!flw.custom_fields.avg_muac_cm">
                                        <span class="text-gray-400">-</span>
                                    </template>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <template x-if="(flw.custom_fields.muac_measurements_count || 0) > 0">
                                        <span>
                                            <span class="text-red-600 font-medium" x-text="Math.round((flw.custom_fields.sam_count || 0) / flw.custom_fields.muac_measurements_count * 100) + '%'"></span>
                                            <span class="text-gray-500">(<span x-text="flw.custom_fields.sam_count || 0"></span>)</span>
                                        </span>
                                    </template>
                                    <template x-if="!(flw.custom_fields.muac_measurements_count || 0)">
                                        <span class="text-gray-400">-</span>
                                    </template>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <template x-if="(flw.custom_fields.muac_measurements_count || 0) > 0">
                                        <span>
                                            <span class="text-yellow-600 font-medium" x-text="Math.round((flw.custom_fields.mam_count || 0) / flw.custom_fields.muac_measurements_count * 100) + '%'"></span>
                                            <span class="text-gray-500">(<span x-text="flw.custom_fields.mam_count || 0"></span>)</span>
                                        </span>
                                    </template>
                                    <template x-if="!(flw.custom_fields.muac_measurements_count || 0)">
                                        <span class="text-gray-400">-</span>
                                    </template>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <!-- MUAC Distribution Sparkline -->
                                    <template x-if="flw.custom_fields.muac_distribution_count">
                                        <div class="inline-flex items-end gap-0.5 overflow-hidden cursor-help" style="height: 32px;"
                                             :title="'MUAC: ' + (flw.custom_fields.muac_distribution_mean || 0).toFixed(1) + ' cm avg (n=' + flw.custom_fields.muac_distribution_count + ')'"
                                             x-data="{ maxBin: Math.max(
                                                 flw.custom_fields.muac_9_5_10_5_visits || 0,
                                                 flw.custom_fields.muac_10_5_11_5_visits || 0,
                                                 flw.custom_fields.muac_11_5_12_5_visits || 0,
                                                 flw.custom_fields.muac_12_5_13_5_visits || 0,
                                                 flw.custom_fields.muac_13_5_14_5_visits || 0,
                                                 flw.custom_fields.muac_14_5_15_5_visits || 0,
                                                 flw.custom_fields.muac_15_5_16_5_visits || 0,
                                                 flw.custom_fields.muac_16_5_17_5_visits || 0,
                                                 flw.custom_fields.muac_17_5_18_5_visits || 0,
                                                 flw.custom_fields.muac_18_5_19_5_visits || 0,
                                                 flw.custom_fields.muac_19_5_20_5_visits || 0,
                                                 flw.custom_fields.muac_20_5_21_5_visits || 0,
                                                 1
                                             ) }">
                                            <span class="w-1 rounded-sm" :style="'background-color: #ef4444; height: ' + ((flw.custom_fields.muac_9_5_10_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                            <span class="w-1 rounded-sm" :style="'background-color: #ef4444; height: ' + ((flw.custom_fields.muac_10_5_11_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                            <span class="w-1 rounded-sm" :style="'background-color: #facc15; height: ' + ((flw.custom_fields.muac_11_5_12_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                            <span class="w-1 rounded-sm" :style="'background-color: #22c55e; height: ' + ((flw.custom_fields.muac_12_5_13_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                            <span class="w-1 rounded-sm" :style="'background-color: #22c55e; height: ' + ((flw.custom_fields.muac_13_5_14_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                            <span class="w-1 rounded-sm" :style="'background-color: #22c55e; height: ' + ((flw.custom_fields.muac_14_5_15_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                            <span class="w-1 rounded-sm" :style="'background-color: #22c55e; height: ' + ((flw.custom_fields.muac_15_5_16_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                            <span class="w-1 rounded-sm" :style="'background-color: #22c55e; height: ' + ((flw.custom_fields.muac_16_5_17_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                            <span class="w-1 rounded-sm" :style="'background-color: #22c55e; height: ' + ((flw.custom_fields.muac_17_5_18_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                            <span class="w-1 rounded-sm" :style="'background-color: #22c55e; height: ' + ((flw.custom_fields.muac_18_5_19_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                            <span class="w-1 rounded-sm" :style="'background-color: #22c55e; height: ' + ((flw.custom_fields.muac_19_5_20_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                            <span class="w-1 rounded-sm" :style="'background-color: #22c55e; height: ' + ((flw.custom_fields.muac_20_5_21_5_visits || 0) / maxBin * 32) + 'px'"></span>
                                        </div>
                                    </template>
                                    <template x-if="!flw.custom_fields.muac_distribution_count">
                                        <span class="text-gray-400">-</span>
                                    </template>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                    <template x-if="flw.gender_split_female_pct !== null">
                                        <span>
                                            <span :class="{
                                                'text-green-600': flw.gender_split_female_pct >= 45 && flw.gender_split_female_pct <= 55,
                                                'text-red-600': flw.gender_split_female_pct < 40 || flw.gender_split_female_pct > 60,
                                                'text-yellow-600': (flw.gender_split_female_pct >= 40 && flw.gender_split_female_pct < 45) || (flw.gender_split_female_pct > 55 && flw.gender_split_female_pct <= 60)
                                            }" class="font-medium" x-text="flw.gender_split_female_pct + '%'"></span>
                                            <span class="text-gray-500 text-xs ml-1">(<span x-text="flw.female_count"></span>F/<span x-text="flw.male_count"></span>M)</span>
                                        </span>
                                    </template>
                                    <template x-if="flw.gender_split_female_pct === null">
                                        <span class="text-gray-400">-</span>
                                    </template>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <a :href="getAuditUrl(flw.username)"
                                       class="inline-flex items-center px-3 py-1 border border-blue-300 rounded-md text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 hover:border-blue-400 transition-colors"
                                       :title="selectedFlws.length > 0 ? 'Create audit for ' + selectedFlws.length + ' selected FLWs' : 'Create audit for ' + flw.display_name">
                                        <i class="fa-solid fa-clipboard-check mr-1"></i>
                                        <span x-text="selectedFlws.length > 1 ? 'Audit (' + selectedFlws.length + ')' : 'Audit'"></span>
                                    </a>
                                </td>
                            </tr>
                        </template>
                        <template x-if="flws.length === 0">
                            <tr>
                                <td colspan="12" class="px-4 py-8 text-center text-sm text-gray-500">
                                    No data available
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <!-- Show All Fields Toggle -->
            <div class="px-6 py-4 border-t border-gray-200 bg-gray-50">
                <button
                    @click="showAllFields = !showAllFields"
                    class="button button-sm outline-style">
                    <i class="fa-solid mr-1" :class="{'fa-eye': !showAllFields, 'fa-eye-slash': showAllFields}"></i>
                    <span x-text="showAllFields ? 'Hide All Fields' : 'Show All Fields'"></span>
                </button>

                <!-- Expanded All Fields Table -->
                <div x-show="showAllFields" x-transition class="mt-4 overflow-x-auto">
                    <div class="text-sm text-gray-600 mb-2">Complete field list for all FLWs</div>
                    <table class="min-w-full divide-y divide-gray-200 border border-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">FLW Name</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Child Age</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Gender</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">MUAC Colors</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Under Treatment</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">VA Shared</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">ORS Recovered</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Vaccines</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Have Glasses</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <template x-for="flw in flws" :key="flw.username + '_expanded'">
                                <tr class="hover:bg-gray-50">
                                    <td class="px-3 py-2 text-sm">
                                        <div class="font-medium text-gray-900" x-text="flw.display_name"></div>
                                        <template x-if="flw.display_name !== flw.username">
                                            <div class="text-xs text-gray-500" x-text="flw.username"></div>
                                        </template>
                                    </td>
                                    <td class="px-3 py-2 text-sm text-gray-700" x-text="flw.custom_fields.child_age_months || '-'"></td>
                                    <td class="px-3 py-2 text-sm text-gray-700" x-text="flw.custom_fields.child_gender || '-'"></td>
                                    <td class="px-3 py-2 text-sm text-gray-700">
                                        <template x-if="flw.custom_fields.muac_colors_observed && flw.custom_fields.muac_colors_observed.length">
                                            <span class="px-2 py-1 bg-gray-100 rounded text-xs" x-text="flw.custom_fields.muac_colors_observed.join(', ')"></span>
                                        </template>
                                        <template x-if="!flw.custom_fields.muac_colors_observed || !flw.custom_fields.muac_colors_observed.length">
                                            <span class="text-gray-400">-</span>
                                        </template>
                                    </td>
                                    <td class="px-3 py-2 text-sm text-gray-700" x-text="flw.custom_fields.under_malnutrition_treatment_count || 0"></td>
                                    <td class="px-3 py-2 text-sm text-gray-700" x-text="flw.custom_fields.va_confirm_shared_knowledge_count || 0"></td>
                                    <td class="px-3 py-2 text-sm text-gray-700" x-text="flw.custom_fields.ors_child_recovered_count || 0"></td>
                                    <td class="px-3 py-2 text-sm text-gray-700" x-text="flw.custom_fields.received_any_vaccine_count || 0"></td>
                                    <td class="px-3 py-2 text-sm text-gray-700" x-text="flw.custom_fields.have_glasses_count || 0"></td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </div>

    {% endif %}
</div>
{% endblock %}

{% block inline_javascript %}
{{ block.super }}
<script>
function chcNutritionAnalysis() {
    return {
        // Loading state
        loading: true,
        loadingStep: 0,
        loadError: null,
        receivedEvents: false,
        downloadProgress: '',
        processingMessage: '',

        // UI state
        showAllFields: false,

        // FLW selection state
        selectedFlws: [],

        // Data
        flws: [],
        summary: {},
        nutritionSummary: {},
        opportunityId: {{ opportunity_id|default:"null" }},
        opportunityName: '{{ opportunity_name|default:"" }}',
        fromCache: false,

        // URLs
        dataApiUrl: '{{ data_api_url|default:"" }}',
        streamApiUrl: '{{ stream_api_url|default:"" }}',
        auditUrl: '{% url "audit:creation_wizard" %}',

        // EventSource reference
        eventSource: null,

        // Initialize
        init() {
            if (this.streamApiUrl) {
                this.loadDataWithSSE();
            } else if (this.dataApiUrl) {
                this.loadData();
            }
        },

        // Refresh data (force cache bypass)
        refreshData() {
            // Add refresh=1 to URL and reload
            const url = new URL(window.location.href);
            url.searchParams.set('refresh', '1');
            window.location.href = url.toString();
        },

        // Determine loading step from server message
        updateStepFromMessage(message) {
            const msg = message.toLowerCase();
            if (msg.includes('checking cache') || msg.includes('cache hit') || msg.includes('cached data')) {
                this.loadingStep = 1;
            } else if (msg.includes('connecting') || msg.includes('downloading') || msg.includes('download complete')) {
                this.loadingStep = 2;
                if (msg.includes('downloading')) {
                    this.downloadProgress = message;
                }
            } else if (msg.includes('processing')) {
                this.loadingStep = 3;
                this.processingMessage = message;
            } else if (msg.includes('complete')) {
                this.loadingStep = 4;
            }
        },

        // Load data using Server-Sent Events for real-time progress
        loadDataWithSSE() {
            this.loading = true;
            this.loadingStep = 0;
            this.loadError = null;
            this.receivedEvents = false;
            this.downloadProgress = '';
            this.processingMessage = '';

            // Close any existing connection
            if (this.eventSource) {
                this.eventSource.close();
            }

            // Build URL with query params
            const url = this.streamApiUrl + window.location.search;
            console.log('[CHC Nutrition] Starting SSE connection:', url);

            this.eventSource = new EventSource(url);

            this.eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('[CHC Nutrition] SSE event:', data);
                    this.receivedEvents = true;

                    // Update step based on message content
                    this.updateStepFromMessage(data.message);

                    // Check for error
                    if (data.error) {
                        this.loadError = data.error;
                        this.loading = false;
                        this.eventSource.close();
                        return;
                    }

                    // Check for completion
                    if (data.complete && data.data) {
                        const responseData = data.data;

                        // Populate data
                        this.flws = responseData.flws || [];
                        this.summary = responseData.summary || {};
                        this.nutritionSummary = responseData.nutrition_summary || {};
                        this.opportunityId = responseData.opportunity_id;
                        this.opportunityName = responseData.opportunity_name || '';
                        this.fromCache = responseData.from_cache;

                        this.loadingStep = 4;
                        this.loading = false;
                        this.eventSource.close();
                        console.log(`[CHC Nutrition] Loaded ${this.flws.length} FLWs via SSE`);
                    }
                } catch (e) {
                    console.error('[CHC Nutrition] Error parsing SSE event:', e);
                }
            };

            this.eventSource.onerror = (error) => {
                console.error('[CHC Nutrition] SSE error:', error);
                this.eventSource.close();

                // If we haven't received any events, fall back to regular fetch
                if (!this.receivedEvents) {
                    console.log('[CHC Nutrition] Falling back to regular fetch');
                    this.loadData();
                } else {
                    this.loadError = 'Connection lost. Please try again.';
                    this.loading = false;
                }
            };
        },

        // Fallback: Load data asynchronously with fetch (no real-time progress)
        async loadData() {
            this.loading = true;
            this.loadingStep = 1;
            this.loadError = null;

            try {
                console.log('[CHC Nutrition] Starting API fetch (fallback)');
                this.loadingStep = 2;
                const response = await fetch(this.dataApiUrl + window.location.search);

                if (!response.ok) {
                    // Check if response is JSON before trying to parse
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to load analysis data');
                    } else {
                        // Server returned HTML error page (502, 500, etc.)
                        throw new Error(`Server error (${response.status}): The Connect API may be temporarily unavailable. Please try again.`);
                    }
                }

                this.loadingStep = 3;
                const data = await response.json();

                // Populate data
                this.flws = data.flws || [];
                this.summary = data.summary || {};
                this.nutritionSummary = data.nutrition_summary || {};
                this.opportunityId = data.opportunity_id;
                this.opportunityName = data.opportunity_name || '';
                this.fromCache = data.from_cache;

                this.loadingStep = 4;
                this.loading = false;
                console.log(`[CHC Nutrition] Loaded ${this.flws.length} FLWs (fallback)`);

            } catch (error) {
                console.error('Failed to load analysis data:', error);
                this.loadError = error.message || 'Failed to load analysis data. Please try again.';
                this.loading = false;
            }
        },

        // Check if all FLWs are selected
        get allSelected() {
            return this.flws.length > 0 && this.selectedFlws.length === this.flws.length;
        },

        // Check if some (but not all) FLWs are selected
        get someSelected() {
            return this.selectedFlws.length > 0 && this.selectedFlws.length < this.flws.length;
        },

        // Toggle select all FLWs
        toggleSelectAll() {
            if (this.allSelected) {
                this.selectedFlws = [];
            } else {
                this.selectedFlws = this.flws.map(flw => flw.username);
            }
        },

        // Toggle individual FLW selection
        toggleFlwSelection(username) {
            const index = this.selectedFlws.indexOf(username);
            if (index > -1) {
                this.selectedFlws.splice(index, 1);
            } else {
                this.selectedFlws.push(username);
            }
        },

        // Check if a specific FLW is selected
        isFlwSelected(username) {
            return this.selectedFlws.includes(username);
        },

        // Build audit URL with selected FLWs
        getAuditUrl(flwUsername) {
            const baseUrl = this.auditUrl + '?opportunity_id=' + this.opportunityId + '&granularity=per_flw';
            // If there are selected FLWs, use those; otherwise use the clicked FLW
            if (this.selectedFlws.length > 0) {
                return baseUrl + '&usernames=' + encodeURIComponent(this.selectedFlws.join(','));
            } else {
                return baseUrl + '&usernames=' + encodeURIComponent(flwUsername);
            }
        }
    };
}
</script>
{% endblock %}
