{% extends "base.html" %}
{% load static %}

{% block title %}MBW GPS Analysis{% endblock %}

{% block content %}
<div class="container mx-auto p-6" x-data="mbwGPSAnalysis()">
    <!-- Header -->
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900">MBW GPS Analysis</h1>
            <p class="text-gray-600 mt-1">GPS distance metrics and travel analysis</p>
        </div>
        <div class="flex items-center gap-3" x-show="!loading && !loadError" x-cloak>
            <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-md text-sm font-medium" x-text="opportunityName"></span>
            <button @click="refreshData()" class="button button-sm outline-style">
                <i class="fa-solid fa-arrows-rotate mr-1"></i>
                Refresh
            </button>
        </div>
    </div>

    {% if error %}
        <!-- Error Alert -->
        <div class="bg-red-50 border-l-4 border-red-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa-solid fa-exclamation-circle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-red-700">
                        <strong>Error:</strong> {{ error }}
                    </p>
                </div>
            </div>
        </div>
    {% elif not has_context %}
        <!-- No Context Warning -->
        <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6">
            <div class="flex">
                <div class="flex-shrink-0">
                    <i class="fa-solid fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                    <p class="text-sm text-yellow-700">
                        Please select an opportunity from the labs context to view analysis.
                    </p>
                </div>
            </div>
        </div>
    {% else %}

    <!-- Date Range Filter -->
    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm mb-6">
        <div class="flex flex-wrap items-end gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                <input type="date"
                       x-model="startDate"
                       class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                <input type="date"
                       x-model="endDate"
                       class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-blue-500 focus:border-blue-500">
            </div>
            <button @click="applyDateFilter()"
                    class="button primary-style"
                    :disabled="loading">
                <i class="fa-solid fa-filter mr-1"></i>
                Apply Filter
            </button>
            <button @click="resetDateFilter()"
                    class="button outline-style"
                    :disabled="loading">
                Reset to Last 30 Days
            </button>
        </div>
        <p class="text-xs text-gray-500 mt-2">
            Showing visits from <span x-text="startDate"></span> to <span x-text="endDate"></span>
        </p>
    </div>

    <!-- Loading Indicator -->
    <div class="mb-6 p-6 bg-blue-50 border border-blue-200 rounded-lg" x-show="loading" x-cloak>
        <div class="flex items-start gap-4">
            <i class="fa-solid fa-spinner fa-spin text-blue-600 text-2xl mt-1"></i>
            <div class="flex-1">
                <h3 class="text-lg font-semibold text-blue-900 mb-2">Analyzing GPS Data</h3>
                <p class="text-sm text-blue-700" x-text="loadingMessage || 'Loading...'"></p>
            </div>
        </div>
    </div>

    <!-- Error Display -->
    <div class="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg" x-show="loadError" x-cloak>
        <div class="flex items-center justify-between">
            <div class="flex items-center">
                <i class="fa-solid fa-circle-exclamation text-red-600 mr-3"></i>
                <div>
                    <strong class="text-red-800">Error:</strong>
                    <span class="ml-2 text-red-700" x-text="loadError"></span>
                </div>
            </div>
            <button @click="loadData()"
                    class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-sm font-medium">
                <i class="fa-solid fa-rotate mr-1"></i>Retry
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div x-show="!loading && !loadError" x-cloak>

        <!-- Summary Statistics -->
        <div class="bg-white border border-gray-200 rounded-lg p-6 shadow-sm mb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4">Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-4">
                <div class="border-l-4 border-blue-500 pl-3">
                    <div class="text-sm text-gray-600">Total Visits</div>
                    <div class="text-2xl font-bold text-gray-900" x-text="summary.total_visits || 0"></div>
                </div>
                <div class="border-l-4 border-blue-500 pl-3">
                    <div class="text-sm text-gray-600">Total FLWs</div>
                    <div class="text-2xl font-bold text-gray-900" x-text="flwSummaries.length"></div>
                </div>
                <div class="border-l-4 border-red-500 pl-3" title="Visits with suspicious GPS distances">
                    <div class="text-sm text-gray-600">Flagged Visits</div>
                    <div class="text-2xl font-bold" :class="summary.total_flagged > 0 ? 'text-red-600' : 'text-gray-900'" x-text="summary.total_flagged || 0"></div>
                </div>
                <div class="border-l-4 border-green-500 pl-3">
                    <div class="text-sm text-gray-600">Date Range</div>
                    <div class="text-sm font-medium text-gray-900">
                        <span x-text="summary.date_range_start || '-'"></span> to <span x-text="summary.date_range_end || '-'"></span>
                    </div>
                </div>
                <div class="border-l-4 border-purple-500 pl-3">
                    <div class="text-sm text-gray-600">Flag Threshold</div>
                    <div class="text-lg font-bold text-gray-900">5 km</div>
                </div>
            </div>
        </div>

        <!-- FLW Analysis Table -->
        <div class="bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50">
                <h2 class="text-xl font-semibold text-gray-900">
                    FLW GPS Analysis
                    <span class="text-sm text-gray-600 font-normal">(<span x-text="flwSummaries.length"></span> FLWs)</span>
                </h2>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FLW Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Visits</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">With GPS</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Visits where distance from previous case visit exceeds threshold">Flagged</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Unique Cases</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Average distance between sequential visits to the same case">Avg Case Dist</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Maximum distance between sequential visits to the same case">Max Case Dist</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider" title="Daily travel distance for last 7 days of date range">Trailing 7 Days</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="flw in flwSummaries" :key="flw.username">
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 text-sm">
                                    <div class="font-medium text-gray-900" x-text="flw.display_name"></div>
                                    <template x-if="flw.display_name !== flw.username">
                                        <div class="text-xs text-gray-500" x-text="flw.username"></div>
                                    </template>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="flw.total_visits"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                    <span x-text="flw.visits_with_gps"></span>
                                    <span class="text-gray-500" x-text="'(' + Math.round(flw.visits_with_gps / flw.total_visits * 100) + '%)'"></span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <span :class="flw.flagged_visits > 0 ? 'text-red-600 font-bold' : 'text-gray-900'" x-text="flw.flagged_visits"></span>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900" x-text="flw.unique_cases"></td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">
                                    <template x-if="flw.avg_case_distance_km !== null">
                                        <span x-text="flw.avg_case_distance_km + ' km'"></span>
                                    </template>
                                    <template x-if="flw.avg_case_distance_km === null">
                                        <span class="text-gray-400">-</span>
                                    </template>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <template x-if="flw.max_case_distance_km !== null">
                                        <span :class="flw.max_case_distance_km > 5 ? 'text-red-600 font-bold' : 'text-gray-900'" x-text="flw.max_case_distance_km + ' km'"></span>
                                    </template>
                                    <template x-if="flw.max_case_distance_km === null">
                                        <span class="text-gray-400">-</span>
                                    </template>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <!-- Trailing 7 Days Sparkline -->
                                    <template x-if="flw.trailing_7_days && flw.trailing_7_days.length > 0">
                                        <div class="flex items-center gap-2">
                                            <div class="inline-flex items-end gap-0.5" style="height: 24px;"
                                                 :title="'Last 7 days: ' + flw.trailing_7_days.map(d => d.distance_km + ' km').join(', ')">
                                                <template x-for="(day, idx) in flw.trailing_7_days" :key="idx">
                                                    <span class="w-2 rounded-sm bg-blue-500"
                                                          :style="'height: ' + Math.max(2, Math.min(24, (day.distance_km / getMaxDailyTravel(flw)) * 24)) + 'px'"
                                                          :title="day.date + ': ' + day.distance_km + ' km'"></span>
                                                </template>
                                            </div>
                                            <span class="text-xs text-gray-500">
                                                Avg: <span x-text="flw.avg_daily_travel_km || '-'"></span> km/day
                                            </span>
                                        </div>
                                    </template>
                                    <template x-if="!flw.trailing_7_days || flw.trailing_7_days.length === 0">
                                        <span class="text-gray-400">-</span>
                                    </template>
                                </td>
                                <td class="px-4 py-3 whitespace-nowrap text-sm">
                                    <button @click="toggleDrillDown(flw.username)"
                                            class="inline-flex items-center px-3 py-1 border border-blue-300 rounded-md text-xs font-medium text-blue-700 bg-blue-50 hover:bg-blue-100 hover:border-blue-400 transition-colors">
                                        <i class="fa-solid mr-1" :class="expandedFlw === flw.username ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                                        <span x-text="expandedFlw === flw.username ? 'Hide' : 'Details'"></span>
                                    </button>
                                </td>
                            </tr>
                        </template>
                        <template x-if="flwSummaries.length === 0">
                            <tr>
                                <td colspan="9" class="px-4 py-8 text-center text-sm text-gray-500">
                                    No data available for the selected date range
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Drill-Down Panel (shown when an FLW is expanded) -->
        <div id="visit-details-panel" x-show="expandedFlw" x-cloak class="mt-4 bg-white border border-gray-200 rounded-lg shadow-sm overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900">
                    Visit Details for <span x-text="expandedFlwName"></span>
                </h3>
                <button @click="expandedFlw = null" class="text-gray-500 hover:text-gray-700">
                    <i class="fa-solid fa-times"></i>
                </button>
            </div>

            <!-- Loading indicator for drill-down -->
            <div x-show="drillDownLoading" class="p-6 text-center">
                <i class="fa-solid fa-spinner fa-spin text-blue-600 mr-2"></i>
                Loading visit details...
            </div>

            <!-- Drill-down visits table -->
            <div x-show="!drillDownLoading && drillDownVisits.length > 0" class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Form</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Entity</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">GPS</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Dist from Prev</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        <template x-for="visit in drillDownVisits" :key="visit.visit_id">
                            <tr :class="visit.is_flagged ? 'bg-red-50' : 'hover:bg-gray-50'">
                                <td class="px-4 py-2 text-sm text-gray-900" x-text="visit.visit_date || '-'"></td>
                                <td class="px-4 py-2 text-sm text-gray-900" x-text="visit.form_name || '-'"></td>
                                <td class="px-4 py-2 text-sm text-gray-900" x-text="visit.entity_name || '-'"></td>
                                <td class="px-4 py-2 text-sm text-gray-500">
                                    <template x-if="visit.gps">
                                        <span x-text="visit.gps.latitude.toFixed(4) + ', ' + visit.gps.longitude.toFixed(4)"></span>
                                    </template>
                                    <template x-if="!visit.gps">
                                        <span class="text-gray-400">No GPS</span>
                                    </template>
                                </td>
                                <td class="px-4 py-2 text-sm">
                                    <template x-if="visit.distance_from_prev_km !== null">
                                        <span :class="visit.distance_from_prev_km > 5 ? 'text-red-600 font-bold' : 'text-gray-900'"
                                              x-text="visit.distance_from_prev_km + ' km'"></span>
                                    </template>
                                    <template x-if="visit.distance_from_prev_km === null">
                                        <span class="text-gray-400">-</span>
                                    </template>
                                </td>
                                <td class="px-4 py-2 text-sm">
                                    <template x-if="visit.is_flagged">
                                        <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
                                            <i class="fa-solid fa-flag mr-1"></i> Flagged
                                        </span>
                                    </template>
                                    <template x-if="!visit.is_flagged">
                                        <span class="text-green-600"><i class="fa-solid fa-check"></i></span>
                                    </template>
                                </td>
                            </tr>
                        </template>
                    </tbody>
                </table>
            </div>

            <div x-show="!drillDownLoading && drillDownVisits.length === 0" class="p-6 text-center text-gray-500">
                No visits found for this FLW in the selected date range.
            </div>
        </div>

    </div>

    {% endif %}
</div>
{% endblock %}

{% block inline_javascript %}
{{ block.super }}
<script>
function mbwGPSAnalysis() {
    return {
        // Loading state
        loading: true,
        loadingMessage: '',
        loadError: null,

        // Date range
        startDate: '{{ start_date }}',
        endDate: '{{ end_date }}',

        // Data
        flwSummaries: [],
        summary: {},
        opportunityId: {{ opportunity_id|default:"null" }},
        opportunityName: '{{ opportunity_name|default:"" }}',

        // Drill-down state
        expandedFlw: null,
        expandedFlwName: '',
        drillDownLoading: false,
        drillDownVisits: [],

        // URLs
        streamApiUrl: '{{ stream_api_url|default:"" }}',
        dataApiUrl: '{{ data_api_url|default:"" }}',

        // EventSource reference
        eventSource: null,

        // Initialize
        init() {
            if (this.streamApiUrl) {
                this.loadDataWithSSE();
            }
        },

        // Apply date filter
        applyDateFilter() {
            const url = new URL(window.location.href);
            url.searchParams.set('start_date', this.startDate);
            url.searchParams.set('end_date', this.endDate);
            window.location.href = url.toString();
        },

        // Reset date filter to last 30 days
        resetDateFilter() {
            const end = new Date();
            const start = new Date();
            start.setDate(start.getDate() - 30);

            const url = new URL(window.location.href);
            url.searchParams.set('start_date', start.toISOString().split('T')[0]);
            url.searchParams.set('end_date', end.toISOString().split('T')[0]);
            window.location.href = url.toString();
        },

        // Refresh data
        refreshData() {
            const url = new URL(window.location.href);
            url.searchParams.set('refresh', '1');
            window.location.href = url.toString();
        },

        // Get max daily travel for sparkline scaling
        getMaxDailyTravel(flw) {
            if (!flw.trailing_7_days || flw.trailing_7_days.length === 0) return 1;
            return Math.max(...flw.trailing_7_days.map(d => d.distance_km), 1);
        },

        // Toggle drill-down for an FLW
        async toggleDrillDown(username) {
            if (this.expandedFlw === username) {
                this.expandedFlw = null;
                this.drillDownVisits = [];
                return;
            }

            this.expandedFlw = username;
            this.expandedFlwName = this.flwSummaries.find(f => f.username === username)?.display_name || username;
            this.drillDownLoading = true;
            this.drillDownVisits = [];

            try {
                const url = this.dataApiUrl + '?username=' + encodeURIComponent(username) +
                           '&start_date=' + this.startDate +
                           '&end_date=' + this.endDate +
                           '&include_visits=1';
                const response = await fetch(url);

                if (response.status === 401) {
                    // Session expired - prompt user to refresh
                    alert('Your session has expired. Please refresh the page to re-authenticate.');
                    this.expandedFlw = null;
                    return;
                }

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || 'Failed to load visit details');
                }

                const data = await response.json();
                this.drillDownVisits = data.visits || [];

                // Scroll to the details panel after data loads
                this.$nextTick(() => {
                    const panel = document.getElementById('visit-details-panel');
                    if (panel) {
                        panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            } catch (error) {
                console.error('Failed to load drill-down:', error);
                this.drillDownVisits = [];
            } finally {
                this.drillDownLoading = false;
            }
        },

        // Load data using Server-Sent Events
        loadDataWithSSE() {
            this.loading = true;
            this.loadError = null;
            this.loadingMessage = 'Connecting...';

            if (this.eventSource) {
                this.eventSource.close();
            }

            const params = new URLSearchParams({
                start_date: this.startDate,
                end_date: this.endDate
            });
            const url = this.streamApiUrl + '?' + params.toString();
            console.log('[MBW GPS] Starting SSE connection:', url);

            this.eventSource = new EventSource(url);

            this.eventSource.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    console.log('[MBW GPS] SSE event:', data);

                    this.loadingMessage = data.message;

                    if (data.error) {
                        this.loadError = data.error;
                        this.loading = false;
                        this.eventSource.close();
                        return;
                    }

                    if (data.complete && data.data) {
                        const responseData = data.data;

                        this.flwSummaries = responseData.flw_summaries || [];
                        this.summary = {
                            total_visits: responseData.total_visits,
                            total_flagged: responseData.total_flagged,
                            date_range_start: responseData.date_range_start,
                            date_range_end: responseData.date_range_end
                        };
                        this.opportunityId = responseData.opportunity_id;
                        this.opportunityName = responseData.opportunity_name || '';

                        this.loading = false;
                        this.eventSource.close();
                        console.log(`[MBW GPS] Loaded ${this.flwSummaries.length} FLWs`);
                    }
                } catch (e) {
                    console.error('[MBW GPS] Error parsing SSE event:', e);
                }
            };

            this.eventSource.onerror = (error) => {
                console.error('[MBW GPS] SSE error:', error);
                this.eventSource.close();
                this.loadError = 'Connection lost. Please try again.';
                this.loading = false;
            };
        }
    };
}
</script>
{% endblock %}
