{% extends "base.html" %}

{% block content %}
<div class="container mx-auto p-6" x-data="dashboard2Data()">
  <div class="mb-6">
    <h1 class="text-3xl font-bold mb-2">Dashboard Prototype 2: Accordion View</h1>
    <p class="text-gray-600 mb-4">Hierarchical collapsible cards: Program Type → Program → Opportunity → FLWs</p>
    <a href="{% url 'labs:dashboard' %}" class="text-blue-600 hover:underline">← Back to Dashboard</a>
  </div>

  <!-- Filter Controls -->
  <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4 shadow-sm">
    <div class="flex items-center gap-4">
      <label class="font-semibold text-gray-700">Filter Test Opportunities:</label>
      <div class="flex items-center gap-2">
        <span class="text-sm text-gray-600">Min Visits:</span>
        <input
          type="number"
          x-model.number="minVisits"
          @input="applyFilter()"
          class="border border-gray-300 rounded px-3 py-1 w-24"
          min="0"
          placeholder="0"
        />
      </div>
      <div class="text-sm text-gray-600">
        Showing <span x-text="filteredOpportunitiesCount"></span> of <span x-text="totalOpportunitiesCount"></span> opportunities
      </div>
    </div>
  </div>

  <!-- Debug info -->
  <details class="bg-yellow-50 border border-yellow-200 rounded p-4 mb-4">
    <summary class="cursor-pointer font-semibold">Debug Info (click to expand)</summary>
    <p class="mt-2">Programs available: {{ user.programs|length }}</p>
    <p>Opportunities available: {{ user.opportunities|length }}</p>
    <details class="mt-2">
      <summary class="cursor-pointer text-sm text-blue-600">View raw JSON (click to expand)</summary>
      <pre class="text-xs mt-2 p-2 bg-white rounded overflow-auto max-h-40">Programs JSON: {{ programs_json }}</pre>
      <pre class="text-xs mt-2 p-2 bg-white rounded overflow-auto max-h-40">Opportunities JSON: {{ opportunities_json }}</pre>
    </details>
  </details>

  <template x-for="(programType, typeName) in groupedData" :key="typeName">
    <div class="mb-4 border rounded-lg shadow-sm bg-white">
      <div
        @click="toggleProgramType(typeName)"
        class="p-4 cursor-pointer hover:bg-gray-50 flex justify-between items-center"
      >
        <div>
          <h2 class="text-xl font-semibold">
            <span x-text="expandedProgramTypes.includes(typeName) ? '▼' : '▶'"></span>
            <span x-text="typeName || 'No Type Specified'"></span>
          </h2>
          <div class="text-sm text-gray-600 mt-1">
            <span x-text="programType.programs.length"></span> programs,
            <span x-text="programType.totalOpps"></span> opportunities,
            <span x-text="programType.totalVisits"></span> visits
          </div>
        </div>
        <div class="flex gap-2">
          <template x-for="currency in programType.currencies" :key="currency">
            <span class="px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded" x-text="currency"></span>
          </template>
        </div>
      </div>

      <div x-show="expandedProgramTypes.includes(typeName)" class="border-t">
        <template x-for="program in programType.programs" :key="program.id">
          <div class="ml-4 border-l-2 border-indigo-200">
            <div
              @click="toggleProgram(program.id)"
              class="p-3 cursor-pointer hover:bg-gray-50 flex justify-between items-center"
            >
              <div>
                <h3 class="text-lg font-medium">
                  <span x-text="expandedPrograms.includes(program.id) ? '▼' : '▶'"></span>
                  <span x-text="program.name"></span>
                  <span class="text-sm text-gray-500">(ID: <span x-text="program.id"></span>)</span>
                </h3>
                <div class="text-sm text-gray-600 mt-1">
                  <span x-text="program.opportunities.length"></span> opportunities
                  (<span x-text="program.activeOpps"></span> active),
                  <span x-text="program.totalVisits"></span> visits,
                  <span x-text="program.currency"></span>
                </div>
              </div>
              <div>
                <span class="text-xs text-gray-500">Org: <span x-text="program.organization"></span></span>
              </div>
            </div>

            <div x-show="expandedPrograms.includes(program.id)" class="bg-gray-50">
              <template x-for="opp in program.opportunities" :key="opp.id">
                <div class="ml-4 border-l-2 border-green-200">
                  <div
                    @click="toggleOpportunity(opp.id)"
                    class="p-3 cursor-pointer hover:bg-gray-100 flex justify-between items-center"
                  >
                    <div>
                      <h4 class="font-medium">
                        <span x-text="expandedOpportunities.includes(opp.id) ? '▼' : '▶'"></span>
                        <span x-text="opp.name"></span>
                        <span class="text-sm text-gray-500">(ID: <span x-text="opp.id"></span>)</span>
                      </h4>
                      <div class="text-sm text-gray-600 mt-1">
                        Status:
                        <span :class="opp.is_active ? 'text-green-600' : 'text-red-600'" x-text="opp.is_active ? 'Active' : 'Inactive'"></span>,
                        <span x-text="opp.visit_count"></span> visits
                      </div>
                    </div>
                    <div class="text-xs text-gray-500">
                      <a :href="`{{ connect_url }}/a/${opp.organization}/opportunity/${opp.id}/`"
                         target="_blank"
                         @click.stop
                         class="text-blue-600 hover:underline">
                        View in Production →
                      </a>
                    </div>
                  </div>

                  <div x-show="expandedOpportunities.includes(opp.id)" class="bg-white p-4 ml-4">
                    <template x-if="flwDataLoading[opp.id]">
                      <div class="flex items-center justify-center p-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
                        <span class="ml-3 text-gray-600">Loading FLWs...</span>
                      </div>
                    </template>

                    <template x-if="flwDataErrors[opp.id]">
                      <div class="bg-red-50 border border-red-200 rounded p-4">
                        <p class="text-red-800">Error loading FLWs: <span x-text="flwDataErrors[opp.id]"></span></p>
                      </div>
                    </template>

                    <template x-if="flwData[opp.id] && flwData[opp.id].length > 0">
                      <div>
                        <h5 class="font-semibold mb-3">Field Workers (<span x-text="flwData[opp.id].length"></span>)</h5>
                        <div class="grid gap-3">
                          <template x-for="flw in flwData[opp.id]" :key="flw.username">
                            <div class="border rounded p-3 hover:bg-gray-50">
                              <div class="flex justify-between items-start">
                                <div>
                                  <p class="font-medium" x-text="flw.username"></p>
                                  <p class="text-sm text-gray-600" x-text="flw.phone"></p>
                                  <p class="text-sm text-gray-600">Status: <span x-text="flw.user_invite_status"></span></p>
                                </div>
                                <div class="text-right">
                                  <p class="text-sm font-semibold" x-text="'Payment: ' + (flw.payment_accrued || 0)"></p>
                                  <template x-if="flw.suspended">
                                    <span class="inline-block mt-1 px-2 py-1 bg-red-100 text-red-800 text-xs rounded">Suspended</span>
                                  </template>
                                </div>
                              </div>
                              <template x-if="flw.last_active">
                                <p class="text-xs text-gray-500 mt-2">Last active: <span x-text="new Date(flw.last_active).toLocaleDateString()"></span></p>
                              </template>
                            </div>
                          </template>
                        </div>
                      </div>
                    </template>

                    <template x-if="flwData[opp.id] && flwData[opp.id].length === 0">
                      <div class="text-gray-600 text-center p-4">No FLWs found for this opportunity.</div>
                    </template>
                  </div>
                </div>
              </template>
            </div>
          </div>
        </template>
      </div>
    </div>
  </template>

  <template x-if="Object.keys(groupedData).length === 0">
    <div class="text-center text-gray-600 p-8">No program data available.</div>
  </template>
</div>

{% endblock %}

{% block inline_javascript %}
<script>
function dashboard2Data() {
  return {
    programs: {{ programs_json|safe }},
    opportunities: {{ opportunities_json|safe }},
    expandedProgramTypes: [],
    expandedPrograms: [],
    expandedOpportunities: [],
    flwData: {},
    flwDataLoading: {},
    flwDataErrors: {},
    groupedData: {},
    minVisits: 0,
    filteredOpportunitiesCount: 0,
    totalOpportunitiesCount: 0,

    init() {
      console.log('Dashboard2 init - Programs:', this.programs);
      console.log('Dashboard2 init - Opportunities:', this.opportunities);

      // Read min_visits from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      this.minVisits = parseInt(urlParams.get('min_visits')) || 0;

      this.totalOpportunitiesCount = this.opportunities.length;
      this.processData();
    },

    processData() {
      console.log('Processing data with minVisits filter:', this.minVisits);

      // Clear existing opportunities from programs to avoid duplicates
      this.programs.forEach(p => { p.opportunities = []; });

      const programMap = new Map(this.programs.map(p => [p.id, p]));
      const orphanedOpportunities = [];

      // Filter opportunities based on visit count
      const filteredOpportunities = this.opportunities.filter(opp => (opp.visit_count || 0) >= this.minVisits);
      this.filteredOpportunitiesCount = filteredOpportunities.length;

      filteredOpportunities.forEach(opp => {
        const program = programMap.get(opp.program);
        if (program) {
          if (!program.opportunities) {
            program.opportunities = [];
          }
          program.opportunities.push(opp);
        } else if (opp.program === null) {
          // Opportunity has no program
          orphanedOpportunities.push(opp);
        }
      });

      const grouped = {};
      this.programs.forEach(program => {
        program.opportunities = program.opportunities || [];

        // Skip programs with no opportunities after filtering
        if (program.opportunities.length === 0) {
          return;
        }

        const typeName = program.delivery_type || 'Uncategorized';
        if (!grouped[typeName]) {
          grouped[typeName] = {
            programs: [],
            totalOpps: 0,
            totalVisits: 0,
            currencies: new Set()
          };
        }

        program.activeOpps = program.opportunities.filter(o => o.is_active).length;
        program.totalVisits = program.opportunities.reduce((sum, o) => sum + (o.visit_count || 0), 0);

        grouped[typeName].programs.push(program);
        grouped[typeName].totalOpps += program.opportunities.length;
        grouped[typeName].totalVisits += program.totalVisits;
        grouped[typeName].currencies.add(program.currency);
      });

      // Add "no program" category if there are orphaned opportunities
      if (orphanedOpportunities.length > 0) {
        grouped['no program'] = {
          programs: [{
            id: 'no-program',
            name: 'Opportunities without Program',
            delivery_type: 'no program',
            currency: 'N/A',
            organization: 'various',
            opportunities: orphanedOpportunities,
            activeOpps: orphanedOpportunities.filter(o => o.is_active).length,
            totalVisits: orphanedOpportunities.reduce((sum, o) => sum + (o.visit_count || 0), 0)
          }],
          totalOpps: orphanedOpportunities.length,
          totalVisits: orphanedOpportunities.reduce((sum, o) => sum + (o.visit_count || 0), 0),
          currencies: ['N/A']
        };
      }

      // Convert currencies Set to Array and filter out empty program types
      const filteredGrouped = {};
      Object.keys(grouped).forEach(key => {
        grouped[key].currencies = Array.from(grouped[key].currencies);
        // Only include program types that have programs with opportunities
        if (grouped[key].programs.length > 0 || grouped[key].totalOpps > 0) {
          filteredGrouped[key] = grouped[key];
        }
      });

      this.groupedData = filteredGrouped;
      console.log('Grouped data:', this.groupedData);
      console.log('Grouped data keys:', Object.keys(this.groupedData));
      console.log('Orphaned opportunities:', orphanedOpportunities.length);
    },

    toggleProgramType(typeName) {
      const index = this.expandedProgramTypes.indexOf(typeName);
      if (index > -1) {
        this.expandedProgramTypes.splice(index, 1);
      } else {
        this.expandedProgramTypes.push(typeName);
      }
    },

    toggleProgram(programId) {
      const index = this.expandedPrograms.indexOf(programId);
      if (index > -1) {
        this.expandedPrograms.splice(index, 1);
      } else {
        this.expandedPrograms.push(programId);
      }
    },

    async toggleOpportunity(oppId) {
      const index = this.expandedOpportunities.indexOf(oppId);
      if (index > -1) {
        this.expandedOpportunities.splice(index, 1);
      } else {
        this.expandedOpportunities.push(oppId);
        if (!this.flwData[oppId]) {
          await this.fetchFLWs(oppId);
        }
      }
    },

    applyFilter() {
      // Update URL with new filter value
      const url = new URL(window.location);
      if (this.minVisits > 0) {
        url.searchParams.set('min_visits', this.minVisits);
      } else {
        url.searchParams.delete('min_visits');
      }
      window.history.pushState({}, '', url);

      // Reprocess data with new filter
      this.processData();
    },

    async fetchFLWs(oppId) {
      this.flwDataLoading[oppId] = true;
      this.flwDataErrors[oppId] = null;

      try {
        const response = await fetch(`/labs/api/opportunity/${oppId}/flws/`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        const data = await response.json();
        this.flwData[oppId] = data.flws || [];
      } catch (error) {
        console.error('Error fetching FLWs:', error);
        this.flwDataErrors[oppId] = error.message;
      } finally {
        this.flwDataLoading[oppId] = false;
      }
    }
  };
}
</script>
{% endblock %}
