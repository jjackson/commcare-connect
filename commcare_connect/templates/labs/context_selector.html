{% load static %}
{# Context selector component for labs header #}

{{user.organizations|json_script:"org-data"}}
{{ user.programs|json_script:"program-data"}}
{{ user.opportunities|json_script:"opportunity-data"}}

{# Button only - no wrapper #}
<div x-data="labsContextSelector()">
  {% if request.labs_context.organization or request.labs_context.program or request.labs_context.opportunity %}
    {# Context is selected - show in order: org, program, opp #}
    <button @click="open = !open"
            class="flex items-center space-x-2 px-4 py-2 bg-white border border-gray-300 rounded-lg shadow-sm hover:bg-gray-50 transition"
            type="button">
      <div class="flex items-center space-x-2 text-sm">
        {% if request.labs_context.organization %}
          <span class="font-medium text-gray-700">Org:</span>
          <span class="text-gray-900">{{ request.labs_context.organization.name }}</span>
        {% endif %}
        {% if request.labs_context.program %}
          {% if request.labs_context.organization %}<span class="text-gray-400">|</span>{% endif %}
          <span class="font-medium text-gray-700">Program:</span>
          <span class="text-gray-900">{{ request.labs_context.program.name }}</span>
        {% endif %}
        {% if request.labs_context.opportunity %}
          {% if request.labs_context.organization or request.labs_context.program %}<span class="text-gray-400">|</span>{% endif %}
          <span class="font-medium text-gray-700">Opp:</span>
          <span class="text-gray-900">{{ request.labs_context.opportunity.name }} <span class="text-gray-500">(id: {{ request.labs_context.opportunity.id }} visits: {{ request.labs_context.opportunity.visit_count|default:0 }})</span></span>
        {% endif %}
      </div>
      <svg class="w-4 h-4 text-gray-500" :class="{'rotate-180': open}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </button>
  {% else %}
    {# No context selected - show selection button #}
    <button @click="open = !open"
            class="flex items-center space-x-2 px-4 py-2 bg-yellow-500 text-white rounded-lg shadow-sm hover:bg-yellow-600 transition"
            type="button">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
      </svg>
      <span class="font-medium">Select Context</span>
    </button>
  {% endif %}

  {# Full-width dropdown menu - positioned fixed, completely outside header flow #}
  <div x-show="open"
       x-transition:enter="transition ease-out duration-200"
       x-transition:enter-start="transform opacity-0 -translate-y-2"
       x-transition:enter-end="transform opacity-100 translate-y-0"
       x-transition:leave="transition ease-in duration-150"
       x-transition:leave-start="transform opacity-100 translate-y-0"
       x-transition:leave-end="transform opacity-0 -translate-y-2"
       @click.away="open = false"
       class="fixed left-16 right-0 bg-white shadow-2xl border-t border-b border-gray-200 z-50"
       style="display: none; top: 64px;">

    <div class="max-w-7xl mx-auto p-6">
      {# Search bar and refresh button #}
      <div class="mb-6 flex gap-3">
        <input type="text"
               x-model="search"
               placeholder="Search organizations, programs, or opportunities..."
               class="flex-1 px-4 py-3 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        <form method="post" action="{% url 'labs:refresh_org_data' %}" class="flex-shrink-0">
          {% csrf_token %}
          <button type="submit"
                  class="px-4 py-3 text-sm border border-gray-300 rounded-lg hover:bg-gray-50 transition flex items-center gap-2"
                  title="Refresh organizations, programs, and opportunities from Connect">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span>Refresh</span>
          </button>
        </form>
      </div>

      {# Three-column layout - always show all columns #}
      <div class="grid gap-6 mb-6 grid-cols-3">

        {# Organizations column #}
        <div class="border-r border-gray-200 pr-6">
          <h3 class="text-sm font-semibold uppercase tracking-wider mb-3 flex items-center justify-between"
              :class="showOrgs ? 'text-gray-700' : 'text-gray-400'">
            <div class="flex flex-col">
              <span>Organizations</span>
              <span x-show="!showOrgs" class="text-xs font-normal normal-case italic">(Filter not used by this labs project)</span>
            </div>
            <span class="text-xs text-gray-500 font-normal normal-case" x-text="'(' + orgData.length + ')'"></span>
          </h3>
          <div class="space-y-1 max-h-96 overflow-y-auto">
            <template x-for="org in orgData" :key="org.slug">
              <button type="button"
                 x-show="matchesSearch(org.name) || matchesSearch(org.slug)"
                 @click="selectOrg(org)"
                 class="w-full text-left px-3 py-2 text-sm text-gray-900 hover:bg-blue-50 rounded-lg transition"
                 :class="{
                   'bg-blue-100 font-medium border-l-4 border-blue-500': selectedOrg && selectedOrg.slug === org.slug,
                   'opacity-50': !showOrgs
                 }">
                <div class="font-medium" x-text="org.name"></div>
                <div class="text-xs text-gray-500 mt-0.5" x-text="org.slug"></div>
              </button>
            </template>
            <div x-show="orgData.length === 0" class="text-sm text-gray-500 italic px-3 py-4">
              No organizations found. Click Refresh above to reload data.
            </div>
          </div>
        </div>

        {# Programs column #}
        <div class="border-r border-gray-200 pr-6">
          <h3 class="text-sm font-semibold uppercase tracking-wider mb-3 flex items-center justify-between"
              :class="showPrograms ? 'text-gray-700' : 'text-gray-400'">
            <div class="flex flex-col">
              <span>Programs</span>
              <span x-show="!showPrograms" class="text-xs font-normal normal-case italic">(Filter not used by this labs project)</span>
            </div>
            <span class="text-xs text-gray-500 font-normal normal-case" x-text="'(' + filteredPrograms.length + ' of ' + programData.length + ')'"></span>
          </h3>
          <div class="space-y-1 max-h-96 overflow-y-auto">
            <template x-for="program in filteredPrograms" :key="program.id">
              <button type="button"
                 x-show="matchesSearch(program.name) || matchesSearch(String(program.id))"
                 @click="selectProgram(program)"
                 class="w-full text-left px-3 py-2 text-sm text-gray-900 hover:bg-green-50 rounded-lg transition"
                 :class="{
                   'bg-green-100 font-medium border-l-4 border-green-500': selectedProgram && selectedProgram.id === program.id,
                   'opacity-50': !showPrograms
                 }">
                <div class="font-medium" x-text="program.name"></div>
                <div class="text-xs text-gray-500 mt-0.5" x-text="'ID: ' + program.id + ' | ' + program.organization"></div>
              </button>
            </template>
            <div x-show="programData.length === 0" class="text-sm text-gray-500 italic px-3 py-4">
              No programs found. Click Refresh above to reload data.
            </div>
          </div>
        </div>

        {# Opportunities column #}
        <div>
          <h3 class="text-sm font-semibold uppercase tracking-wider mb-3 flex items-center justify-between"
              :class="showOpps ? 'text-gray-700' : 'text-gray-400'">
            <div class="flex flex-col">
              <span>Opportunities</span>
              <span x-show="!showOpps" class="text-xs font-normal normal-case italic">(Filter not used by this labs project)</span>
            </div>
            <span class="text-xs text-gray-500 font-normal normal-case" x-text="'(' + filteredOpps.length + ' of ' + oppData.length + ')'"></span>
          </h3>
          <div class="space-y-1 max-h-96 overflow-y-auto">
            <template x-for="opp in filteredOpps" :key="opp.id">
              <button type="button"
                 x-show="matchesSearch(opp.name) || matchesSearch(opp.program_name || '') || matchesSearch(String(opp.id))"
                 @click="selectOpp(opp)"
                 class="w-full text-left px-3 py-2 text-sm text-gray-900 hover:bg-purple-50 rounded-lg transition"
                 :class="{
                   'bg-purple-100 font-medium border-l-4 border-purple-500': selectedOpp && selectedOpp.id === opp.id,
                   'opacity-50': !showOpps
                 }">
                <div class="font-medium" x-text="opp.name"></div>
                <div class="text-xs text-gray-500 mt-0.5" x-text="'ID: ' + opp.id + ' | Visits: ' + (opp.visit_count || 0)"></div>
              </button>
            </template>
            <div x-show="oppData.length === 0" class="text-sm text-gray-500 italic px-3 py-4">
              No opportunities found. Click Refresh above to reload data.
            </div>
          </div>
        </div>
      </div>

      {# Footer with Apply and Clear buttons #}
      <div class="border-t border-gray-200 pt-4 flex items-center justify-between">
        <div class="text-sm text-gray-600">
          <span x-show="hasSelection">
            Selected:
            <span x-show="selectedOrg" class="font-medium text-blue-600" x-text="selectedOrg ? selectedOrg.name : ''"></span>
            <span x-show="selectedOrg && (selectedProgram || selectedOpp)"> -> </span>
            <span x-show="selectedProgram" class="font-medium text-green-600" x-text="selectedProgram ? selectedProgram.name : ''"></span>
            <span x-show="selectedProgram && selectedOpp"> -> </span>
            <span x-show="selectedOpp" class="font-medium text-purple-600" x-text="selectedOpp ? selectedOpp.name : ''"></span>
          </span>
          <span x-show="!hasSelection" class="text-gray-400 italic">
            No selection
          </span>
        </div>
        <div class="flex items-center space-x-3">
          {# Cache tolerance input - for testing/development #}
          <div class="flex items-center space-x-2 border-r border-gray-300 pr-3 mr-1">
            <label for="cache-tolerance" class="text-xs text-gray-500 whitespace-nowrap" title="Accept cache if it has >= this % of expected visits. Useful for testing when visit counts are slightly stale.">
              Cache tolerance:
            </label>
            <input type="number"
                   id="cache-tolerance"
                   x-model="cacheTolerance"
                   min="0"
                   max="100"
                   step="1"
                   placeholder="e.g. 98"
                   class="w-16 px-2 py-1 text-xs border border-gray-300 rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500"
                   title="Enter percentage (0-100). Leave empty for exact match only.">
            <span class="text-xs text-gray-400">%</span>
          </div>
          <button type="button"
                  @click="clearSelection()"
                  x-show="hasSelection"
                  class="px-4 py-2 text-sm text-red-600 hover:text-red-700 hover:bg-red-50 rounded-lg font-medium transition flex items-center">
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
            Clear
          </button>
          <button type="button"
                  @click="applySelection()"
                  class="px-6 py-2 text-sm rounded-lg font-medium transition flex items-center bg-blue-600 hover:bg-blue-700 text-white">
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
            Apply Selection
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function labsContextSelector() {
  return {
    open: false,
    search: '',
    selectedOrg: null,
    selectedProgram: null,
    selectedOpp: null,
    cacheTolerance: '',
    orgData: [],
    programData: [],
    oppData: [],
    currentPath: window.location.pathname,

    init() {
      // Initialize data from JSON script tags
      const orgDataEl = document.getElementById('org-data');
      if (orgDataEl) {
        this.orgData = JSON.parse(orgDataEl.textContent);
      }

      const programDataEl = document.getElementById('program-data');
      if (programDataEl) {
        this.programData = JSON.parse(programDataEl.textContent);
      }

      const oppDataEl = document.getElementById('opportunity-data');
      if (oppDataEl) {
        this.oppData = JSON.parse(oppDataEl.textContent);
      }

      // Initialize from current context using URL parameters
      const urlParams = new URLSearchParams(window.location.search);
      const orgId = urlParams.get('organization_id');
      const programId = urlParams.get('program_id');
      const oppId = urlParams.get('opportunity_id');
      const cacheTolPct = urlParams.get('cache_tolerance_pct');

      if (orgId) {
        const org = this.orgData.find(o => o.slug === orgId);
        if (org) {
          this.selectedOrg = {slug: org.slug, name: org.name};
        }
      }

      if (programId) {
        const program = this.programData.find(p => p.id === parseInt(programId));
        if (program) {
          this.selectedProgram = {id: program.id, name: program.name};
        }
      }

      if (oppId) {
        const opp = this.oppData.find(o => o.id === parseInt(oppId));
        if (opp) {
          this.selectedOpp = {id: opp.id, name: opp.name};
        }
      }

      // Initialize cache tolerance from URL
      if (cacheTolPct) {
        this.cacheTolerance = cacheTolPct;
      }
    },

    // Configuration: which filters each labs project supports
    // Format: path prefix -> [supported filters]
    pathFilters: {
      '/labs/overview': ['orgs', 'programs', 'opps'],
      '/labs/workflow/': ['opps'],
      '/solicitations/': ['orgs', 'programs'],
      '/explorer/': ['orgs', 'programs', 'opps'],
      '/audit/': ['programs', 'opps'],
      '/tasks/': ['programs', 'opps'],
      '/coverage/': ['opps'],
      '/custom_analysis/': ['opps'],
    },

    pathSupports(filter) {
      for (const [path, filters] of Object.entries(this.pathFilters)) {
        if (this.currentPath.includes(path) && filters.includes(filter)) {
          return true;
        }
      }
      return false;
    },

    get showOrgs() {
      return this.pathSupports('orgs');
    },

    get showPrograms() {
      return this.pathSupports('programs');
    },

    get showOpps() {
      return this.pathSupports('opps');
    },

    get hasSelection() {
      return this.selectedOrg || this.selectedProgram || this.selectedOpp;
    },

    get filteredPrograms() {
      // Filter by selected org if one is selected
      if (!this.selectedOrg) return this.programData;
      return this.programData.filter(p => p.organization === this.selectedOrg.slug);
    },

    get filteredOpps() {
      // Don't filter if programs aren't used by this project
      if (!this.showPrograms || !this.selectedProgram) return this.oppData;
      return this.oppData.filter(o => o.program === this.selectedProgram.id);
    },

    matchesSearch(text) {
      if (!this.search) return true;
      return text.toLowerCase().includes(this.search.toLowerCase());
    },

    isSelected(type, id) {
      if (type === 'org') return this.selectedOrg && this.selectedOrg.slug === id;
      if (type === 'program') return this.selectedProgram && this.selectedProgram.id === id;
      if (type === 'opp') return this.selectedOpp && this.selectedOpp.id === id;
      return false;
    },

    selectOrg(org) {
      this.selectedOrg = {slug: org.slug, name: org.name};
    },

    selectProgram(program) {
      this.selectedProgram = {id: program.id, name: program.name};
    },

    selectOpp(opp) {
      this.selectedOpp = {id: opp.id, name: opp.name};
    },

    clearSelection() {
      // Just clear the Alpine state, don't navigate
      // User will click "Apply" to actually clear the selection
      this.selectedOrg = null;
      this.selectedProgram = null;
      this.selectedOpp = null;
    },

    applySelection() {
      // Check if nothing is selected
      const hasSelection = (this.selectedOrg && this.showOrgs) ||
                          (this.selectedProgram && this.showPrograms) ||
                          (this.selectedOpp && this.showOpps);

      if (!hasSelection) {
        // If nothing selected, call the clear context endpoint
        // Create a form and submit it to clear the session
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/labs/clear-context/';

        // Add CSRF token
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
                         document.querySelector('meta[name="csrf-token"]')?.content ||
                         this.getCookie('csrftoken');
        if (csrfToken) {
          const csrfInput = document.createElement('input');
          csrfInput.type = 'hidden';
          csrfInput.name = 'csrfmiddlewaretoken';
          csrfInput.value = csrfToken;
          form.appendChild(csrfInput);
        }

        document.body.appendChild(form);
        form.submit();
      } else {
        // Only apply filters that are relevant to this project
        const url = new URL(window.location.href);
        url.searchParams.delete('organization_id');
        url.searchParams.delete('program_id');
        url.searchParams.delete('opportunity_id');
        url.searchParams.delete('cache_tolerance_pct');

        if (this.selectedOrg && this.showOrgs) {
          url.searchParams.set('organization_id', this.selectedOrg.slug);
        }
        if (this.selectedProgram && this.showPrograms) {
          url.searchParams.set('program_id', this.selectedProgram.id);
        }
        if (this.selectedOpp && this.showOpps) {
          url.searchParams.set('opportunity_id', this.selectedOpp.id);
        }

        // Add cache tolerance if specified (valid range 0-100)
        if (this.cacheTolerance !== '' && this.cacheTolerance !== null) {
          const tolerance = parseFloat(this.cacheTolerance);
          if (!isNaN(tolerance) && tolerance >= 0 && tolerance <= 100) {
            url.searchParams.set('cache_tolerance_pct', tolerance);
          }
        }

        const newUrl = url.toString();
        const currentUrl = window.location.href;

        // Force a full page reload with the new URL
        // If URL is the same, force reload; otherwise navigate to new URL
        if (newUrl === currentUrl) {
          window.location.reload();
        } else {
          window.location.href = newUrl;
        }
      }
    },

    getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
  };
}
</script>
