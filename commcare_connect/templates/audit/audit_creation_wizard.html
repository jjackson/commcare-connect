{% extends 'base.html' %}
{% load static i18n %}

{% block content %}
{% csrf_token %}
<div class="max-w-7xl mx-auto" x-data="auditCreationPage()">

  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Create New Audit Session</h1>
        <p class="text-gray-600">Search and select opportunities, configure audit criteria, and preview FLW counts</p>
      </div>
      <div class="flex gap-3">
        <a href="{% url 'audit:session_list' %}"
           class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
          ← Back to Sessions
        </a>
      </div>
    </div>
  </div>

  <!-- Quick Creation Notice -->
  <div x-show="Object.keys(quickParams).length > 0"
       class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
    <div class="flex items-start gap-3">
      <i class="fa-solid fa-bolt text-blue-600 mt-0.5"></i>
      <div>
        <h3 class="text-sm font-medium text-blue-800">Quick Audit Creation</h3>
        <p class="text-sm text-blue-700 mt-1">
          Form pre-filled from URL parameters.
          <span x-show="quickParams.username">Filtering for FLW: <strong x-text="quickParams.username"></strong></span>
          <span x-show="quickParams.auto_create === 'true'">Auto-creating...</span>
        </p>
      </div>
    </div>
  </div>

  <!-- Step 1: Program Search and Selection -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-brand-deep-purple mb-4">
      <i class="fa-solid fa-search mr-2"></i>
      Step 1: Search and Select Opportunities
    </h2>

    <!-- Search Input -->
    <div class="mb-4">
      <label for="program-search" class="block text-sm font-medium text-gray-700 mb-2">
        Search Opportunities
      </label>
      <div class="relative">
        <input
          type="text"
          id="opportunity-search"
          x-model="searchQuery"
          @input.debounce.300ms="searchOpportunities()"
          placeholder="Search by opportunity name or ID..."
          class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo"
        >
        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
          <i class="fa-solid fa-search text-gray-400" x-show="!searching"></i>
          <i class="fa-solid fa-spinner fa-spin text-brand-indigo" x-show="searching"></i>
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-1">
        Search by opportunity name or enter a specific opportunity ID
      </p>
    </div>

    <!-- Search Results -->
    <div x-show="searchResults.length > 0 || searchPerformed" class="mb-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-medium text-gray-700">
          Search Results
          <span x-show="searchResults.length > 0" class="text-brand-indigo">
            (<span x-text="searchResults.length"></span> found)
          </span>
        </h3>
        <div class="flex gap-2">
          <button
            @click="tableExpanded = !tableExpanded"
            x-show="searchResults.length > 0"
            class="text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1">
            <i class="fa-solid" :class="tableExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            <span x-text="tableExpanded ? 'Hide Table' : 'Show Table'"></span>
          </button>
          <button
            @click="clearSearch()"
            x-show="searchQuery || searchResults.length > 0"
            class="text-xs text-gray-500 hover:text-gray-700">
            Clear
          </button>
        </div>
      </div>

      <!-- No Results Message -->
      <div x-show="searchPerformed && searchResults.length === 0 && !searching"
           class="text-center py-8 text-gray-500">
        <i class="fa-solid fa-search text-3xl mb-2"></i>
        <p>No opportunities found matching "<span x-text="searchQuery"></span>"</p>
        <p class="text-sm">Try a different search term or opportunity ID</p>
      </div>

      <!-- Selected Opportunities Summary -->
      <div x-show="selectedOpportunities.length > 0" class="mb-4 pb-4 border-b">
        <h3 class="text-sm font-medium text-gray-700 mb-3">
          Selected Opportunities (<span x-text="selectedOpportunities.length"></span>)
        </h3>
        <div class="flex flex-wrap gap-2">
          <template x-for="opportunity in selectedOpportunities" :key="opportunity.id">
            <div class="flex items-center gap-2 px-3 py-1 bg-brand-indigo text-white rounded-full text-sm">
              <span x-text="opportunity.name"></span>
              <button @click="removeOpportunitySelection(opportunity)" class="hover:text-gray-200">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          </template>
        </div>
      </div>

      <!-- Results Table -->
      <div x-show="searchResults.length > 0 && tableExpanded" class="overflow-hidden table-container flex flex-col gap-2 mb-1">
        <div class="w-full overflow-x-auto block">
          <table class="base-table">
            <thead>
              <tr>
                <th class="w-12">
                  <span>Select</span>
                </th>
                <th class="w-16 cursor-pointer hover:bg-gray-100" @click="sortBy('id')">
                  <span class="flex items-center justify-between">
                    ID
                    <i class="fa-solid text-xs ml-1" :class="{
                      'fa-sort': sortColumn !== 'id',
                      'fa-sort-up': sortColumn === 'id' && sortDirection === 'asc',
                      'fa-sort-down': sortColumn === 'id' && sortDirection === 'desc'
                    }"></i>
                  </span>
                </th>
                <th class="w-1/4 cursor-pointer hover:bg-gray-100" @click="sortBy('name')">
                  <span class="flex items-center justify-between">
                    Opportunity Name
                    <i class="fa-solid text-xs ml-1" :class="{
                      'fa-sort': sortColumn !== 'name',
                      'fa-sort-up': sortColumn === 'name' && sortDirection === 'asc',
                      'fa-sort-down': sortColumn === 'name' && sortDirection === 'desc'
                    }"></i>
                  </span>
                </th>
                <th class="w-1/6 cursor-pointer hover:bg-gray-100" @click="sortBy('organization_name')">
                  <span class="flex items-center justify-between">
                    Organization
                    <i class="fa-solid text-xs ml-1" :class="{
                      'fa-sort': sortColumn !== 'organization_name',
                      'fa-sort-up': sortColumn === 'organization_name' && sortDirection === 'asc',
                      'fa-sort-down': sortColumn === 'organization_name' && sortDirection === 'desc'
                    }"></i>
                  </span>
                </th>
                <th class="w-1/6 cursor-pointer hover:bg-gray-100" @click="sortBy('program_name')">
                  <span class="flex items-center justify-between">
                    Program
                    <i class="fa-solid text-xs ml-1" :class="{
                      'fa-sort': sortColumn !== 'program_name',
                      'fa-sort-up': sortColumn === 'program_name' && sortDirection === 'asc',
                      'fa-sort-down': sortColumn === 'program_name' && sortDirection === 'desc'
                    }"></i>
                  </span>
                </th>
                <th class="w-20 text-center cursor-pointer hover:bg-gray-100" @click="sortBy('visit_count')">
                  <span class="flex items-center justify-center gap-1">
                    Visits
                    <i class="fa-solid text-xs" :class="{
                      'fa-sort': sortColumn !== 'visit_count',
                      'fa-sort-up': sortColumn === 'visit_count' && sortDirection === 'asc',
                      'fa-sort-down': sortColumn === 'visit_count' && sortDirection === 'desc'
                    }"></i>
                  </span>
                </th>
                <th class="w-24">
                  <span>Dates</span>
                </th>
                <th class="w-24">
                  <span>Status</span>
                </th>
              </tr>
            </thead>
            <tbody>
              <template x-for="opportunity in getSortedResults()" :key="opportunity.id">
                <tr class="group hover:bg-gray-50 cursor-pointer"
                    :class="selectedOpportunities.some(o => o.id === opportunity.id) ? 'bg-brand-indigo/5' : ''"
                    @click="toggleOpportunitySelection(opportunity)">
                  <td class="text-center">
                    <input type="checkbox"
                           :checked="selectedOpportunities.some(o => o.id === opportunity.id)"
                           class="h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300 rounded"
                           @click.stop="toggleOpportunitySelection(opportunity)">
                  </td>
                  <td>
                    <span x-text="opportunity.id"></span>
                  </td>
                  <td>
                    <div class="truncate max-w-xs" :title="opportunity.name + (opportunity.description ? ': ' + opportunity.description : '')" x-text="opportunity.name"></div>
                  </td>
                  <td>
                    <span class="truncate block max-w-[150px]" :title="opportunity.organization_name" x-text="opportunity.organization_name"></span>
                  </td>
                  <td>
                    <span class="truncate block max-w-[150px]" :title="opportunity.program_name" x-text="opportunity.program_name || '-'"></span>
                  </td>
                  <td class="text-center">
                    <template x-if="opportunity.visit_count !== undefined">
                      <span class="inline-flex items-center justify-center px-2 py-1 text-sm font-medium rounded bg-blue-50 text-blue-700" x-text="opportunity.visit_count"></span>
                    </template>
                    <template x-if="opportunity.visit_count === undefined">
                      <i class="fa-solid fa-spinner fa-spin text-gray-400"></i>
                    </template>
                  </td>
                  <td>
                    <template x-if="opportunity.start_date">
                      <div>
                        <div x-text="formatDate(opportunity.start_date)"></div>
                        <template x-if="opportunity.end_date">
                          <div class="text-xs text-gray-500">to <span x-text="formatDate(opportunity.end_date)"></span></div>
                        </template>
                      </div>
                    </template>
                  </td>
                  <td>
                    <div class="flex flex-wrap gap-1">
                      <span x-show="opportunity.active" class="inline-flex px-2 py-1 text-xs rounded bg-green-50 text-green-700">
                        Active
                      </span>
                      <span x-show="!opportunity.active" class="inline-flex px-2 py-1 text-xs rounded bg-red-50 text-red-700">
                        Inactive
                      </span>
                      <span x-show="opportunity.is_test" class="inline-flex px-2 py-1 text-xs rounded bg-orange-50 text-orange-700">
                        Test
                      </span>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 2: Audit Granularity -->
  <div x-show="selectedOpportunities.length > 0" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-brand-deep-purple mb-4">
      <i class="fa-solid fa-layer-group mr-2"></i>
      Step 2: Select Audit Granularity
    </h2>

    <div class="space-y-3">
      <!-- Combined Option -->
      <div class="flex items-start p-4 border border-gray-200 rounded-lg hover:border-brand-indigo transition-colors">
        <input
          type="radio"
          id="granularity-combined"
          name="granularity"
          value="combined"
          x-model="auditCriteria.granularity"
          class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
        >
        <div class="ml-3 flex-1">
          <label for="granularity-combined" class="text-sm font-medium text-gray-700 cursor-pointer">
            One audit for all selected opportunities
          </label>
          <p class="text-xs text-gray-500 mt-1">
            Creates a single audit session combining all FLWs across all selected opportunities. Best for organization-wide quality reviews.
          </p>
        </div>
      </div>

      <!-- Per Opportunity Option -->
      <div class="flex items-start p-4 border border-gray-200 rounded-lg hover:border-brand-indigo transition-colors">
        <input
          type="radio"
          id="granularity-per-opp"
          name="granularity"
          value="per_opp"
          x-model="auditCriteria.granularity"
          class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
        >
        <div class="ml-3 flex-1">
          <label for="granularity-per-opp" class="text-sm font-medium text-gray-700 cursor-pointer">
            One audit per opportunity
          </label>
          <p class="text-xs text-gray-500 mt-1">
            Creates <span x-text="selectedOpportunities.length"></span> separate audit session(s), one for each opportunity. Best for comparing performance across different programs.
          </p>
        </div>
      </div>

      <!-- Per FLW Option -->
      <div class="flex items-start p-4 border border-gray-200 rounded-lg hover:border-brand-indigo transition-colors">
        <input
          type="radio"
          id="granularity-per-flw"
          name="granularity"
          value="per_flw"
          x-model="auditCriteria.granularity"
          class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
        >
        <div class="ml-3 flex-1">
          <label for="granularity-per-flw" class="text-sm font-medium text-gray-700 cursor-pointer">
            One audit per FLW
          </label>
          <p class="text-xs text-gray-500 mt-1">
            Creates separate audit sessions for each field worker across all opportunities. Best for individual performance reviews and coaching.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 3: Audit Criteria -->
  <div x-show="selectedOpportunities.length > 0" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-brand-deep-purple mb-4">
      <i class="fa-solid fa-cog mr-2"></i>
      Step 3: Configure Audit Criteria
    </h2>

    <!-- Audit Type Selection -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-3">
        Select Audit Type
      </label>
      <div class="space-y-3">
        <!-- Date Range Option -->
        <div class="flex items-start">
          <input
            type="radio"
            id="audit-type-date-range"
            name="audit-type"
            value="date_range"
            x-model="auditCriteria.type"
            class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
          >
          <div class="ml-3 flex-1">
            <label for="audit-type-date-range" class="text-sm font-medium text-gray-700 cursor-pointer">
              Date Range
            </label>
            <p class="text-xs text-gray-500">
              Audit all visits within a specific date range
            </p>

            <!-- Date Range Inputs -->
            <div x-show="auditCriteria.type === 'date_range'" class="mt-3 grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Start Date</label>
                <input
                  type="date"
                  x-model="auditCriteria.startDate"
                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo"
                >
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">End Date</label>
                <input
                  type="date"
                  x-model="auditCriteria.endDate"
                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo"
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Last N per FLW Option -->
        <div class="flex items-start">
          <input
            type="radio"
            id="audit-type-per-flw"
            name="audit-type"
            value="last_n_per_flw"
            x-model="auditCriteria.type"
            class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
          >
          <div class="ml-3 flex-1">
            <label for="audit-type-per-flw" class="text-sm font-medium text-gray-700 cursor-pointer">
              Last N Visits per FLW
            </label>
            <p class="text-xs text-gray-500">
              Audit the most recent N visits for each Field Learning Worker
            </p>

            <!-- Per FLW Count Input -->
            <div x-show="auditCriteria.type === 'last_n_per_flw'" class="mt-3">
              <label class="block text-xs font-medium text-gray-600 mb-1">Number of visits per FLW</label>
              <div class="flex items-center gap-4">
                <input
                  type="number"
                  x-model.number="auditCriteria.countPerFlw"
                  :disabled="auditCriteria.allVisitsPerFlw"
                  min="1"
                  max="1000"
                  placeholder="e.g., 100"
                  class="w-32 px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo disabled:bg-gray-100 disabled:cursor-not-allowed"
                >
                <label class="flex items-center cursor-pointer">
                  <input
                    type="checkbox"
                    x-model="auditCriteria.allVisitsPerFlw"
                    @change="if (auditCriteria.allVisitsPerFlw) { auditCriteria.countPerFlw = 99999; } else { auditCriteria.countPerFlw = 100; }"
                    class="h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300 rounded"
                  >
                  <span class="ml-2 text-sm text-gray-700">All visits</span>
                </label>
              </div>
            </div>
          </div>
        </div>

        <!-- Last N per Opportunity Option -->
        <div class="flex items-start">
          <input
            type="radio"
            id="audit-type-per-opp"
            name="audit-type"
            value="last_n_per_opp"
            x-model="auditCriteria.type"
            class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
          >
          <div class="ml-3 flex-1">
            <label for="audit-type-per-opp" class="text-sm font-medium text-gray-700 cursor-pointer">
              Last N Visits per Opportunity
            </label>
            <p class="text-xs text-gray-500">
              Audit the most recent N visits from each selected opportunity (N × number of opportunities total)
            </p>

            <!-- Per Opportunity Count Input -->
            <div x-show="auditCriteria.type === 'last_n_per_opp'" class="mt-3">
              <label class="block text-xs font-medium text-gray-600 mb-1">Number of visits per opportunity</label>
              <input
                type="number"
                x-model.number="auditCriteria.countPerOpp"
                min="1"
                max="10000"
                placeholder="e.g., 500"
                class="w-32 px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo"
              >
            </div>
          </div>
        </div>

        <!-- Last N across ALL Opportunities Option -->
        <div class="flex items-start">
          <input
            type="radio"
            id="audit-type-across-all"
            name="audit-type"
            value="last_n_across_all"
            x-model="auditCriteria.type"
            class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
          >
          <div class="ml-3 flex-1">
            <label for="audit-type-across-all" class="text-sm font-medium text-gray-700 cursor-pointer">
              Last N Visits across All Opportunities
            </label>
            <p class="text-xs text-gray-500">
              Audit the most recent N visits total across all selected opportunities combined, regardless of FLW or opportunity
            </p>

            <!-- Across All Count Input -->
            <div x-show="auditCriteria.type === 'last_n_across_all'" class="mt-3">
              <label class="block text-xs font-medium text-gray-600 mb-1">Total number of visits</label>
              <input
                type="number"
                x-model.number="auditCriteria.countAcrossAll"
                min="1"
                max="10000"
                placeholder="e.g., 1000"
                class="w-32 px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo"
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sampling Configuration -->
    <div class="mt-6 pt-6 border-t border-gray-200">
      <label class="block text-sm font-medium text-gray-700 mb-3">
        <i class="fa-solid fa-percentage mr-1"></i>
        Sampling Configuration
      </label>
      <p class="text-xs text-gray-600 mb-4">
        Control what percentage of matching visits to include in the audit. Use sampling to create manageable audit sizes for large datasets.
      </p>

      <div class="space-y-4">
        <!-- Sampling Percentage Slider -->
        <div>
          <div class="flex items-center justify-between mb-2">
            <label class="text-sm text-gray-700">Sample Percentage</label>
            <div class="flex items-center gap-2">
              <span class="text-lg font-semibold text-brand-indigo" x-text="auditCriteria.samplePercentage + '%'"></span>
              <span class="text-xs text-gray-500" x-show="auditCriteria.samplePercentage === 100">(No sampling)</span>
            </div>
          </div>

          <!-- Slider -->
          <input
            type="range"
            x-model.number="auditCriteria.samplePercentage"
            min="1"
            max="100"
            step="1"
            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-brand-indigo"
          >

          <!-- Quick Selection Buttons -->
          <div class="flex gap-2 mt-3">
            <button
              @click="auditCriteria.samplePercentage = 25"
              :class="auditCriteria.samplePercentage === 25 ? 'bg-brand-indigo text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
              class="px-3 py-1 text-xs rounded-md transition-colors">
              25%
            </button>
            <button
              @click="auditCriteria.samplePercentage = 50"
              :class="auditCriteria.samplePercentage === 50 ? 'bg-brand-indigo text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
              class="px-3 py-1 text-xs rounded-md transition-colors">
              50%
            </button>
            <button
              @click="auditCriteria.samplePercentage = 75"
              :class="auditCriteria.samplePercentage === 75 ? 'bg-brand-indigo text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
              class="px-3 py-1 text-xs rounded-md transition-colors">
              75%
            </button>
            <button
              @click="auditCriteria.samplePercentage = 100"
              :class="auditCriteria.samplePercentage === 100 ? 'bg-brand-indigo text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'"
              class="px-3 py-1 text-xs rounded-md transition-colors">
              100% (All)
            </button>
          </div>
        </div>

        <!-- Sampling Explanation -->
        <div class="bg-blue-50 border border-blue-200 rounded-md p-3">
          <div class="flex items-start gap-2">
            <i class="fa-solid fa-info-circle text-blue-600 mt-0.5"></i>
            <div class="text-xs text-blue-800">
              <p class="font-medium mb-1">How sampling works:</p>
              <ul class="list-disc list-inside space-y-1 text-blue-700">
                <template x-if="auditCriteria.samplePercentage === 100">
                  <li>All matching visits will be included in the audit (no sampling)</li>
                </template>
                <template x-if="auditCriteria.samplePercentage < 100">
                  <li>A random <span x-text="auditCriteria.samplePercentage + '%'"></span> of matching visits will be selected</li>
                  <li>The same sample will be used for both preview and final audit creation</li>
                </template>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Update Preview Button -->
    <div class="flex justify-center mt-6">
      <button
        @click="updatePreview()"
        :disabled="!isAuditCriteriaValid() || updating"
        class="px-6 py-2 bg-brand-indigo text-white rounded-md hover:bg-brand-indigo/90 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2">
        <i class="fa-solid fa-refresh" :class="{'fa-spin': updating}"></i>
        <span x-text="updating ? 'Updating...' : 'Update Preview'"></span>
      </button>
    </div>

  </div>

  <!-- Step 4: Preview Results -->
  <div x-show="previewResults.length > 0" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-brand-deep-purple mb-4">
      <i class="fa-solid fa-eye mr-2"></i>
      Step 4: Preview - Select FLWs to Audit
    </h2>

    <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-md">
      <div class="flex items-center gap-4 text-sm">
        <span class="text-blue-600 font-medium">
          <i class="fa-solid fa-users mr-1"></i>
          <span x-text="previewResults.length"></span> FLWs
        </span>
        <span class="text-green-600 font-medium">
          <i class="fa-solid fa-chart-line mr-1"></i>
          <span x-text="previewResults.reduce((sum, flw) => sum + flw.visit_count, 0)"></span> Total Visits
        </span>
      </div>
    </div>

    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase tracking-wider w-12">
              <input type="checkbox" @change="toggleAllFlws()" :checked="areAllFlwsSelected()" class="h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300 rounded">
            </th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              FLW Name
            </th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Connect ID
            </th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Visits in Audit
            </th>
            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
              Date Range
            </th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <template x-for="flw in previewResults" :key="flw.username">
            <tr class="hover:bg-gray-50">
              <td class="px-2 py-2 text-center whitespace-nowrap">
                <input type="checkbox" :checked="isFlwSelected(flw)" @change="toggleFlwSelection(flw)" class="h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300 rounded">
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
                <span x-text="flw.name"></span>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <span x-text="flw.connect_id || flw.user_id"></span>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                <span x-text="flw.visit_count"></span>
              </td>
              <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
                <template x-if="flw.earliest_visit && flw.latest_visit">
                  <span>
                    <span x-text="formatDate(flw.earliest_visit)"></span> -
                    <span x-text="formatDate(flw.latest_visit)"></span>
                  </span>
                </template>
              </td>
            </tr>
          </template>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Step 5: Audit Metadata and Action Buttons -->
  <div x-show="selectedOpportunities.length > 0" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-brand-deep-purple mb-4">
      <i class="fa-solid fa-tag mr-2"></i>
      Step 5: Audit Metadata & Creation
    </h2>

    <div class="grid grid-cols-2 gap-4 mb-6">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Audit Title <span class="text-gray-500 text-xs">(optional)</span>
        </label>
        <input
          type="text"
          x-model="auditTitle"
          placeholder="e.g., Week of Jan 1-7, 2024"
          class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo">
        <p class="text-xs text-gray-500 mt-1">Descriptive title for this audit (e.g., date range, purpose)</p>
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-2">
          Audit Tag <span class="text-gray-500 text-xs">(optional)</span>
        </label>
        <input
          type="text"
          x-model="auditTag"
          placeholder="e.g., first_10, quarterly_q1"
          class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo">
        <p class="text-xs text-gray-500 mt-1">Tag for categorizing audits (e.g., "first_10" for first 10 visits milestone)</p>
      </div>
    </div>

    <div class="flex justify-end gap-4">
      <button
        @click="clearAllSelections()"
        class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
        Clear All
      </button>
      <button
        @click="createAuditSession()"
        :disabled="!isAuditCriteriaValid() || creating"
        class="px-4 py-2 bg-brand-indigo text-white rounded-md hover:bg-brand-indigo/90 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2">
        <i class="fa-solid fa-plus" :class="{'fa-spin': creating}"></i>
        <span x-text="creating ? 'Creating...' : 'Create Audit Session'"></span>
      </button>
    </div>
  </div>

  <!-- Reusable Progress Modal -->
  <div x-show="showProgressModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
       x-cloak
       @keydown.escape.window="cancelProgress()">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg" @click.away="">
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900" x-text="progressTitle"></h3>
        <p class="text-sm text-gray-600 mt-1" x-text="progressMessage"></p>
      </div>

      <!-- Progress Steps -->
      <div class="space-y-4 mb-6">
        <template x-for="step in progressSteps" :key="step.name">
          <div class="space-y-2">
            <!-- Step Header -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <!-- Status Icon -->
                <span x-show="step.status === 'complete'" class="text-green-600">
                  <i class="fa-solid fa-check-circle"></i>
                </span>
                <span x-show="step.status === 'in_progress'" class="text-brand-indigo">
                  <i class="fa-solid fa-spinner fa-spin"></i>
                </span>
                <span x-show="step.status === 'pending'" class="text-gray-400">
                  <i class="fa-regular fa-circle"></i>
                </span>

                <!-- Step Message -->
                <span class="text-sm font-medium"
                      :class="{
                        'text-green-600': step.status === 'complete',
                        'text-brand-indigo': step.status === 'in_progress',
                        'text-gray-500': step.status === 'pending'
                      }"
                      x-text="step.message"></span>
              </div>

              <!-- Percentage -->
              <span class="text-xs text-gray-500"
                    x-show="step.status !== 'pending'"
                    x-text="`${step.percentage}%`"></span>
            </div>

            <!-- Progress Bar -->
            <div x-show="step.status !== 'pending'" class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
              <div class="h-full transition-all duration-300"
                   :class="{
                     'bg-green-500': step.status === 'complete',
                     'bg-brand-indigo': step.status === 'in_progress'
                   }"
                   :style="`width: ${step.percentage}%`"></div>
            </div>
          </div>
        </template>
      </div>

      <!-- Error Message -->
      <div x-show="progressError" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
        <p class="text-sm text-red-800" x-text="progressError"></p>
      </div>

      <!-- Cancel/Close Button -->
      <div class="flex justify-end gap-3">
        <button
          @click="cancelProgress()"
          :disabled="progressStage === 'complete' && progressMode === 'creation'"
          class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
          <span x-text="(progressStage === 'complete' || progressStage === 'error' || progressStage === 'cancelled') ? 'Close' : 'Cancel'"></span>
        </button>
      </div>
    </div>
  </div>

</div>

<script>
function auditCreationPage() {
  return {
    // Progress tracking state (reusable for preview and creation)
    showProgressModal: false,
    progressTitle: '',
    progressMessage: 'Initializing...',
    progressPercentage: 0,
    progressStage: 'loading',
    progressError: null,
    progressTaskId: null,
    progressPollInterval: null,
    progressSteps: [],
    progressMode: 'creation', // 'preview' or 'creation'

    // Search state
    searchQuery: '{{ default_opportunity_id }}',
    defaultOpportunityId: {{ default_opportunity_id|default:"null" }},
    allOpportunities: {{ opportunities_json|safe }},
    searchResults: [],
    searchPerformed: false,
    searching: false,
    tableExpanded: true,
    sortColumn: 'visit_count',
    sortDirection: 'desc',

    // Quick params from URL (for quick audit creation from other pages)
    quickParams: {{ quick_params|safe }},

    // Selection state
    selectedOpportunities: [],

    // Audit criteria state
    auditCriteria: {
      granularity: 'combined',  // 'combined', 'per_opp', 'per_flw'
      type: 'date_range',
      startDate: '',
      endDate: '',
      countPerFlw: 100,
      countPerOpp: 500,
      countAcrossAll: 1000,
      allVisitsPerFlw: false,
      samplePercentage: 100
    },

    // Preview state
    previewResults: [],
    auditDefinitionId: null,  // Stores the audit definition ID from preview
    updating: false,
    creating: false,

    // FLW selection state
    selectedFlwUserIds: [],  // Array of usernames (or user_ids) for selected FLWs - TODO: check with team on naming

    // Audit metadata
    auditTitle: '',
    auditTag: '',

    // Quick filter for specific username/user_id (from URL params)
    quickFilterUsername: null,
    quickFilterUserId: null,

    // Methods
    searchOpportunities() {
      const query = this.searchQuery.trim().toLowerCase();

      if (!query) {
        // Show all opportunities when no search query
        this.searchResults = [...this.allOpportunities];
        this.searchPerformed = true;
        return;
      }

      // Filter locally - no API call needed
      this.searchResults = this.allOpportunities.filter(opp => {
        const idMatch = query === String(opp.id);
        const nameMatch = opp.name && opp.name.toLowerCase().includes(query);
        return idMatch || nameMatch;
      });
      this.searchPerformed = true;
    },

    toggleOpportunitySelection(opportunity) {
      const index = this.selectedOpportunities.findIndex(o => o.id === opportunity.id);
      if (index >= 0) {
        this.selectedOpportunities.splice(index, 1);
      } else {
        this.selectedOpportunities.push(opportunity);
      }
    },

    removeOpportunitySelection(opportunity) {
      const index = this.selectedOpportunities.findIndex(o => o.id === opportunity.id);
      if (index >= 0) {
        this.selectedOpportunities.splice(index, 1);
      }
    },


    clearSearch() {
      this.searchQuery = '';
      this.searchResults = [];
      this.searchPerformed = false;
    },

    // Sorting methods
    sortBy(column) {
      if (this.sortColumn === column) {
        // Toggle direction if same column
        this.sortDirection = this.sortDirection === 'asc' ? 'desc' : 'asc';
      } else {
        // New column, default to descending for visit_count, ascending for others
        this.sortColumn = column;
        this.sortDirection = column === 'visit_count' ? 'desc' : 'asc';
      }
    },

    getSortedResults() {
      if (!this.searchResults || this.searchResults.length === 0) {
        return [];
      }

      const sorted = [...this.searchResults].sort((a, b) => {
        let aVal = a[this.sortColumn];
        let bVal = b[this.sortColumn];

        // Handle undefined values
        if (aVal === undefined || aVal === null) aVal = '';
        if (bVal === undefined || bVal === null) bVal = '';

        // Handle numeric comparison for visit_count
        if (this.sortColumn === 'visit_count') {
          aVal = Number(aVal) || 0;
          bVal = Number(bVal) || 0;
        } else if (typeof aVal === 'string') {
          // Case-insensitive string comparison
          aVal = aVal.toLowerCase();
          bVal = bVal.toLowerCase();
        }

        if (aVal < bVal) return this.sortDirection === 'asc' ? -1 : 1;
        if (aVal > bVal) return this.sortDirection === 'asc' ? 1 : -1;
        return 0;
      });

      return sorted;
    },

    clearAllSelections() {
      this.selectedOpportunities = [];
      this.previewResults = [];
      this.selectedFlwUserIds = [];
      this.auditTitle = '';
      this.auditTag = '';
    },

    // FLW selection methods
    isFlwSelected(flw) {
      return this.selectedFlwUserIds.includes(flw.user_id || flw.connect_id);
    },

    toggleFlwSelection(flw) {
      const userId = flw.user_id || flw.connect_id;
      const index = this.selectedFlwUserIds.indexOf(userId);
      if (index >= 0) {
        this.selectedFlwUserIds.splice(index, 1);
      } else {
        this.selectedFlwUserIds.push(userId);
      }
    },

    toggleAllFlws() {
      if (!this.previewResults || this.previewResults.length === 0) return;

      const allSelected = this.areAllFlwsSelected();
      if (allSelected) {
        // Deselect all FLWs
        this.selectedFlwUserIds = [];
      } else {
        // Select all FLWs
        this.selectedFlwUserIds = this.previewResults.map(flw => flw.user_id || flw.connect_id);
      }
    },

    areAllFlwsSelected() {
      if (!this.previewResults || this.previewResults.length === 0) return false;
      return this.previewResults.every(flw =>
        this.selectedFlwUserIds.includes(flw.user_id || flw.connect_id)
      );
    },

    formatDate(dateString) {
      if (!dateString) return '';
      return new Date(dateString).toLocaleDateString();
    },

    // Audit criteria validation
    isAuditCriteriaValid() {
      if (!this.auditCriteria.type) return false;

      switch (this.auditCriteria.type) {
        case 'date_range':
          return this.auditCriteria.startDate && this.auditCriteria.endDate;
        case 'last_n_per_flw':
          return this.auditCriteria.countPerFlw && this.auditCriteria.countPerFlw > 0;
        case 'last_n_per_opp':
          return this.auditCriteria.countPerOpp && this.auditCriteria.countPerOpp > 0;
        case 'last_n_across_all':
          return this.auditCriteria.countAcrossAll && this.auditCriteria.countAcrossAll > 0;
        default:
          return false;
      }
    },

    // Initialize progress modal for preview
    initPreviewProgress() {
      this.progressMode = 'preview';
      this.progressTitle = 'Generating Preview';
      this.progressMessage = 'Initializing...';
      this.progressPercentage = 0;
      this.progressStage = 'loading';
      this.progressError = null;
      this.progressSteps = [
        { name: 'loading_ids', message: 'Loading visit IDs...', percentage: 0, status: 'pending' },
        { name: 'sampling', message: 'Applying sampling...', percentage: 0, status: 'pending' },
        { name: 'calculating', message: 'Calculating preview...', percentage: 0, status: 'pending' }
      ];
    },

    // Initialize progress modal for creation
    initCreationProgress() {
      this.progressMode = 'creation';
      this.progressTitle = 'Creating Audit Session';
      this.progressMessage = 'Initializing...';
      this.progressPercentage = 0;
      this.progressStage = 'loading';
      this.progressError = null;
      this.progressSteps = [
        { name: 'opportunities', message: 'Loading opportunities...', percentage: 0, status: 'pending' },
        { name: 'users', message: 'Loading users...', percentage: 0, status: 'pending' },
        { name: 'sessions', message: 'Creating sessions...', percentage: 0, status: 'pending' },
        { name: 'attachments', message: 'Downloading attachments...', percentage: 0, status: 'pending' }
      ];
    },

    // Update preview - synchronous API call
    async updatePreview() {
      if (!this.isAuditCriteriaValid() || this.selectedOpportunities.length === 0) {
        return;
      }

      this.updating = true;
      this.previewResults = [];
      this.auditDefinitionId = null;

      try {
        const payload = {
          opportunities: this.selectedOpportunities.map(o => o.id),
          criteria: this.auditCriteria
        };

        const response = await fetch('{% url "audit:preview_audit" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!data.success) {
          alert(data.error || 'Failed to generate preview');
          this.updating = false;
          return;
        }

        // Preview data received - populate FLW results
        const preview = data.preview;
        console.log('Preview received:', preview);

        if (!preview.flws || preview.flws.length === 0) {
          alert('No visits found matching the criteria. Try adjusting the date range or audit type.');
          this.previewResults = [];
          this.selectedFlwUserIds = [];
        } else {
          // Populate preview results with FLW data
          this.previewResults = preview.flws;

          // If quick filter username/user_id is set, only select that FLW
          if (this.quickFilterUsername || this.quickFilterUserId) {
            const matchingFlws = preview.flws.filter(flw => {
              if (this.quickFilterUsername) {
                return flw.username === this.quickFilterUsername || flw.name === this.quickFilterUsername;
              }
              if (this.quickFilterUserId) {
                return String(flw.user_id) === String(this.quickFilterUserId) ||
                       String(flw.connect_id) === String(this.quickFilterUserId);
              }
              return false;
            });
            this.selectedFlwUserIds = matchingFlws.map(flw => flw.user_id || flw.connect_id);
          } else {
            // Auto-select all FLWs by default
            this.selectedFlwUserIds = preview.flws.map(flw => flw.user_id || flw.connect_id);
          }
        }

        this.updating = false;

      } catch (error) {
        console.error('Preview error:', error);
        alert('Failed to generate preview. Please try again.');
        this.updating = false;
      }
    },

    // Poll for progress updates (works for both preview and creation)
    async pollProgress() {
      if (!this.progressTaskId) return;

      try {
        const response = await fetch(`{% url "audit:audit_progress" %}?task_id=${this.progressTaskId}`);
        const data = await response.json();

        if (data.error) {
          this.progressError = data.error;
          this.progressStage = 'error';
          this.stopProgressPolling();
          return;
        }

        this.progressMessage = data.message || 'Processing...';
        this.progressPercentage = data.percentage || 0;
        this.progressStage = data.stage || 'processing';

        // Update individual steps
        if (data.steps && Array.isArray(data.steps)) {
          data.steps.forEach(dataStep => {
            const step = this.progressSteps.find(s => s.name === dataStep.name);
            if (step) {
              step.message = dataStep.message;
              step.percentage = dataStep.percentage;
              step.status = dataStep.status;
            }
          });
        }

        // Handle completion
        if (data.stage === 'complete') {
          this.stopProgressPolling();

          // For preview mode, update preview results and close modal
          if (this.progressMode === 'preview') {
            if (data.result && data.result.preview_results) {
              this.previewResults = data.result.preview_results;
              this.auditDefinitionId = data.result.audit_definition_id || null;
              this.updating = false;

              // Auto-select all FLWs by default
              this.selectedFlwUserIds = [];
              this.previewResults.forEach(result => {
                if (result.flws && result.flws.length > 0) {
                  result.flws.forEach(flw => {
                    const userId = flw.user_id || flw.connect_id;
                    if (userId && !this.selectedFlwUserIds.includes(userId)) {
                      this.selectedFlwUserIds.push(userId);
                    }
                  });
                }
              });
            }
            setTimeout(() => {
              this.showProgressModal = false;
            }, 500);
          }
          // For creation mode, redirect to audit page
          else if (this.progressMode === 'creation') {
            if (data.result && data.result.redirect_url) {
              setTimeout(() => {
                window.location.href = data.result.redirect_url;
              }, 500);
            }
          }
        }

        // Handle errors
        if (data.stage === 'error') {
          this.progressError = data.message;
          this.stopProgressPolling();
          if (this.progressMode === 'preview') {
            this.updating = false;
          } else {
            this.creating = false;
          }
        }

        // Handle cancellation
        if (data.cancelled || data.stage === 'cancelled') {
          this.progressMessage = 'Cancelled';
          this.progressStage = 'cancelled';
          this.stopProgressPolling();
          if (this.progressMode === 'preview') {
            this.updating = false;
          } else {
            this.creating = false;
          }
        }

      } catch (error) {
        console.error('Progress poll error:', error);
        this.progressError = 'Failed to fetch progress';
        this.stopProgressPolling();
      }
    },

    stopProgressPolling() {
      if (this.progressPollInterval) {
        clearInterval(this.progressPollInterval);
        this.progressPollInterval = null;
      }
    },

    async cancelProgress() {
      if (this.progressStage === 'complete' || this.progressStage === 'error' || this.progressStage === 'cancelled') {
        this.showProgressModal = false;
        if (this.progressMode === 'preview') {
          this.updating = false;
        } else {
          this.creating = false;
        }
        return;
      }

      if (this.progressTaskId) {
        try {
          await fetch(`{% url "audit:audit_progress" %}?task_id=${this.progressTaskId}`, {
            method: 'DELETE',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
          });
        } catch (error) {
          console.error('Cancel error:', error);
        }
      }

      this.stopProgressPolling();
      this.showProgressModal = false;
      if (this.progressMode === 'preview') {
        this.updating = false;
      } else {
        this.creating = false;
      }
    },

    // Create audit session - synchronous API call
    async createAuditSession() {
      if (!this.selectedOpportunities.length || !this.isAuditCriteriaValid()) {
        alert('Please select opportunities and configure valid audit criteria');
        return;
      }

      this.creating = true;

      try {
        const payload = {
          opportunities: this.selectedOpportunities.map(o => o.id),
          criteria: {
            audit_type: this.auditCriteria.type,
            granularity: this.auditCriteria.granularity,
            sample_percentage: this.auditCriteria.samplePercentage,
            startDate: this.auditCriteria.startDate,
            endDate: this.auditCriteria.endDate,
            countPerFlw: this.auditCriteria.countPerFlw,
            countPerOpp: this.auditCriteria.countPerOpp,
            countAcrossAll: this.auditCriteria.countAcrossAll,
            title: this.auditTitle,
            tag: this.auditTag,
            selected_flw_user_ids: this.selectedFlwUserIds  // Include FLW selections
          }
        };

        const response = await fetch('{% url "audit:create_session" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!data.success) {
          alert(data.error || 'Failed to create audit session');
          this.creating = false;
          return;
        }

        // Redirect to the audit session page
        window.location.href = data.redirect_url;

      } catch (error) {
        console.error('Creation error:', error);
        alert('Failed to create audit session. Please try again.');
        this.creating = false;
      }
    },

    // Apply quick params from URL
    applyQuickParams() {
      if (!this.quickParams || Object.keys(this.quickParams).length === 0) {
        return false;
      }

      const params = this.quickParams;

      // Apply audit type
      if (params.audit_type) {
        this.auditCriteria.type = params.audit_type;
      }

      // Apply granularity
      if (params.granularity) {
        this.auditCriteria.granularity = params.granularity;
      }

      // Apply dates
      if (params.start_date) {
        this.auditCriteria.startDate = params.start_date;
      }
      if (params.end_date) {
        this.auditCriteria.endDate = params.end_date;
      }

      // Apply count for last_n types
      if (params.count) {
        const count = parseInt(params.count, 10);
        if (!isNaN(count)) {
          this.auditCriteria.countPerFlw = count;
          this.auditCriteria.countPerOpp = count;
          this.auditCriteria.countAcrossAll = count;
        }
      }

      // Apply title and tag
      if (params.title) {
        this.auditTitle = params.title;
      }
      if (params.tag) {
        this.auditTag = params.tag;
      }

      // For per_flw granularity with username, we'll filter FLWs after preview
      // Store the username/user_id for later filtering
      if (params.username) {
        this.quickFilterUsername = params.username;
      }
      if (params.user_id) {
        this.quickFilterUserId = params.user_id;
      }

      return params.auto_create === 'true';
    },

    // Initialize
    init() {
      // Set default dates (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);

      this.auditCriteria.endDate = today.toISOString().split('T')[0];
      this.auditCriteria.startDate = thirtyDaysAgo.toISOString().split('T')[0];

      // Load opportunities (local filter, no API call)
      this.searchOpportunities();

      // If a default opportunity is set from labs_context, auto-select it
      if (this.defaultOpportunityId) {
        const defaultOpp = this.searchResults.find(o => o.id === this.defaultOpportunityId);
        if (defaultOpp && !this.selectedOpportunities.some(o => o.id === this.defaultOpportunityId)) {
          this.selectedOpportunities.push(defaultOpp);
        }
      }

      // Apply quick params from URL and check if auto-create is requested
      const shouldAutoCreate = this.applyQuickParams();

      // If auto_create is set and we have valid criteria, trigger creation after a short delay
      if (shouldAutoCreate && this.selectedOpportunities.length > 0 && this.isAuditCriteriaValid()) {
        setTimeout(() => {
          this.createAuditSession();
        }, 500);
      }
    }
  }
}
</script>

{% endblock %}
