{% extends 'base.html' %}
{% load static i18n %}

{% block content %}
{% csrf_token %}
<div class="max-w-7xl mx-auto" x-data="auditCreationPage()">

  <!-- Header -->
  <div class="mb-6">
    <div class="flex items-center justify-between">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Create New Audit Session</h1>
        <p class="text-gray-600">Search and select opportunities, configure audit criteria, and preview FLW counts</p>
      </div>
      <div class="flex gap-3">
        <a href="{% url 'audit:session_list' %}"
           class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
          ‚Üê Back to Sessions
        </a>
      </div>
    </div>
  </div>

  <!-- Step 1: Program Search and Selection -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-brand-deep-purple mb-4">
      <i class="fa-solid fa-search mr-2"></i>
      Step 1: Search and Select Opportunities
    </h2>

    <!-- Search Input -->
    <div class="mb-4">
      <label for="program-search" class="block text-sm font-medium text-gray-700 mb-2">
        Search Opportunities
      </label>
      <div class="relative">
        <input
          type="text"
          id="opportunity-search"
          x-model="searchQuery"
          @input.debounce.300ms="searchOpportunities()"
          placeholder="Search by opportunity name or ID..."
          class="w-full px-4 py-2 border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo"
        >
        <div class="absolute inset-y-0 right-0 flex items-center pr-3">
          <i class="fa-solid fa-search text-gray-400" x-show="!searching"></i>
          <i class="fa-solid fa-spinner fa-spin text-brand-indigo" x-show="searching"></i>
        </div>
      </div>
      <p class="text-xs text-gray-500 mt-1">
        Search by opportunity name or enter a specific opportunity ID
      </p>
    </div>

    <!-- Search Results -->
    <div x-show="searchResults.length > 0 || searchPerformed" class="mb-4">
      <div class="flex items-center justify-between mb-3">
        <h3 class="text-sm font-medium text-gray-700">
          Search Results
          <span x-show="searchResults.length > 0" class="text-brand-indigo">
            (<span x-text="searchResults.length"></span> found)
          </span>
        </h3>
        <div class="flex gap-2">
          <button
            @click="tableExpanded = !tableExpanded"
            x-show="searchResults.length > 0"
            class="text-xs text-gray-500 hover:text-gray-700 flex items-center gap-1">
            <i class="fa-solid" :class="tableExpanded ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
            <span x-text="tableExpanded ? 'Hide Table' : 'Show Table'"></span>
          </button>
          <button
            @click="clearSearch()"
            x-show="searchQuery || searchResults.length > 0"
            class="text-xs text-gray-500 hover:text-gray-700">
            Clear
          </button>
        </div>
      </div>

      <!-- No Results Message -->
      <div x-show="searchPerformed && searchResults.length === 0 && !searching"
           class="text-center py-8 text-gray-500">
        <i class="fa-solid fa-search text-3xl mb-2"></i>
        <p>No opportunities found matching "<span x-text="searchQuery"></span>"</p>
        <p class="text-sm">Try a different search term or opportunity ID</p>
      </div>

      <!-- Selected Opportunities Summary -->
      <div x-show="selectedOpportunities.length > 0" class="mb-4 pb-4 border-b">
        <h3 class="text-sm font-medium text-gray-700 mb-3">
          Selected Opportunities (<span x-text="selectedOpportunities.length"></span>)
        </h3>
        <div class="flex flex-wrap gap-2">
          <template x-for="opportunity in selectedOpportunities" :key="opportunity.id">
            <div class="flex items-center gap-2 px-3 py-1 bg-brand-indigo text-white rounded-full text-sm">
              <span x-text="opportunity.name"></span>
              <button @click="removeOpportunitySelection(opportunity)" class="hover:text-gray-200">
                <i class="fa-solid fa-times"></i>
              </button>
            </div>
          </template>
        </div>
      </div>

      <!-- Results Table -->
      <div x-show="searchResults.length > 0 && tableExpanded" class="overflow-hidden table-container flex flex-col gap-2 mb-1">
        <div class="w-full overflow-x-auto block">
          <table class="base-table">
            <thead>
              <tr>
                <th class="w-12">
                  <span>Select</span>
                </th>
                <th class="w-16">
                  <span>ID</span>
                </th>
                <th class="w-1/4">
                  <span>Opportunity Name</span>
                </th>
                <th class="w-1/6">
                  <span>Organization</span>
                </th>
                <th class="w-1/6">
                  <span>Program</span>
                </th>
                <th class="w-20 text-center">
                  <span>Visits</span>
                </th>
                <th class="w-24">
                  <span>Dates</span>
                </th>
                <th class="w-24">
                  <span>Status</span>
                </th>
              </tr>
            </thead>
            <tbody>
              <template x-for="opportunity in searchResults" :key="opportunity.id">
                <tr class="group hover:bg-gray-50 cursor-pointer"
                    :class="selectedOpportunities.some(o => o.id === opportunity.id) ? 'bg-brand-indigo/5' : ''"
                    @click="toggleOpportunitySelection(opportunity)">
                  <td class="text-center">
                    <input type="checkbox"
                           :checked="selectedOpportunities.some(o => o.id === opportunity.id)"
                           class="h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300 rounded"
                           @click.stop="toggleOpportunitySelection(opportunity)">
                  </td>
                  <td>
                    <span x-text="opportunity.id"></span>
                  </td>
                  <td>
                    <div class="truncate max-w-xs" :title="opportunity.name + (opportunity.description ? ': ' + opportunity.description : '')" x-text="opportunity.name"></div>
                  </td>
                  <td>
                    <span class="truncate block max-w-[150px]" :title="opportunity.organization_name" x-text="opportunity.organization_name"></span>
                  </td>
                  <td>
                    <span class="truncate block max-w-[150px]" :title="opportunity.program_name" x-text="opportunity.program_name || '-'"></span>
                  </td>
                  <td class="text-center">
                    <template x-if="opportunity.visit_count !== undefined">
                      <span class="inline-flex items-center justify-center px-2 py-1 text-sm font-medium rounded bg-blue-50 text-blue-700" x-text="opportunity.visit_count"></span>
                    </template>
                    <template x-if="opportunity.visit_count === undefined">
                      <i class="fa-solid fa-spinner fa-spin text-gray-400"></i>
                    </template>
                  </td>
                  <td>
                    <template x-if="opportunity.start_date">
                      <div>
                        <div x-text="formatDate(opportunity.start_date)"></div>
                        <template x-if="opportunity.end_date">
                          <div class="text-xs text-gray-500">to <span x-text="formatDate(opportunity.end_date)"></span></div>
                        </template>
                      </div>
                    </template>
                  </td>
                  <td>
                    <div class="flex flex-wrap gap-1">
                      <span x-show="opportunity.active" class="inline-flex px-2 py-1 text-xs rounded bg-green-50 text-green-700">
                        Active
                      </span>
                      <span x-show="!opportunity.active" class="inline-flex px-2 py-1 text-xs rounded bg-red-50 text-red-700">
                        Inactive
                      </span>
                      <span x-show="opportunity.is_test" class="inline-flex px-2 py-1 text-xs rounded bg-orange-50 text-orange-700">
                        Test
                      </span>
                    </div>
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 2: Audit Granularity -->
  <div x-show="selectedOpportunities.length > 0" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-brand-deep-purple mb-4">
      <i class="fa-solid fa-layer-group mr-2"></i>
      Step 2: Select Audit Granularity
    </h2>

    <div class="space-y-3">
      <!-- Combined Option -->
      <div class="flex items-start p-4 border border-gray-200 rounded-lg hover:border-brand-indigo transition-colors">
        <input
          type="radio"
          id="granularity-combined"
          name="granularity"
          value="combined"
          x-model="auditCriteria.granularity"
          class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
        >
        <div class="ml-3 flex-1">
          <label for="granularity-combined" class="text-sm font-medium text-gray-700 cursor-pointer">
            One audit for all selected opportunities
          </label>
          <p class="text-xs text-gray-500 mt-1">
            Creates a single audit session combining all FLWs across all selected opportunities. Best for organization-wide quality reviews.
          </p>
        </div>
      </div>

      <!-- Per Opportunity Option -->
      <div class="flex items-start p-4 border border-gray-200 rounded-lg hover:border-brand-indigo transition-colors">
        <input
          type="radio"
          id="granularity-per-opp"
          name="granularity"
          value="per_opp"
          x-model="auditCriteria.granularity"
          class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
        >
        <div class="ml-3 flex-1">
          <label for="granularity-per-opp" class="text-sm font-medium text-gray-700 cursor-pointer">
            One audit per opportunity
          </label>
          <p class="text-xs text-gray-500 mt-1">
            Creates <span x-text="selectedOpportunities.length"></span> separate audit session(s), one for each opportunity. Best for comparing performance across different programs.
          </p>
        </div>
      </div>

      <!-- Per FLW Option -->
      <div class="flex items-start p-4 border border-gray-200 rounded-lg hover:border-brand-indigo transition-colors">
        <input
          type="radio"
          id="granularity-per-flw"
          name="granularity"
          value="per_flw"
          x-model="auditCriteria.granularity"
          class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
        >
        <div class="ml-3 flex-1">
          <label for="granularity-per-flw" class="text-sm font-medium text-gray-700 cursor-pointer">
            One audit per FLW
          </label>
          <p class="text-xs text-gray-500 mt-1">
            Creates separate audit sessions for each field worker across all opportunities. Best for individual performance reviews and coaching.
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 3: Audit Criteria -->
  <div x-show="selectedOpportunities.length > 0" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-brand-deep-purple mb-4">
      <i class="fa-solid fa-cog mr-2"></i>
      Step 3: Configure Audit Criteria
    </h2>

    <!-- Audit Type Selection -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-3">
        Select Audit Type
      </label>
      <div class="space-y-3">
        <!-- Date Range Option -->
        <div class="flex items-start">
          <input
            type="radio"
            id="audit-type-date-range"
            name="audit-type"
            value="date_range"
            x-model="auditCriteria.type"
            class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
          >
          <div class="ml-3 flex-1">
            <label for="audit-type-date-range" class="text-sm font-medium text-gray-700 cursor-pointer">
              Date Range
            </label>
            <p class="text-xs text-gray-500">
              Audit all visits within a specific date range
            </p>

            <!-- Date Range Inputs -->
            <div x-show="auditCriteria.type === 'date_range'" class="mt-3 grid grid-cols-2 gap-4">
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">Start Date</label>
                <input
                  type="date"
                  x-model="auditCriteria.startDate"
                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo"
                >
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600 mb-1">End Date</label>
                <input
                  type="date"
                  x-model="auditCriteria.endDate"
                  class="w-full px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo"
                >
              </div>
            </div>
          </div>
        </div>

        <!-- Last N per FLW Option -->
        <div class="flex items-start">
          <input
            type="radio"
            id="audit-type-per-flw"
            name="audit-type"
            value="last_n_per_flw"
            x-model="auditCriteria.type"
            class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
          >
          <div class="ml-3 flex-1">
            <label for="audit-type-per-flw" class="text-sm font-medium text-gray-700 cursor-pointer">
              Last N Visits per FLW
            </label>
            <p class="text-xs text-gray-500">
              Audit the most recent N visits for each Field Learning Worker
            </p>

            <!-- Per FLW Count Input -->
            <div x-show="auditCriteria.type === 'last_n_per_flw'" class="mt-3">
              <label class="block text-xs font-medium text-gray-600 mb-1">Number of visits per FLW</label>
              <input
                type="number"
                x-model="auditCriteria.countPerFlw"
                min="1"
                max="1000"
                placeholder="e.g., 100"
                class="w-32 px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo"
              >
            </div>
          </div>
        </div>

        <!-- Last N across Opportunity Option -->
        <div class="flex items-start">
          <input
            type="radio"
            id="audit-type-across-opp"
            name="audit-type"
            value="last_n_across_opp"
            x-model="auditCriteria.type"
            class="mt-1 h-4 w-4 text-brand-indigo focus:ring-brand-indigo border-gray-300"
          >
          <div class="ml-3 flex-1">
            <label for="audit-type-across-opp" class="text-sm font-medium text-gray-700 cursor-pointer">
              Last N Visits across Opportunity
            </label>
            <p class="text-xs text-gray-500">
              Audit the most recent N visits across the entire opportunity, regardless of FLW
            </p>

            <!-- Across Opportunity Count Input -->
            <div x-show="auditCriteria.type === 'last_n_across_opp'" class="mt-3">
              <label class="block text-xs font-medium text-gray-600 mb-1">Total number of visits</label>
              <input
                type="number"
                x-model="auditCriteria.countAcrossOpp"
                min="1"
                max="10000"
                placeholder="e.g., 500"
                class="w-32 px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-brand-indigo focus:border-brand-indigo"
              >
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Update Preview Button -->
    <div class="flex justify-center">
            <button
        @click="updatePreview()"
        :disabled="!isAuditCriteriaValid() || updating"
        class="px-6 py-2 bg-brand-indigo text-white rounded-md hover:bg-brand-indigo/90 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2">
        <i class="fa-solid fa-refresh" :class="{'fa-spin': updating}"></i>
        <span x-text="updating ? 'Updating...' : 'Update Preview'"></span>
            </button>
    </div>
  </div>

  <!-- Step 4: Preview Results -->
  <div x-show="previewResults.length > 0" class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
    <h2 class="text-lg font-semibold text-brand-deep-purple mb-4">
      <i class="fa-solid fa-eye mr-2"></i>
      Step 4: Preview Audit Scope
    </h2>

    <div class="space-y-6">
      <template x-for="result in previewResults" :key="result.opportunity_id">
        <div class="border border-gray-200 rounded-lg">
          <!-- Opportunity Header -->
          <div class="bg-gray-50 px-4 py-3 border-b border-gray-200 rounded-t-lg">
            <div class="flex items-center justify-between">
              <h3 class="font-medium text-brand-deep-purple" x-text="result.opportunity_name"></h3>
              <span class="text-sm text-gray-500">ID: <span x-text="result.opportunity_id"></span></span>
            </div>
            <div class="mt-2 flex items-center gap-6 text-sm">
              <span class="text-blue-600">
                <i class="fa-solid fa-users mr-1"></i>
                <span x-text="result.total_flws"></span> FLWs
              </span>
              <span class="text-green-600">
                <i class="fa-solid fa-chart-line mr-1"></i>
                <span x-text="result.total_visits"></span> Total Visits
              </span>
              <span class="text-purple-600">
                <i class="fa-solid fa-calculator mr-1"></i>
                <span x-text="result.avg_visits_per_flw"></span> Avg per FLW
              </span>
              <span class="text-gray-500">
                <i class="fa-solid fa-calendar mr-1"></i>
                <span x-text="result.date_range"></span>
              </span>
            </div>
          </div>

          <!-- FLW Details Table -->
          <div class="p-4">
            <template x-if="result.flws && result.flws.length > 0">
              <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                  <thead class="bg-gray-50">
                    <tr>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        FLW Name
                      </th>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Connect ID
                      </th>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Visits in Audit
                      </th>
                      <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Date Range
                      </th>
                    </tr>
                  </thead>
                  <tbody class="bg-white divide-y divide-gray-200">
                    <template x-for="flw in result.flws" :key="flw.connect_id">
                      <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 whitespace-nowrap text-sm font-medium text-gray-900">
                          <span x-text="flw.name"></span>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                          <span x-text="flw.connect_id"></span>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-900">
                          <span x-text="flw.visit_count"></span>
                        </td>
                        <td class="px-4 py-2 whitespace-nowrap text-sm text-gray-500">
                          <template x-if="flw.earliest_visit && flw.latest_visit">
                            <span>
                              <span x-text="formatDate(flw.earliest_visit)"></span> -
                              <span x-text="formatDate(flw.latest_visit)"></span>
                            </span>
                    </template>
                        </td>
                      </tr>
                    </template>
                  </tbody>
                </table>
              </div>
                    </template>

            <!-- Loading state for FLW details -->
            <template x-if="!result.flws">
              <div class="text-center py-4 text-gray-500">
                <i class="fa-solid fa-spinner fa-spin mr-2"></i>
                Loading FLW details...
              </div>
            </template>
          </div>
        </div>
      </template>
    </div>
  </div>

  <!-- Action Buttons -->
  <div x-show="selectedOpportunities.length > 0" class="flex justify-end gap-4">
    <button
      @click="clearAllSelections()"
      class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
      Clear All
    </button>
    <button
      @click="createAuditSession()"
      :disabled="!previewResults.length || creating || updating"
      class="px-4 py-2 bg-brand-indigo text-white rounded-md hover:bg-brand-indigo/90 disabled:bg-gray-300 disabled:cursor-not-allowed flex items-center gap-2">
      <i class="fa-solid fa-plus" :class="{'fa-spin': creating || updating}"></i>
      <span x-text="creating ? 'Creating...' : (updating ? 'Loading...' : 'Create Audit Session')"></span>
    </button>
  </div>

  <!-- Progress Modal -->
  <div x-show="showProgressModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
       x-cloak
       @keydown.escape.window="cancelAuditCreation()">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg" @click.away="">
      <div class="mb-6">
        <h3 class="text-lg font-semibold text-gray-900">Creating Audit Session</h3>
        <p class="text-sm text-gray-600 mt-1" x-text="progressMessage"></p>
      </div>

      <!-- Progress Steps -->
      <div class="space-y-4 mb-6">
        <template x-for="step in progressSteps" :key="step.name">
          <div class="space-y-2">
            <!-- Step Header -->
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2">
                <!-- Status Icon -->
                <span x-show="step.status === 'complete'" class="text-green-600">
                  <i class="fa-solid fa-check-circle"></i>
                </span>
                <span x-show="step.status === 'in_progress'" class="text-brand-indigo">
                  <i class="fa-solid fa-spinner fa-spin"></i>
                </span>
                <span x-show="step.status === 'pending'" class="text-gray-400">
                  <i class="fa-regular fa-circle"></i>
                </span>

                <!-- Step Message -->
                <span class="text-sm font-medium"
                      :class="{
                        'text-green-600': step.status === 'complete',
                        'text-brand-indigo': step.status === 'in_progress',
                        'text-gray-500': step.status === 'pending'
                      }"
                      x-text="step.message"></span>
              </div>

              <!-- Percentage -->
              <span class="text-xs text-gray-500"
                    x-show="step.status !== 'pending'"
                    x-text="`${step.percentage}%`"></span>
            </div>

            <!-- Progress Bar -->
            <div x-show="step.status !== 'pending'" class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
              <div class="h-full transition-all duration-300"
                   :class="{
                     'bg-green-500': step.status === 'complete',
                     'bg-brand-indigo': step.status === 'in_progress'
                   }"
                   :style="`width: ${step.percentage}%`"></div>
            </div>
          </div>
        </template>
      </div>

      <!-- Error Message -->
      <div x-show="progressError" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
        <p class="text-sm text-red-800" x-text="progressError"></p>
      </div>

      <!-- Cancel/Close Button -->
      <div class="flex justify-end gap-3">
        <button
          @click="cancelAuditCreation()"
          :disabled="progressStage === 'complete' || progressStage === 'error'"
          class="px-4 py-2 text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
          <span x-text="progressStage === 'complete' ? 'Close' : 'Cancel'"></span>
        </button>
      </div>
    </div>
  </div>

</div>

<script>
function auditCreationPage() {
  return {
    // Progress tracking state
    showProgressModal: false,
    progressMessage: 'Initializing...',
    progressPercentage: 0,
    progressStage: 'loading',
    progressError: null,
    progressTaskId: null,
    progressPollInterval: null,
    progressSteps: [
      { name: 'opportunities', message: 'Loading opportunities...', percentage: 0, status: 'pending' },
      { name: 'users', message: 'Loading users...', percentage: 0, status: 'pending' },
      { name: 'sessions', message: 'Creating sessions...', percentage: 0, status: 'pending' },
      { name: 'attachments', message: 'Downloading attachments...', percentage: 0, status: 'pending' }
    ],

    // Search state
    searchQuery: '',
    searchResults: [],
    searchPerformed: false,
    searching: false,
    tableExpanded: true,

    // Selection state
    selectedOpportunities: [],

    // Audit criteria state
    auditCriteria: {
      granularity: 'combined',  // 'combined', 'per_opp', 'per_flw'
      type: 'date_range',
      startDate: '',
      endDate: '',
      countPerFlw: 100,
      countAcrossOpp: 500
    },

    // Preview state
    previewResults: [],
    updating: false,
    creating: false,

    // Methods
    async searchOpportunities() {
      if (!this.searchQuery.trim()) {
        this.searchResults = [];
        this.searchPerformed = false;
        return;
      }

      this.searching = true;

      const response = await fetch(`{% url "audit:program_search" %}?q=${encodeURIComponent(this.searchQuery)}&limit=20`);
      const data = await response.json();

      if (data.success) {
        this.searchResults = data.opportunities;
        this.searchPerformed = true;
      } else {
        console.error('Search failed:', data.error);
        this.searchResults = [];
      }

      this.searching = false;
    },

    toggleOpportunitySelection(opportunity) {
      const index = this.selectedOpportunities.findIndex(o => o.id === opportunity.id);
      if (index >= 0) {
        this.selectedOpportunities.splice(index, 1);
      } else {
        this.selectedOpportunities.push(opportunity);
      }
    },

    removeOpportunitySelection(opportunity) {
      const index = this.selectedOpportunities.findIndex(o => o.id === opportunity.id);
      if (index >= 0) {
        this.selectedOpportunities.splice(index, 1);
      }
    },


    clearSearch() {
      this.searchQuery = '';
      this.searchResults = [];
      this.searchPerformed = false;
    },

    clearAllSelections() {
      this.selectedOpportunities = [];
      this.previewResults = [];
    },

    formatDate(dateString) {
      if (!dateString) return '';
      return new Date(dateString).toLocaleDateString();
    },

    // Audit criteria validation
    isAuditCriteriaValid() {
      if (!this.auditCriteria.type) return false;

      switch (this.auditCriteria.type) {
        case 'date_range':
          return this.auditCriteria.startDate && this.auditCriteria.endDate;
        case 'last_n_per_flw':
          return this.auditCriteria.countPerFlw && this.auditCriteria.countPerFlw > 0;
        case 'last_n_across_opp':
          return this.auditCriteria.countAcrossOpp && this.auditCriteria.countAcrossOpp > 0;
        default:
          return false;
      }
    },

    // Update preview with FLW counts
    async updatePreview() {
      if (!this.isAuditCriteriaValid() || this.selectedOpportunities.length === 0) {
        return;
      }

      this.updating = true;
      this.previewResults = [];

      const payload = {
        opportunities: this.selectedOpportunities.map(o => o.id),
        criteria: this.auditCriteria
      };

      const response = await fetch('{% url "audit:preview_audit" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify(payload)
      });

      const data = await response.json();

      if (data.success) {
        this.previewResults = data.results;
      } else {
        console.error('Preview failed:', data.error);
        alert('Failed to generate preview: ' + (data.error || 'Unknown error'));
      }

      this.updating = false;
    },

    // Poll for progress updates
    async pollProgress() {
      if (!this.progressTaskId) return;

      try {
        const response = await fetch(`{% url "audit:audit_progress" %}?task_id=${this.progressTaskId}`);
        const data = await response.json();

        if (data.error) {
          this.progressError = data.error;
          this.progressStage = 'error';
          this.stopProgressPolling();
          return;
        }

        this.progressMessage = data.message || 'Processing...';
        this.progressPercentage = data.percentage || 0;
        this.progressStage = data.stage || 'processing';

        // Update individual steps
        if (data.steps && Array.isArray(data.steps)) {
          data.steps.forEach(dataStep => {
            const step = this.progressSteps.find(s => s.name === dataStep.name);
            if (step) {
              step.message = dataStep.message;
              step.percentage = dataStep.percentage;
              step.status = dataStep.status;
            }
          });
        }

        // Handle completion
        if (data.stage === 'complete') {
          this.stopProgressPolling();
          if (data.result && data.result.redirect_url) {
            setTimeout(() => {
              window.location.href = data.result.redirect_url;
            }, 500);
          }
        }

        // Handle errors
        if (data.stage === 'error') {
          this.progressError = data.message;
          this.stopProgressPolling();
        }

        // Handle cancellation
        if (data.cancelled || data.stage === 'cancelled') {
          this.progressMessage = 'Cancelled';
          this.progressStage = 'cancelled';
          this.stopProgressPolling();
        }

      } catch (error) {
        console.error('Progress poll error:', error);
        this.progressError = 'Failed to fetch progress';
        this.stopProgressPolling();
      }
    },

    stopProgressPolling() {
      if (this.progressPollInterval) {
        clearInterval(this.progressPollInterval);
        this.progressPollInterval = null;
      }
    },

    async cancelAuditCreation() {
      if (this.progressStage === 'complete' || this.progressStage === 'error' || this.progressStage === 'cancelled') {
        this.showProgressModal = false;
        this.creating = false;
        return;
      }

      if (this.progressTaskId) {
        try {
          await fetch(`{% url "audit:audit_progress" %}?task_id=${this.progressTaskId}`, {
            method: 'DELETE',
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
          });
        } catch (error) {
          console.error('Cancel error:', error);
        }
      }

      this.stopProgressPolling();
      this.showProgressModal = false;
      this.creating = false;
    },

    // Create audit session with progress tracking
    async createAuditSession() {
      if (!this.previewResults.length) {
        return;
      }

      this.creating = true;
      this.progressError = null;
      this.progressPercentage = 0;
      this.progressMessage = 'Initializing...';
      this.progressStage = 'loading';
      // Reset all steps to pending
      this.progressSteps.forEach(step => {
        step.percentage = 0;
        step.status = 'pending';
      });
      this.showProgressModal = true;

      try {
        const payload = {
          opportunities: this.selectedOpportunities.map(o => o.id),
          criteria: this.auditCriteria,
          preview: this.previewResults
        };

        // Start the audit creation in background thread
        const response = await fetch('{% url "audit:create_session" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
          },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!data.success || !data.task_id) {
          this.progressError = data.error || 'Failed to start audit creation';
          this.progressStage = 'error';
          return;
        }

        this.progressTaskId = data.task_id;

        // Start polling for progress
        this.progressPollInterval = setInterval(() => this.pollProgress(), 500);

      } catch (error) {
        console.error('Creation error:', error);
        this.progressError = 'Failed to create audit session. Please try again.';
        this.progressStage = 'error';
        this.stopProgressPolling();
      }
    },

    // Initialize
    init() {
      // Set default dates (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date(today);
      thirtyDaysAgo.setDate(today.getDate() - 30);

      this.auditCriteria.endDate = today.toISOString().split('T')[0];
      this.auditCriteria.startDate = thirtyDaysAgo.toISOString().split('T')[0];

      // Load some initial opportunities
      this.searchOpportunities();
    }
  }
}
</script>

{% endblock %}
