{% extends 'base.html' %}
{% load static i18n %}

{% block content %}
<div class="max-w-full mx-auto px-4" x-data="bulkAssessmentInterface()"
     @update-assessment="handleAssessmentUpdate($event.detail)"
     @save-notes="handleNotesUpdate($event.detail)">
  <!-- Header and Controls -->
  <div class="flex gap-4 h-32 items-center p-4 profile-bg bg-brand-indigo rounded-2xl mb-4">
    <!-- Session Info -->
    <div class="flex flex-col justify-center text-white min-w-0 flex-shrink-0" style="width: 300px;">
      <h1 class="text-xl font-bold mb-1">Bulk Assessment</h1>
      <p class="text-sm opacity-90 truncate"
         x-text="(bulkPrimaryUsername || bulkOpportunityName) ? [bulkPrimaryUsername, bulkOpportunityName].filter(Boolean).join(' - ') : (loading ? 'Loading...' : 'N/A')"></p>
      <p class="text-xs opacity-75"
         x-text="(bulkStartDate && bulkEndDate) ? bulkStartDate + ' to ' + bulkEndDate : (loading ? 'Loading...' : '')"></p>
      <div class="flex gap-2 mt-2">
        <a href="{% url 'audit:session_detail' session.pk %}"
           class="px-2 py-1 text-xs bg-white/20 hover:bg-white/30 text-white rounded transition-colors">
          ← Back to Session
        </a>
      </div>
    </div>

    <!-- Statistics Cards -->
    <div class="w-full h-full bg-white/10 text-white relative flex flex-col justify-between p-4 rounded-lg">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-medium" x-text="loading ? '…' : stats.total"></div>
        <div class="hidden lg:block"><i class="fa-solid fa-images text-xl"></i></div>
      </div>
      <div class="pt-4 text-sm flex items-center justify-between">
        <span>Total Assessments</span>
      </div>
    </div>

    <div class="w-full h-full bg-white/10 text-white relative flex flex-col justify-between p-4 rounded-lg">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-medium" x-text="loading ? '…' : stats.pending"></div>
        <div class="hidden lg:block"><i class="fa-solid fa-clock text-xl"></i></div>
      </div>
      <div class="pt-4 text-sm flex items-center justify-between">
        <span>Pending</span>
      </div>
    </div>

    <div class="w-full h-full bg-white/10 text-white relative flex flex-col justify-between p-4 rounded-lg">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-medium" :class="loading ? 'text-white/70' : 'text-green-300'" x-text="loading ? '…' : stats.pass"></div>
        <div class="hidden lg:block"><i class="fa-solid fa-check text-xl"></i></div>
      </div>
      <div class="pt-4 text-sm flex items-center justify-between">
        <span>Passed</span>
      </div>
    </div>

    <div class="w-full h-full bg-white/10 text-white relative flex flex-col justify-between p-4 rounded-lg">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-medium" :class="loading ? 'text-white/70' : 'text-red-300'" x-text="loading ? '…' : stats.fail"></div>
        <div class="hidden lg:block"><i class="fa-solid fa-times text-xl"></i></div>
      </div>
      <div class="pt-4 text-sm flex items-center justify-between">
        <span>Failed</span>
      </div>
    </div>
  </div>

  <div class="mb-4 p-4 bg-blue-50 border border-blue-200 rounded-lg flex items-center justify-between"
       x-show="loading">
    <div class="flex items-center gap-2 text-blue-700">
      <i class="fa-solid fa-spinner fa-spin"></i>
      <span>Loading bulk assessment data...</span>
    </div>
    <button @click="cancelLoading"
            x-show="controller"
            class="px-3 py-2 text-sm font-medium text-blue-700 border border-blue-300 rounded hover:bg-blue-100 transition-colors">
      Cancel
    </button>
  </div>

  <div class="mb-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg flex items-center justify-between"
       x-show="loadCancelled">
    <div class="text-sm text-yellow-800">
      Data load cancelled.
    </div>
    <div class="flex gap-2">
      <button @click="resumeLoading"
              class="px-3 py-2 text-sm font-medium text-yellow-800 border border-yellow-300 rounded hover:bg-yellow-100 transition-colors">
        Resume
      </button>
    </div>
  </div>

  <div class="mb-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center justify-between"
       x-show="loadError">
    <div class="text-sm text-red-800" x-text="loadError"></div>
    <button @click="resumeLoading"
            class="px-3 py-2 text-sm font-medium text-red-800 border border-red-300 rounded hover:bg-red-100 transition-colors">
      Retry
    </button>
  </div>

  <!-- Filters and Controls -->
  <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
    <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}">
    <div class="flex flex-wrap gap-4 items-center justify-between">
      <div class="flex flex-wrap gap-4 items-center">
        <div>
          <label for="question-id-filter" class="block text-sm font-medium text-gray-700 mb-1">Assessment Type</label>
          <select id="question-id-filter"
                  x-model="selectedQuestionId"
                  @change="applyFilters()"
                  :disabled="loading"
                  class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-brand-indigo focus:border-brand-indigo disabled:bg-gray-100">
            <option value="">All Types</option>
            <template x-for="questionId in questionIds" :key="questionId">
              <option :value="questionId" x-text="questionId"></option>
            </template>
          </select>
        </div>
        <div>
          <label for="status-filter" class="block text-sm font-medium text-gray-700 mb-1">Status</label>
          <select id="status-filter"
                  x-model="selectedStatus"
                  @change="applyFilters()"
                  :disabled="loading"
                  class="border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-brand-indigo focus:border-brand-indigo disabled:bg-gray-100">
            <option value="all">All</option>
            <option value="pending">Pending</option>
            <option value="pass">Passed</option>
            <option value="fail">Failed</option>
          </select>
        </div>
        <div class="text-sm text-gray-600">
          <template x-if="loading">
            <span>Loading assessments…</span>
          </template>
          <template x-if="loadCancelled">
            <span>Load cancelled.</span>
          </template>
          <template x-if="loadError">
            <span class="text-red-600" x-text="loadError"></span>
          </template>
          <template x-if="!loading && !loadCancelled && !loadError">
            <span>Showing <span class="font-semibold" x-text="assessments.length"></span> assessment(s)</span>
          </template>
        </div>
        <div class="flex items-center gap-2">
          <label for="widget-size" class="text-sm font-medium text-gray-700 whitespace-nowrap">Size:</label>
          <input type="range"
                 id="widget-size"
                 x-model="widgetSize"
                 @input="updateWidgetSize()"
                 min="200"
                 max="600"
                 step="50"
                 class="w-24">
          <span class="text-sm text-gray-600 w-12" x-text="widgetSize + 'px'"></span>
        </div>
      </div>
      <div class="flex gap-2 items-center flex-wrap">
        <button @click="passAllPending()"
                :disabled="loading || bulkProcessing"
                class="px-3 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors text-sm font-medium disabled:opacity-50">
          <i class="fa-solid fa-check mr-1"></i>Pass All Pending
        </button>
        <button @click="failAllPending()"
                :disabled="loading || bulkProcessing"
                class="px-3 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors text-sm font-medium disabled:opacity-50">
          <i class="fa-solid fa-times mr-1"></i>Fail All Pending
        </button>
        <button @click="clearAllAssessments()"
                :disabled="loading || bulkProcessing"
                class="px-3 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors text-sm font-medium disabled:opacity-50">
          <i class="fa-solid fa-eraser mr-1"></i>Clear All Assessments
        </button>
      </div>
    </div>
  </div>

  <!-- Assessment Grid -->
  <template x-if="!loading && !loadCancelled && !loadError">
    <div class="grid gap-4 mb-8"
         :style="`grid-template-columns: repeat(auto-fill, minmax(${widgetSize}px, 1fr))`">
      <template x-if="assessments.length === 0">
        <div class="col-span-full text-center py-12 text-gray-500">
          <i class="fa-solid fa-images text-4xl mb-4"></i>
          <p>No assessments match the current filters.</p>
        </div>
      </template>
      <template x-for="assessment in assessments" :key="assessment.id">
        <div class="assessment-widget bg-white rounded-lg shadow-sm border-2 hover:shadow-md transition-shadow"
             :class="{
               'border-green-500': assessment.result === 'pass',
               'border-red-500': assessment.result === 'fail',
               'border-gray-200': !assessment.result
             }"
             x-data="{
               assessmentId: assessment.id,
               visitId: assessment.visit_id,
               blobId: assessment.blob_id,
               questionId: assessment.question_id || '',
               result: assessment.result || '',
               notes: assessment.notes || '',
               saving: false,
               updateResult(newResult) {
                 if (this.saving) return;
                 this.$dispatch('update-assessment', {
                   visitId: this.visitId,
                   blobId: this.blobId,
                   questionId: this.questionId,
                   result: newResult,
                   notes: this.notes,
                   callback: (normalized) => { this.result = normalized; }
                 });
               },
               saveNotes() {
                 if (this.saving) return;
                 this.$dispatch('save-notes', {
                   visitId: this.visitId,
                   blobId: this.blobId,
                   questionId: this.questionId,
                   result: this.result,
                   notes: this.notes
                 });
               },
               handleKeydown(event, currentId) {
                 if (this.assessmentId !== currentId || event.target.tagName === 'TEXTAREA') return;
                 if (event.key === 'p' || event.key === 'P') {
                   event.preventDefault();
                   this.updateResult('pass');
                 } else if (event.key === 'f' || event.key === 'F') {
                   event.preventDefault();
                   this.updateResult('fail');
                 }
               }
             }"
             @keydown.window="handleKeydown($event, assessment.id)">
          <div class="relative bg-gray-100"
               :style="`height: ${widgetSize}px`">
            <img :src="assessment.image_url"
                 alt="Assessment image"
                 class="w-full h-full object-contain"
                 loading="lazy">
            <div class="absolute top-2 right-2"
                 x-show="result"
                 x-transition>
              <span class="px-2 py-1 rounded text-xs font-bold text-white"
                    :class="{
                      'bg-green-600': result === 'pass',
                      'bg-red-600': result === 'fail'
                    }">
                <span x-show="result === 'pass'"><i class="fa-solid fa-check mr-1"></i>PASS</span>
                <span x-show="result === 'fail'"><i class="fa-solid fa-times mr-1"></i>FAIL</span>
              </span>
            </div>
          </div>
          <div class="p-3">
            <div class="text-xs text-gray-600 mb-2">
              <div class="truncate">
                <i class="fa-solid fa-calendar mr-1"></i><span x-text="assessment.visit_date"></span>
              </div>
              <div class="truncate">
                <i class="fa-solid fa-map-marker-alt mr-1"></i><span x-text="assessment.entity_name || 'No Entity'"></span>
              </div>
              <div class="truncate" x-show="assessment.question_id">
                <i class="fa-solid fa-tag mr-1"></i><span x-text="assessment.question_id"></span>
              </div>
            </div>
            <div class="flex gap-2 mb-2">
              <button @click="updateResult(result === 'pass' ? '' : 'pass')"
                      :disabled="saving"
                      :class="{
                        'bg-green-600 text-white': result === 'pass',
                        'bg-gray-100 text-gray-700 hover:bg-green-50': result !== 'pass'
                      }"
                      class="flex-1 py-2 px-3 rounded text-sm font-medium transition-colors disabled:opacity-50">
                <i class="fa-solid fa-check mr-1"></i>Pass
              </button>
              <button @click="updateResult(result === 'fail' ? '' : 'fail')"
                      :disabled="saving"
                      :class="{
                        'bg-red-600 text-white': result === 'fail',
                        'bg-gray-100 text-gray-700 hover:bg-red-50': result !== 'fail'
                      }"
                      class="flex-1 py-2 px-3 rounded text-sm font-medium transition-colors disabled:opacity-50">
                <i class="fa-solid fa-times mr-1"></i>Fail
              </button>
            </div>
            <div x-data="{ showNotes: false }">
              <button @click="showNotes = !showNotes"
                      class="text-xs text-brand-indigo hover:text-brand-deep-purple mb-1">
                <i class="fa-solid fa-sticky-note mr-1"></i>
                <span x-text="showNotes ? 'Hide Notes' : 'Add Notes'"></span>
              </button>
              <div x-show="showNotes"
                   x-transition
                   class="mt-1">
                <textarea x-model="notes"
                          @blur="saveNotes()"
                          :disabled="saving"
                          placeholder="Enter notes..."
                          class="w-full border border-gray-300 rounded px-2 py-1 text-sm resize-none disabled:opacity-50"
                          rows="2"></textarea>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>
  </template>

  <!-- Visit Summary Table -->
  <template x-if="!loading && !loadCancelled && !loadError && visitSummaries.length > 0">
    <div class="bg-white rounded-lg shadow-sm p-4 mb-4">
      <h2 class="text-lg font-bold text-gray-900 mb-4">
        <i class="fa-solid fa-list-check mr-2 text-brand-indigo"></i>Visit-Level Summary
      </h2>
      <div class="overflow-x-auto">
        <table class="table table-bordered mb-0 w-full text-sm">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-4 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider">Visit</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">Assessments</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">Passed</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">Failed</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">Pending</th>
              <th class="px-4 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider">Result</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            <template x-for="visit in visitSummaries" :key="visit.visit_id">
              <tr>
                <td class="px-4 py-3">
                  <div class="text-sm font-medium text-gray-900" x-text="visit.username"></div>
                  <div class="text-xs text-gray-500" x-text="visit.visit_date"></div>
                </td>
                <td class="px-4 py-3 text-center">
                  <span class="text-sm font-medium" x-text="visit.total_assessments"></span>
                </td>
                <td class="px-4 py-3 text-center">
                  <span class="text-sm font-medium text-green-600" x-text="visit.passed_count"></span>
                </td>
                <td class="px-4 py-3 text-center">
                  <span class="text-sm font-medium text-red-600" x-text="visit.failed_count"></span>
                </td>
                <td class="px-4 py-3 text-center">
                  <span class="text-sm font-medium text-gray-600" x-text="visit.pending_count"></span>
                </td>
                <td class="px-4 py-3 text-center">
                  <div class="flex gap-2 justify-center">
                    <button @click="setVisitResult(visit.visit_id, 'pass')"
                            :disabled="loading || bulkProcessing"
                            :class="{
                              'bg-green-600 text-white': visitResults[visit.visit_id]?.result === 'pass' || (!visitResults[visit.visit_id]?.result && visit.suggested_result === 'pass'),
                              'bg-green-50 text-green-700 hover:bg-green-100 border border-green-300': visitResults[visit.visit_id]?.result !== 'pass' && (visitResults[visit.visit_id]?.result || visit.suggested_result !== 'pass')
                            }"
                            class="px-3 py-1 rounded text-xs font-medium transition-colors disabled:opacity-50">
                      <i class="fa-solid fa-check mr-1"></i>Pass
                    </button>
                    <button @click="setVisitResult(visit.visit_id, 'fail')"
                            :disabled="loading || bulkProcessing"
                            :class="{
                              'bg-red-600 text-white': visitResults[visit.visit_id]?.result === 'fail' || (!visitResults[visit.visit_id]?.result && visit.suggested_result === 'fail'),
                              'bg-red-50 text-red-700 hover:bg-red-100 border border-red-300': visitResults[visit.visit_id]?.result !== 'fail' && (visitResults[visit.visit_id]?.result || visit.suggested_result !== 'fail')
                            }"
                            class="px-3 py-1 rounded text-xs font-medium transition-colors disabled:opacity-50">
                      <i class="fa-solid fa-times mr-1"></i>Fail
                    </button>
                  </div>
                </td>
              </tr>
            </template>
          </tbody>
        </table>
      </div>
    </div>
  </template>

  <!-- Complete Audit Section -->
  <div class="bg-white rounded-lg shadow-sm mb-4"
       x-show="!loading && !loadCancelled && !loadError">
    <div class="p-6">
      <h2 class="text-xl font-bold text-brand-deep-purple mb-4 flex items-center gap-2">
        <i class="fa-solid fa-flag-checkered"></i>
        Complete Audit
      </h2>

      {% if session.status == 'completed' %}
      <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
        <div class="flex items-center gap-2">
          <i class="fa-solid fa-check-circle text-green-600"></i>
          <span class="text-sm text-green-700">
            Completed on {{ session.completed_at|date:"M d, Y \\a\\t H:i" }}
          </span>
        </div>
      </div>
      {% endif %}

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Overall Result
          </label>
          <div class="flex gap-4">
            <label class="flex items-center cursor-pointer">
              <input type="radio" x-model="overallResult" value="pass" class="mr-2">
              <span class="px-4 py-2 bg-green-100 text-green-800 rounded font-medium">PASS</span>
            </label>
            <label class="flex items-center cursor-pointer">
              <input type="radio" x-model="overallResult" value="fail" class="mr-2">
              <span class="px-4 py-2 bg-red-100 text-red-800 rounded font-medium">FAIL</span>
            </label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Overall Audit Notes
          </label>
          <textarea x-model="completionNotes"
                    placeholder="Enter any additional notes about this audit..."
                    class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-brand-indigo focus:border-transparent"
                    rows="4"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            KPI Notes
          </label>
          <textarea x-model="kpiNotes"
                    placeholder="Enter KPI-related notes or reasons for failure..."
                    class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-brand-indigo focus:border-transparent"
                    rows="3"></textarea>
        </div>

        <div class="flex items-center gap-3">
          <button @click="completeAudit()"
                  :disabled="submittingCompletion"
                  class="px-6 py-3 bg-brand-indigo hover:bg-brand-deep-purple text-white font-bold rounded-lg transition-colors flex items-center gap-2"
                  :class="submittingCompletion ? 'opacity-50 cursor-not-allowed' : ''">
            <i class="fa-solid fa-save"></i>
            <span x-show="!submittingCompletion">Save</span>
            <span x-show="submittingCompletion" class="flex items-center gap-2">
              <i class="fa-solid fa-spinner fa-spin"></i>
              Saving...
            </span>
          </button>
          <span x-show="hasUnsavedChanges" class="text-sm text-orange-600 font-medium">
            <i class="fa-solid fa-exclamation-triangle mr-1"></i>Unsaved changes
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Apply Results Modal -->
  <div x-show="showApplyModal"
       style="display: none;"
       x-transition:enter="ease-out duration-300"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="ease-in duration-200"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0"
       class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50"
       @click.self="showApplyModal = false">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6"
         @click.stop>
      <h3 class="text-lg font-bold text-gray-900 mb-4">
        <i class="fa-solid fa-check-double mr-2 text-brand-indigo"></i>Apply Assessment Results
      </h3>

      <div class="mb-6">
        <p class="text-sm text-gray-600 mb-4">
          This will update visit-level audit results based on assessment results:
        </p>
        <ul class="text-sm text-gray-700 space-y-2 bg-gray-50 p-4 rounded">
          <li><i class="fa-solid fa-circle-xmark text-red-500 mr-2"></i>Visits with any failed assessment will be marked as <strong>FAIL</strong></li>
          <li><i class="fa-solid fa-circle-check text-green-500 mr-2"></i>Visits with all assessments passed will be marked as <strong>PASS</strong></li>
          <li><i class="fa-solid fa-circle text-gray-400 mr-2"></i>Visits with pending assessments will remain unchanged</li>
        </ul>
      </div>

      <div class="flex gap-3">
        <button @click="showApplyModal = false"
                class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
          Cancel
        </button>
        <button @click="applyResults()"
                :disabled="applyingResults"
                class="flex-1 px-4 py-2 bg-brand-indigo text-white rounded-lg hover:bg-brand-deep-purple transition-colors disabled:opacity-50">
          <span x-show="!applyingResults">Apply Results</span>
          <span x-show="applyingResults"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Applying...</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div x-show="showSuccessModal"
       style="display: none;"
       x-transition:enter="ease-out duration-300"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="ease-in duration-200"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0"
       class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50"
       @click.self="showSuccessModal = false">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6"
         @click.stop>
      <div class="text-center">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
          <i class="fa-solid fa-check text-green-600 text-2xl"></i>
        </div>
        <h3 class="text-lg font-bold text-gray-900 mb-2">Results Applied Successfully</h3>
        <p class="text-sm text-gray-600 mb-4" x-text="applyResultMessage"></p>
        <button @click="showSuccessModal = false; window.location.href = '{% url 'audit:session_detail' session.pk %}'"
                class="px-4 py-2 bg-brand-indigo text-white rounded-lg hover:bg-brand-deep-purple transition-colors">
          Return to Session
        </button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block inline_javascript %}
<script>
function bulkAssessmentInterface() {
  return {
    selectedQuestionId: '{{ selected_question_id }}',
    selectedStatus: '{{ selected_status }}',
    widgetSize: 300,
    stats: {
      total: 0,
      pending: 0,
      pass: 0,
      fail: 0,
    },
    saveUrl: '{% url "audit:audit_save" session.pk %}',
    applyResultsUrl: '{% url "audit:apply_assessment_results" session.pk %}',
    completeUrl: '{% url "audit:audit_complete" session.pk %}',
    uncompleteUrl: '{% url "audit:audit_uncomplete" session.pk %}',
    bulkDataUrl: '{{ bulk_data_url }}',
    csrfToken: '',
    loading: true,
    loadCancelled: false,
    loadError: null,
    controller: null,
    bulkProcessing: false,
    hasUnsavedChanges: false,
    saving: false,
    showApplyModal: false,
    showSuccessModal: false,
    applyingResults: false,
    applyResultMessage: '',
    overallResult: '{{ session.overall_result|default:"" }}',
    completionNotes: '{{ session.notes|default:""|escapejs }}',
    kpiNotes: '{{ session.kpi_notes|default:""|escapejs }}',
    submittingCompletion: false,
    allAssessments: [],
    assessments: [],
    questionIds: [],
    bulkPrimaryUsername: '',
    bulkOpportunityName: '',
    bulkStartDate: '',
    bulkEndDate: '',
    visitResults: {},
    init() {
      const savedSize = localStorage.getItem('bulkAssessmentWidgetSize');
      if (savedSize) {
        const parsed = parseInt(savedSize, 10);
        if (!Number.isNaN(parsed)) {
          this.widgetSize = parsed;
        }
      }
      const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
      this.csrfToken = tokenInput ? tokenInput.value : '';
      this.updateUrlParams();
      this.fetchData();

      // Warn user about unsaved changes
      window.addEventListener('beforeunload', (event) => {
        if (this.hasUnsavedChanges) {
          event.preventDefault();
          event.returnValue = '';
        }
      });
    },
    updateUrlParams() {
      const url = new URL(window.location);
      if (this.selectedQuestionId) {
        url.searchParams.set('question_id', this.selectedQuestionId);
      } else {
        url.searchParams.delete('question_id');
      }
      if (this.selectedStatus && this.selectedStatus !== 'all') {
        url.searchParams.set('status', this.selectedStatus);
      } else {
        url.searchParams.delete('status');
      }
      window.history.replaceState({}, '', url);
    },
    async fetchData() {
      if (this.controller) {
        this.controller.abort();
      }
      this.loading = true;
      this.loadCancelled = false;
      this.loadError = null;
      // Fetch ALL data without filters - filtering happens client-side
      const url = new URL(this.bulkDataUrl, window.location.origin);
      this.controller = new AbortController();
      try {
        const response = await fetch(url.toString(), { signal: this.controller.signal });
        const data = await response.json();
        if (!response.ok || data.error) {
          throw new Error(data.error || 'Failed to load bulk assessment data');
        }
        this.bulkPrimaryUsername = data.bulk_primary_username || '';
        this.bulkOpportunityName = data.bulk_opportunity_name || '';
        this.bulkStartDate = data.bulk_start_date || '';
        this.bulkEndDate = data.bulk_end_date || '';
        this.questionIds = data.question_ids || [];
        this.visitResults = data.visit_results || {};
        this.allAssessments = data.assessments || [];
        // Apply filters client-side
        this.applyFiltersClientSide();
        this.recalculateStats();
        this.loading = false;
        this.controller = null;
      } catch (error) {
        if (error.name === 'AbortError') {
          if (!this.loading) {
            this.loadCancelled = true;
          }
        } else {
          console.error('Bulk data load failed:', error);
          this.loadError = error.message || 'Failed to load bulk assessment data.';
        }
        this.loading = false;
        this.controller = null;
      }
    },
    cancelLoading() {
      if (this.controller) {
        this.controller.abort();
      }
      this.loadCancelled = true;
      this.loadError = null;
    },
    resumeLoading() {
      if (this.loading) {
        return;
      }
      this.loadCancelled = false;
      this.loadError = null;
      this.fetchData();
    },
    applyFilters() {
      this.updateUrlParams();
      this.applyFiltersClientSide();
    },
    applyFiltersClientSide() {
      // Filter assessments client-side without making API calls
      this.assessments = this.allAssessments.filter((assessment) => {
        const questionMatch = !this.selectedQuestionId || assessment.question_id === this.selectedQuestionId;
        const statusMatch = this.selectedStatus === 'all' || assessment.status === this.selectedStatus;
        return questionMatch && statusMatch;
      });
      this.recalculateStats();
    },
    updateWidgetSize() {
      localStorage.setItem('bulkAssessmentWidgetSize', this.widgetSize);
    },
    get visitSummaries() {
      const visitMap = {};
      this.allAssessments.forEach((assessment) => {
        const visitId = assessment.visit_id;
        if (!visitMap[visitId]) {
          visitMap[visitId] = {
            visit_id: visitId,
            visit_date: assessment.visit_date,
            visit_date_sort: assessment.visit_date_sort,
            username: assessment.username,
            entity_name: assessment.entity_name,
            assessments: [],
          };
        }
        visitMap[visitId].assessments.push(assessment);
      });
      return Object.values(visitMap)
        .map((visit) => {
          const total = visit.assessments.length;
          const passed = visit.assessments.filter((a) => a.result === 'pass').length;
          const failed = visit.assessments.filter((a) => a.result === 'fail').length;
          const pending = total - passed - failed;
          let suggested = null;
          if (failed > 0) {
            suggested = 'fail';
          } else if (total > 0 && pending === 0) {
            suggested = 'pass';
          }
          return {
            visit_id: visit.visit_id,
            visit_date: visit.visit_date,
            visit_date_sort: visit.visit_date_sort,
            username: visit.username,
            entity_name: visit.entity_name,
            total_assessments: total,
            passed_count: passed,
            failed_count: failed,
            pending_count: pending,
            suggested_result: suggested,
          };
        })
        .sort((a, b) => (a.visit_date_sort || '').localeCompare(b.visit_date_sort || ''));
    },
    recalculateStats() {
      const total = this.allAssessments.length;
      const passCount = this.allAssessments.filter((a) => a.result === 'pass').length;
      const failCount = this.allAssessments.filter((a) => a.result === 'fail').length;
      const pendingCount = total - passCount - failCount;
      this.stats = {
        total,
        pending: pendingCount,
        pass: passCount,
        fail: failCount,
      };
    },
    updateAssessmentLocal(visitId, blobId, questionId, resultValue, notesValue) {
      // Update local visitResults structure
      const visitKey = String(visitId);
      if (!this.visitResults[visitKey]) {
        this.visitResults[visitKey] = { assessments: {} };
      }
      if (!this.visitResults[visitKey].assessments) {
        this.visitResults[visitKey].assessments = {};
      }

      if (resultValue || notesValue) {
        this.visitResults[visitKey].assessments[blobId] = {
          question_id: questionId || '',
          result: resultValue || '',
          notes: notesValue || '',
        };
      } else {
        // Clear assessment if no result or notes
        delete this.visitResults[visitKey].assessments[blobId];
      }

      // Update allAssessments array for UI display
      const assessment = this.allAssessments.find((a) => a.visit_id === visitId && a.blob_id === blobId);
      if (assessment) {
        assessment.result = resultValue || '';
        assessment.notes = notesValue || '';
        assessment.status = resultValue || 'pending';
      }

      // Update filtered assessments array
      const filteredAssessment = this.assessments.find((a) => a.visit_id === visitId && a.blob_id === blobId);
      if (filteredAssessment) {
        filteredAssessment.result = resultValue || '';
        filteredAssessment.notes = notesValue || '';
        filteredAssessment.status = resultValue || 'pending';
      }

      // Force reactivity by reassigning arrays (Alpine doesn't always detect mutations)
      // Skip during bulk processing - we'll do it once at the end
      if (!this.bulkProcessing) {
        this.allAssessments = [...this.allAssessments];
        this.assessments = [...this.assessments];
        this.recalculateStats();
      }
      this.hasUnsavedChanges = true;

      return resultValue || '';
    },
    handleAssessmentUpdate(detail) {
      const normalized = this.updateAssessmentLocal(
        detail.visitId,
        detail.blobId,
        detail.questionId,
        detail.result,
        detail.notes
      );
      if (detail.callback) {
        detail.callback(normalized);
      }
    },
    handleNotesUpdate(detail) {
      this.updateAssessmentLocal(
        detail.visitId,
        detail.blobId,
        detail.questionId,
        detail.result,
        detail.notes
      );
    },
    passAllPending() {
      if (this.loading || this.bulkProcessing) {
        return;
      }
      const pendingAssessments = this.allAssessments.filter((a) => !a.result || a.result === '');
      if (pendingAssessments.length === 0) {
        return;
      }
      this.bulkProcessing = true;
      for (const assessment of pendingAssessments) {
        this.updateAssessmentLocal(
          assessment.visit_id,
          assessment.blob_id,
          assessment.question_id,
          'pass',
          assessment.notes,
        );
      }
      this.bulkProcessing = false;
      // Trigger reactivity once after all updates
      this.allAssessments = [...this.allAssessments];
      this.assessments = [...this.assessments];
      this.recalculateStats();
    },
    failAllPending() {
      if (this.loading || this.bulkProcessing) {
        return;
      }
      const pendingAssessments = this.allAssessments.filter((a) => !a.result || a.result === '');
      if (pendingAssessments.length === 0) {
        return;
      }
      this.bulkProcessing = true;
      for (const assessment of pendingAssessments) {
        this.updateAssessmentLocal(
          assessment.visit_id,
          assessment.blob_id,
          assessment.question_id,
          'fail',
          assessment.notes,
        );
      }
      this.bulkProcessing = false;
      // Trigger reactivity once after all updates
      this.allAssessments = [...this.allAssessments];
      this.assessments = [...this.assessments];
      this.recalculateStats();
    },
    clearAllAssessments() {
      if (this.loading || this.bulkProcessing) {
        return;
      }
      const assessedAssessments = this.allAssessments.filter((a) => a.result && a.result !== '');
      if (assessedAssessments.length === 0) {
        return;
      }
      this.bulkProcessing = true;
      for (const assessment of assessedAssessments) {
        this.updateAssessmentLocal(
          assessment.visit_id,
          assessment.blob_id,
          assessment.question_id,
          '',
          assessment.notes,
        );
      }
      this.bulkProcessing = false;
      // Trigger reactivity once after all updates
      this.allAssessments = [...this.allAssessments];
      this.assessments = [...this.assessments];
      this.recalculateStats();
    },
    setVisitResult(visitId, result) {
      if (this.loading) {
        return;
      }
      const visitKey = String(visitId);
      const currentResult = this.visitResults[visitKey]?.result;
      const newResult = currentResult === result ? '' : result;

      if (!this.visitResults[visitKey]) {
        this.visitResults[visitKey] = { assessments: {} };
      }

      if (newResult) {
        this.visitResults[visitKey].result = newResult;
      } else {
        delete this.visitResults[visitKey].result;
      }

      // Force reactivity for visit results
      this.visitResults = { ...this.visitResults };
      this.hasUnsavedChanges = true;
    },
    async applyResults() {
      if (this.loading) {
        return;
      }
      this.applyingResults = true;
      try {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', this.csrfToken);
        const response = await fetch(this.applyResultsUrl, {
          method: 'POST',
          body: formData,
        });
        const data = await response.json();
        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Failed to apply assessment results');
        }
        this.applyResultMessage = `${data.updated_count} visit(s) updated. ${data.visits_passed} passed, ${data.visits_failed} failed.`;
        this.showApplyModal = false;
        this.showSuccessModal = true;
        await this.fetchData();
      } catch (error) {
        alert('Error applying results: ' + error.message);
      } finally {
        this.applyingResults = false;
      }
    },
    async saveAudit() {
      if (this.saving) return;
      this.saving = true;
      try {
        const formData = new FormData();
        formData.append('visit_results', JSON.stringify(this.visitResults));
        formData.append('csrfmiddlewaretoken', this.csrfToken);
        const response = await fetch(this.saveUrl, {
          method: 'POST',
          body: formData,
        });
        const data = await response.json();
        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Failed to save audit');
        }
        this.hasUnsavedChanges = false;
        alert('Progress saved successfully!');
      } catch (error) {
        alert('Error saving audit: ' + error.message);
        throw error;
      } finally {
        this.saving = false;
      }
    },
    async completeAudit() {
      if (!this.overallResult || this.submittingCompletion) return;
      this.submittingCompletion = true;
      try {
        const formData = new FormData();
        formData.append('visit_results', JSON.stringify(this.visitResults));
        formData.append('overall_result', this.overallResult);
        formData.append('notes', this.completionNotes);
        formData.append('kpi_notes', this.kpiNotes);
        formData.append('csrfmiddlewaretoken', this.csrfToken);
        const response = await fetch(this.completeUrl, {
          method: 'POST',
          body: formData,
        });
        const data = await response.json();
        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Failed to complete audit');
        }
        this.hasUnsavedChanges = false;
        window.location.reload();
      } catch (error) {
        alert('Error completing audit: ' + error.message);
      } finally {
        this.submittingCompletion = false;
      }
    },
    async uncompleteAudit() {
      if (this.submittingCompletion) return;
      if (!confirm('Are you sure you want to reopen this audit? It will be marked as in progress.')) {
        return;
      }
      this.submittingCompletion = true;
      try {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', this.csrfToken);
        const response = await fetch(this.uncompleteUrl, {
          method: 'POST',
          body: formData,
        });
        const data = await response.json();
        if (!response.ok || !data.success) {
          throw new Error(data.error || 'Failed to reopen audit');
        }
        window.location.reload();
      } catch (error) {
        alert('Error reopening audit: ' + error.message);
      } finally {
        this.submittingCompletion = false;
      }
    },
  };
}
</script>
{% endblock %}
