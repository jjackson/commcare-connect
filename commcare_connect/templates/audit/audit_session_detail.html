{% extends 'base.html' %}
{% load static i18n %}

{% block content %}
<div class="max-w-7xl mx-auto" x-data="auditInterface()" @keydown.window="handleKeydown($event)">
  <!-- Integrated Header and Progress Panel - Matching Connect App Style -->
  <div class="flex gap-4 h-32 items-center p-4 profile-bg bg-brand-indigo rounded-2xl mb-4">
    <!-- Session Info Section -->
    <div class="flex flex-col justify-center text-white min-w-0 flex-shrink-0" style="width: 300px;">
      <h1 class="text-xl font-bold mb-1">Audit Session</h1>
      <p class="text-sm opacity-90 truncate">{{ session.flw_username }} • {{ session.opportunity_name }}</p>
      <p class="text-xs opacity-75">{{ session.start_date }} to {{ session.end_date }}</p>
      <div class="flex gap-2 mt-2">
        <a href="{% url 'audit:session_list' %}"
           class="px-2 py-1 text-xs bg-white/20 hover:bg-white/30 text-white rounded transition-colors">
          ← Back
        </a>
        {% if session.status == 'completed' %}
        <a href="{% url 'audit:session_export' session.pk %}"
           class="px-2 py-1 text-xs bg-white/20 hover:bg-white/30 text-white rounded transition-colors">
          Export
        </a>
        {% endif %}
      </div>
    </div>
    <!-- Visit Counter Card -->
    <div class="w-full h-full bg-white/10 text-white relative flex flex-col justify-between p-4 rounded-lg">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-medium" x-text="visitIndex + 1"></div>
        <div class="hidden lg:block">
          <i class="fa-solid fa-file-lines text-xl"></i>
        </div>
      </div>
      <div class="pt-4 text-sm flex items-center justify-between">
        <span>Current Visit</span>
        <span class="text-xs opacity-75">of <span x-text="totalVisits"></span></span>
      </div>
    </div>

    <!-- Progress Card -->
    <div class="w-full h-full bg-white/10 text-white relative flex flex-col justify-between p-4 rounded-lg">
      <div class="flex justify-between items-center">
        <div class="text-2xl font-medium" x-text="progressPercentage + '%'"></div>
        <div class="hidden lg:block">
          <i class="fa-solid fa-chart-line text-xl"></i>
        </div>
      </div>
      <div class="pt-4 text-sm flex items-center justify-between">
        <span>Progress</span>
        <span class="text-xs opacity-75"><span x-text="auditedCount"></span> audited</span>
      </div>
    </div>

    <!-- Shortcuts Card -->
    <div class="w-full h-full bg-white/10 text-white relative flex flex-col justify-between p-4 rounded-lg">
      <div class="flex justify-between items-center">
        <div class="text-lg">
          <kbd class="px-1.5 py-1 bg-white/20 text-white rounded text-xs mr-1">P</kbd>
          <kbd class="px-1.5 py-1 bg-white/20 text-white rounded text-xs mr-1">F</kbd>
          <kbd class="px-1.5 py-1 bg-white/20 text-white rounded text-xs">←→</kbd>
        </div>
        <div class="hidden lg:block">
          <i class="fa-solid fa-keyboard text-xl"></i>
        </div>
      </div>
      <div class="pt-4 text-sm">
        <span>Keyboard Shortcuts</span>
      </div>
    </div>

    <!-- Navigation Controls -->
    <div class="flex flex-col gap-2 h-full justify-center">
      <button @click="navigateToVisit(previousIndex)"
              :disabled="!hasPrevious"
              :class="hasPrevious ? 'px-4 py-2 bg-white/20 hover:bg-white/30 text-white text-sm rounded-lg transition-colors flex items-center gap-2' : 'px-4 py-2 bg-white/10 text-white/50 text-sm rounded-lg cursor-not-allowed flex items-center gap-2'">
        <i class="fa-solid fa-arrow-left"></i>
        Prev
      </button>
      <button @click="navigateToVisit(nextIndex)"
              :disabled="!hasNext"
              :class="hasNext ? 'px-4 py-2 bg-white/20 hover:bg-white/30 text-white text-sm rounded-lg transition-colors flex items-center gap-2' : 'px-4 py-2 bg-white/10 text-white/50 text-sm rounded-lg cursor-not-allowed flex items-center gap-2'">
        Next
        <i class="fa-solid fa-arrow-right"></i>
      </button>
    </div>
  </div>

  {% if current_visit %}
  <!-- Current Visit - Ultra Compact for Rapid Approval -->
  <div class="bg-slate-50 rounded-lg">
    <!-- Top Row: Visit Info + Pass/Fail Buttons -->
    <div class="px-4 py-3 border-b border-gray-200">
        <div class="flex items-center justify-between">
            <!-- Left: Visit Metadata -->
            <div class="flex items-center gap-4 text-sm">
              <span><strong class="text-brand-deep-purple" x-text="currentVisit?.visit_date || '{{ current_visit.visit_date|date:"M d, H:i" }}'"></strong></span>
              <span class="text-brand-blue-light" x-text="currentVisit?.entity_name || '{{ current_visit.entity_name|default:"No Entity" }}'"></span>
              <span class="text-brand-blue-light" x-text="(currentVisit?.location || '{{ current_visit.location|default:"No Location" }}').substring(0, 25) + ((currentVisit?.location || '{{ current_visit.location|default:"No Location" }}').length > 25 ? '...' : '')"></span>
              <span class="text-brand-blue-light" x-text="(currentVisit?.image_count || {{ current_visit.images.count }}) + ' images'"></span>
              <!-- Status Badge -->
              <div x-show="currentVisit?.audit_result?.result || {% if current_visit.audit_result %}true{% else %}false{% endif %}"
                   class="inline-flex items-center px-2 py-1 rounded text-xs font-medium"
                   :class="{
                     'bg-green-100 text-green-800': (currentVisit?.audit_result?.result || '{% if current_visit.audit_result %}{{ current_visit.audit_result.result }}{% endif %}') === 'pass',
                     'bg-red-100 text-red-800': (currentVisit?.audit_result?.result || '{% if current_visit.audit_result %}{{ current_visit.audit_result.result }}{% endif %}') === 'fail'
                   }"
                   x-text="(currentVisit?.audit_result?.result || '{% if current_visit.audit_result %}{{ current_visit.audit_result.result }}{% endif %}').charAt(0).toUpperCase() + (currentVisit?.audit_result?.result || '{% if current_visit.audit_result %}{{ current_visit.audit_result.result }}{% endif %}').slice(1)">
              </div>
              <div x-show="!currentVisit?.audit_result?.result && !{% if current_visit.audit_result %}true{% else %}false{% endif %}"
                   class="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
                Pending
              </div>
          </div>

            <!-- Right: Pass/Fail Buttons -->
            <div class="flex gap-4">
              <button @click="submitResult('pass')"
                      :disabled="submitting"
                      class="w-32 py-3 bg-green-600 hover:bg-green-700 text-white font-bold text-lg rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300"
                      :class="submitting ? 'opacity-50 cursor-not-allowed transform-none' : ''">
                <span x-show="!submitting" class="flex items-center justify-center gap-2">
                  <i class="fa-solid fa-thumbs-up"></i>
                  PASS
                </span>
                <span x-show="submitting" class="flex items-center justify-center gap-2">
                  <i class="fa-solid fa-spinner fa-spin"></i>
                  Saving...
                </span>
              </button>
              <button @click="submitResult('fail')"
                      :disabled="submitting"
                      class="w-32 py-3 text-white font-bold text-lg rounded-lg shadow-lg transition-all duration-200 transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-red-300"
                      style="background-color: #dc2626 !important;"
                      :class="submitting ? 'opacity-50 cursor-not-allowed transform-none' : ''"
                      @mouseenter="$event.target.style.backgroundColor = '#b91c1c'"
                      @mouseleave="$event.target.style.backgroundColor = '#dc2626'">
                <span x-show="!submitting" class="flex items-center justify-center gap-2">
                  <i class="fa-solid fa-thumbs-down"></i>
                  FAIL
              </span>
                <span x-show="submitting" class="flex items-center justify-center gap-2">
                  <i class="fa-solid fa-spinner fa-spin"></i>
                  Saving...
              </span>
              </button>
          </div>
        </div>
      </div>

    <!-- Visit Note -->
    <div class="px-4 pb-3 border-b border-gray-200">
      <div x-data="{ visitNoteOpen: false }">
        <button @click="visitNoteOpen = !visitNoteOpen"
                class="flex items-center gap-2 text-sm text-brand-blue-light hover:text-brand-deep-purple">
          <i class="fas fa-chevron-right transition-transform" :class="visitNoteOpen ? 'rotate-90' : ''"></i>
          Add Visit Note
        </button>
        <div x-show="visitNoteOpen" x-transition class="mt-2">
          <textarea x-model="currentNotes"
                    placeholder="Add notes about this visit..."
                    class="w-full p-2 border border-gray-300 rounded text-sm resize-none"
                    rows="3"></textarea>
        </div>
      </div>
          </div>

    <!-- Images - Side by Side with Resizable Height -->
    {% if current_visit.images.exists %}
    <div class="p-3">
      <!-- Image Size Control -->
      <div class="flex items-center justify-between mb-3">
        <span class="text-xs text-brand-blue-light">Image Size:</span>
        <div class="flex items-center gap-2">
          <span class="text-xs text-brand-blue-light">Small</span>
          <div class="relative w-32 h-2 bg-gray-200 rounded-full cursor-pointer" @click="setImageSizeFromClick($event)">
            <div class="absolute top-0 left-0 h-2 bg-brand-indigo rounded-full transition-all duration-200"
                 :style="`width: ${(imageHeight - 80) / (400 - 80) * 100}%`"></div>
            <div class="absolute top-1/2 transform -translate-y-1/2 w-4 h-4 bg-white border-2 border-brand-indigo rounded-full cursor-grab active:cursor-grabbing shadow-sm"
                 :style="`left: calc(${(imageHeight - 80) / (400 - 80) * 100}% - 8px)`"
                 @mousedown="startDrag($event)"
                 @touchstart="startDrag($event)"></div>
          </div>
          <span class="text-xs text-brand-blue-light">Large</span>
          <span class="text-xs text-brand-deep-purple font-medium" x-text="Math.round(imageHeight) + 'px'"></span>
        </div>
      </div>

          <!-- Images Container -->
          <div class="flex gap-3 overflow-x-auto">
            <!-- Dynamic images from AJAX -->
            <template x-for="(image, index) in (currentVisit?.images || [])" :key="image.blob_id">
              <div class="relative flex-shrink-0">
                <div class="mb-2">
                  <img :src="image.url"
                       :alt="`Visit image ${image.counter}`"
                       class="w-auto object-contain rounded border border-gray-300 shadow-sm transition-all duration-200 cursor-pointer hover:shadow-md"
                       :style="`height: ${imageHeight}px`"
                       @click="openImageModal(image.url)">
                </div>
                <!-- Image Note -->
                <div class="mt-2" x-data="{ imageNoteOpen: false }">
                  <button @click="imageNoteOpen = !imageNoteOpen"
                          class="flex items-center gap-1 text-xs text-brand-blue-light hover:text-brand-deep-purple">
                    <i class="fas fa-chevron-right transition-transform text-xs" :class="imageNoteOpen ? 'rotate-90' : ''"></i>
                    Add Image Note
          </button>
                  <div x-show="imageNoteOpen" x-transition class="mt-1">
                    <textarea x-model="$root.imageNotes[image.blob_id]"
                              placeholder="Add note about this image..."
                              class="w-full p-1 border border-gray-300 rounded text-xs resize-none"
                              rows="2"
                              :style="`width: ${imageHeight}px`"></textarea>
                  </div>
                </div>
        </div>
            </template>

            <!-- Fallback for initial page load -->
            <template x-if="!currentVisit?.images">
              {% for image in current_visit.images.all %}
              <div class="relative flex-shrink-0">
                <div class="mb-2">
                  <img src="{% url 'audit:image' image.blob_id %}"
                       alt="Visit image {{ forloop.counter }}"
                       class="w-auto object-contain rounded border border-gray-300 shadow-sm transition-all duration-200 cursor-pointer hover:shadow-md"
                       :style="`height: ${imageHeight}px`"
                       @click="openImageModal('{% url 'audit:image' image.blob_id %}')">
                </div>
                <!-- Image Note -->
                <div class="mt-2" x-data="{ imageNoteOpen: false }">
                  <button @click="imageNoteOpen = !imageNoteOpen"
                          class="flex items-center gap-1 text-xs text-brand-blue-light hover:text-brand-deep-purple">
                    <i class="fas fa-chevron-right transition-transform text-xs" :class="imageNoteOpen ? 'rotate-90' : ''"></i>
                    Add Image Note
        </button>
                  <div x-show="imageNoteOpen" x-transition class="mt-1">
                    <textarea x-model="$root.imageNotes['{{ image.blob_id }}']"
                              placeholder="Add note about this image..."
                              class="w-full p-1 border border-gray-300 rounded text-xs resize-none"
                              rows="2"
                              :style="`width: ${imageHeight}px`"></textarea>
                  </div>
      </div>
    </div>
    {% endfor %}
            </template>
  </div>
      </div>
    {% endif %}

      </div>


  {% else %}
  <!-- No visits message -->
  <div class="text-center py-12">
    <div class="text-gray-500">
      <i class="fas fa-inbox text-4xl mb-4"></i>
      <h3 class="text-lg font-medium">No visits found</h3>
      <p class="text-sm">No approved visits with images found for this audit session.</p>
    </div>
  </div>
  {% endif %}

  <!-- Audit Completion Section -->
  <div x-show="progressPercentage === 100 || {% if session.status == 'completed' %}true{% else %}false{% endif %}"
       x-transition
       class="mt-6 bg-white rounded-lg shadow-md border border-gray-200">
    <div class="p-6">
      <h2 class="text-xl font-bold text-brand-deep-purple mb-4 flex items-center gap-2">
        <i class="fa-solid fa-flag-checkered"></i>
        Complete Audit
      </h2>

      {% if session.status == 'completed' %}
      <!-- Show completed status -->
      <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4">
        <div class="flex items-center justify-between">
          <div>
            <div class="flex items-center gap-2 mb-2">
              <i class="fa-solid fa-check-circle text-green-600 text-xl"></i>
              <h3 class="text-lg font-semibold text-green-800">Audit Completed</h3>
            </div>
            <p class="text-sm text-green-700">
              Completed on {{ session.completed_at|date:"M d, Y \a\t H:i" }}
            </p>
            {% if session.overall_result %}
            <div class="mt-2">
              <span class="text-sm font-medium text-green-700">Overall Result: </span>
              <span class="inline-flex items-center px-2 py-1 rounded text-xs font-medium
                           {% if session.overall_result == 'pass' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                {{ session.overall_result|upper }}
              </span>
            </div>
            {% endif %}
            {% if session.notes %}
            <div class="mt-3">
              <p class="text-sm font-medium text-green-700 mb-1">Notes:</p>
              <p class="text-sm text-gray-700 bg-white rounded p-2">{{ session.notes }}</p>
            </div>
            {% endif %}
            {% if session.kpi_notes %}
            <div class="mt-3">
              <p class="text-sm font-medium text-green-700 mb-1">KPI Notes:</p>
              <p class="text-sm text-gray-700 bg-white rounded p-2">{{ session.kpi_notes }}</p>
            </div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Reopen button -->
      <button @click="uncompleteAudit()"
              :disabled="submittingCompletion"
              class="px-4 py-2 bg-yellow-600 hover:bg-yellow-700 text-white font-medium rounded-lg transition-colors flex items-center gap-2"
              :class="submittingCompletion ? 'opacity-50 cursor-not-allowed' : ''">
        <i class="fa-solid fa-rotate-left"></i>
        <span x-show="!submittingCompletion">Reopen Audit</span>
        <span x-show="submittingCompletion" class="flex items-center gap-2">
          <i class="fa-solid fa-spinner fa-spin"></i>
          Reopening...
        </span>
      </button>

      {% else %}
      <!-- Completion form -->
      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Overall Result <span class="text-red-500">*</span>
          </label>
          <div class="flex gap-4">
            <label class="flex items-center">
              <input type="radio" x-model="overallResult" value="pass" class="mr-2">
              <span class="px-4 py-2 bg-green-100 text-green-800 rounded font-medium">PASS</span>
            </label>
            <label class="flex items-center">
              <input type="radio" x-model="overallResult" value="fail" class="mr-2">
              <span class="px-4 py-2 bg-red-100 text-red-800 rounded font-medium">FAIL</span>
            </label>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            Overall Audit Notes
          </label>
          <textarea x-model="completionNotes"
                    placeholder="Enter any additional notes about this audit..."
                    class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-brand-indigo focus:border-transparent"
                    rows="4"></textarea>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            KPI Notes
          </label>
          <textarea x-model="kpiNotes"
                    placeholder="Enter KPI-related notes or reasons for failure..."
                    class="w-full p-3 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-brand-indigo focus:border-transparent"
                    rows="3"></textarea>
        </div>

        <button @click="completeAudit()"
                :disabled="!overallResult || submittingCompletion"
                class="px-6 py-3 bg-brand-indigo hover:bg-brand-deep-purple text-white font-bold rounded-lg transition-colors flex items-center gap-2"
                :class="(!overallResult || submittingCompletion) ? 'opacity-50 cursor-not-allowed' : ''">
          <i class="fa-solid fa-check-circle"></i>
          <span x-show="!submittingCompletion">Mark as Complete</span>
          <span x-show="submittingCompletion" class="flex items-center gap-2">
            <i class="fa-solid fa-spinner fa-spin"></i>
            Completing...
          </span>
        </button>

        <p class="text-xs text-gray-500 italic">
          Note: Once marked complete, you can still reopen the audit if needed.
        </p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Image Modal -->
  <div x-show="showImageModal"
       x-transition:enter="transition ease-out duration-300"
       x-transition:enter-start="opacity-0"
       x-transition:enter-end="opacity-100"
       x-transition:leave="transition ease-in duration-200"
       x-transition:leave-start="opacity-100"
       x-transition:leave-end="opacity-0"
       class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75"
       style="display: none;"
       @click="closeImageModal()"
       @keydown.escape="closeImageModal()">
    <div class="relative max-w-full max-h-full p-4">
      <img :src="modalImageSrc"
           alt="Full size image"
           class="max-w-full max-h-full object-contain rounded shadow-2xl"
           @click.stop="">
      <button @click="closeImageModal()"
              class="absolute top-2 right-2 text-white bg-black bg-opacity-50 hover:bg-opacity-75 rounded-full w-8 h-8 flex items-center justify-center text-xl font-bold">
        ×
        </button>
    </div>
  </div>
</div>

<script>
function auditInterface() {
  return {
    // State from Django context
    visitIndex: {{ visit_index }},
    totalVisits: {{ total_visits }},
    auditedCount: {{ audited_count }},
    pendingCount: {{ pending_count }},
    progressPercentage: {{ progress_percentage }},
    hasPrevious: {{ has_previous|yesno:"true,false" }},
    hasNext: {{ has_next|yesno:"true,false" }},
    previousIndex: {{ previous_index }},
    nextIndex: {{ next_index }},

            // Local state
            currentNotes: '{% if current_visit.audit_result %}{{ current_visit.audit_result.notes|escapejs }}{% endif %}',
            submitting: false,

            // Image sizing
            imageHeight: 128, // Default, will be updated in init
            isDragging: false,

            // Image modal
    showImageModal: false,
            modalImageSrc: '',

            // Current visit data (for AJAX updates)
            currentVisit: null,

            // Image notes (keyed by blob_id)
            imageNotes: {},

            // Completion state
            overallResult: '{% if session.overall_result %}{{ session.overall_result }}{% endif %}',
            completionNotes: '',
            kpiNotes: '',
            submittingCompletion: false,

    // Initialize
    init() {
      // Set image height from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const size = urlParams.get('imageSize');
      if (size) {
        this.imageHeight = parseInt(size);
      }

      // Listen for browser back/forward navigation
      window.addEventListener('popstate', (event) => {
        // Get visit index from history state or URL parameter
        let visitIndex;
        if (event.state && event.state.visitIndex !== undefined) {
          visitIndex = event.state.visitIndex;
        } else {
          const urlParams = new URLSearchParams(window.location.search);
          visitIndex = parseInt(urlParams.get('visit') || '0');
        }

        // Get image size from URL
        const urlParams = new URLSearchParams(window.location.search);
        const imageSize = urlParams.get('imageSize');
        if (imageSize) {
          this.imageHeight = parseInt(imageSize);
        }

        // Load the visit data for the new URL
        this.loadVisitData(visitIndex);
      });
    },

            // Methods
            async navigateToVisit(index) {
              if (index >= 0 && index < this.totalVisits) {
                // Update URL without reloading
                const url = new URL(window.location);
                url.searchParams.set('visit', index);
                if (this.imageHeight !== 128) { // Only add if not default
                  url.searchParams.set('imageSize', Math.round(this.imageHeight));
                }
                // Store the visit index in the history state
                window.history.pushState({ visitIndex: index }, '', url.toString());

                // Fetch new visit data via AJAX
                await this.loadVisitData(index);
              }
            },

            async loadVisitData(visitIndex) {
              try {
                const response = await fetch(`{% url "audit:visit_data" session.id %}?visit=${visitIndex}`);
                const data = await response.json();

                // Update all the state with new visit data
                this.visitIndex = data.visit_index;
                this.totalVisits = data.total_visits;
                this.auditedCount = data.audited_count;
                this.pendingCount = data.pending_count;
                this.progressPercentage = data.progress_percentage;
                this.hasPrevious = data.has_previous;
                this.hasNext = data.has_next;
                this.previousIndex = data.previous_index;
                this.nextIndex = data.next_index;

                // Update visit-specific data
                this.currentVisit = data;
                this.currentNotes = data.audit_result ? data.audit_result.notes : '';

                // Load existing image notes or clear for new visit
                this.imageNotes = data.image_notes || {};

                // Close modal if open
                this.closeImageModal();

      } catch (error) {
                console.error('Error loading visit data:', error);
                // Fallback to page reload on error
                const url = new URL(window.location);
                url.searchParams.set('visit', visitIndex);
                if (this.imageHeight !== 128) {
                  url.searchParams.set('imageSize', Math.round(this.imageHeight));
                }
                window.location.href = url.toString();
              }
            },


    updateUrlWithImageSize() {
      const url = new URL(window.location);
      if (this.imageHeight !== 128) { // Only add if not default
        url.searchParams.set('imageSize', Math.round(this.imageHeight));
      } else {
        url.searchParams.delete('imageSize');
      }
      // Update URL without reloading
      window.history.replaceState({}, '', url.toString());
    },

    // Slider functionality
    startDrag(event) {
      event.preventDefault();
      this.isDragging = true;

      const handleMove = (e) => {
        if (!this.isDragging) return;

        const slider = event.target.parentElement;
        const rect = slider.getBoundingClientRect();
        const clientX = e.clientX || (e.touches && e.touches[0].clientX);
        const x = Math.max(0, Math.min(rect.width, clientX - rect.left));
                const percentage = x / rect.width;

                // Map percentage to height range (80px to 400px)
                this.imageHeight = 80 + (percentage * (400 - 80));
        this.updateUrlWithImageSize();
      };

      const handleEnd = () => {
        this.isDragging = false;
        document.removeEventListener('mousemove', handleMove);
        document.removeEventListener('mouseup', handleEnd);
        document.removeEventListener('touchmove', handleMove);
        document.removeEventListener('touchend', handleEnd);
      };

      document.addEventListener('mousemove', handleMove);
      document.addEventListener('mouseup', handleEnd);
      document.addEventListener('touchmove', handleMove);
      document.addEventListener('touchend', handleEnd);
    },

            setImageSizeFromClick(event) {
              if (this.isDragging) return;

              const rect = event.currentTarget.getBoundingClientRect();
              const x = event.clientX - rect.left;
              const percentage = x / rect.width;

              // Map percentage to height range (80px to 400px)
              this.imageHeight = 80 + (percentage * (400 - 80));
              this.updateUrlWithImageSize();
            },

    async submitResult(result) {
      if (this.submitting) return;

      this.submitting = true;

        try {
          const formData = new FormData();
          formData.append('visit_id', this.currentVisit?.visit_id || '{{ current_visit.id }}');
          formData.append('result', result);
          formData.append('notes', this.currentNotes);
          formData.append('current_index', this.visitIndex);
          formData.append('auto_advance', 'true');
          formData.append('image_notes', JSON.stringify(this.imageNotes));
          formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        const response = await fetch('{% url "audit:result_update" session.id %}', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          // Update progress
          this.auditedCount = data.audited_count;
          this.progressPercentage = data.progress_percentage;
          this.pendingCount = data.total_visits - data.audited_count;

                  // Auto-advance if there's a next visit
                  if (data.should_advance) {
                    setTimeout(async () => {
                      await this.navigateToVisit(data.next_index);
                    }, 300); // Faster transition for rapid workflow
                  } else {
                    // Just reload current visit data to show updated status
                    setTimeout(async () => {
                      await this.loadVisitData(this.visitIndex);
                    }, 300);
                  }
        } else {
          alert('Error saving result: ' + data.error);
        }
      } catch (error) {
        alert('Error saving result: ' + error.message);
      } finally {
        this.submitting = false;
      }
            },

            // Image modal functions
            openImageModal(imageSrc) {
              this.modalImageSrc = imageSrc;
              this.showImageModal = true;
            },

            closeImageModal() {
              this.showImageModal = false;
              this.modalImageSrc = '';
            },

            // Keyboard shortcuts for rapid workflow
    handleKeydown(event) {
      // Only handle if not typing in a text field
      if (event.target.tagName === 'TEXTAREA' || event.target.tagName === 'INPUT') return;

      switch(event.key) {
        case 'p':
        case 'P':
        case '1':
          event.preventDefault();
          this.submitResult('pass');
          break;
        case 'f':
        case 'F':
        case '2':
          event.preventDefault();
          this.submitResult('fail');
          break;
        case 'ArrowLeft':
          event.preventDefault();
          if (this.hasPrevious) this.navigateToVisit(this.previousIndex);
          break;
                case 'ArrowRight':
                  event.preventDefault();
                  if (this.hasNext) this.navigateToVisit(this.nextIndex);
                  break;
                case 'Escape':
                  event.preventDefault();
                  if (this.showImageModal) this.closeImageModal();
                  break;
      }
    },

            // Complete audit session
            async completeAudit() {
              if (!this.overallResult || this.submittingCompletion) return;

              this.submittingCompletion = true;

              try {
                const formData = new FormData();
                formData.append('overall_result', this.overallResult);
                formData.append('notes', this.completionNotes);
                formData.append('kpi_notes', this.kpiNotes);
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                const response = await fetch('{% url "audit:session_complete" session.id %}', {
                  method: 'POST',
                  body: formData
                });

                const data = await response.json();

                if (data.success) {
                  // Reload page to show completed status
                  window.location.reload();
                } else {
                  alert('Error completing audit: ' + data.error);
                }
              } catch (error) {
                alert('Error completing audit: ' + error.message);
              } finally {
                this.submittingCompletion = false;
              }
            },

            // Uncomplete (reopen) audit session
            async uncompleteAudit() {
              if (this.submittingCompletion) return;

              if (!confirm('Are you sure you want to reopen this audit? It will be marked as in progress.')) {
                return;
              }

              this.submittingCompletion = true;

              try {
                const formData = new FormData();
                formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

                const response = await fetch('{% url "audit:session_uncomplete" session.id %}', {
                  method: 'POST',
                  body: formData
                });

                const data = await response.json();

                if (data.success) {
                  // Reload page to show in-progress status
                  window.location.reload();
                } else {
                  alert('Error reopening audit: ' + data.error);
                }
              } catch (error) {
                alert('Error reopening audit: ' + error.message);
              } finally {
                this.submittingCompletion = false;
              }
            }
  }
}
</script>
{% endblock %}
