{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="container md:max-w-screen-lg mx-auto flex flex-col gap-6 p-6">
  <div class="flex items-center gap-2">
    <h1 class="text-2xl font-bold text-gray-900">Pydantic AI Demo</h1>
    <span class="text-xs font-semibold bg-blue-100 text-blue-700 px-2 py-1 rounded">EXPERIMENTAL</span>
  </div>

  <!-- React Demo Mount Point -->
  <div id="react-demo-root"></div>

  <div class="bg-white rounded-lg shadow-md p-6">
    <form id="ai-demo-form" class="space-y-4">
      {% csrf_token %}
      <div>
        <label for="prompt" class="block text-sm font-medium text-gray-700 mb-2">
          Enter your prompt:
        </label>
        <textarea
          id="prompt"
          name="prompt"
          rows="4"
          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          placeholder="Type your message here..."
          required
        ></textarea>
      </div>
      <button
        type="submit"
        id="submit-btn"
        class="w-full bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
      >
        Submit
      </button>
    </form>
  </div>

  <!-- Progress/Result Display -->
  <div id="result-container" class="hidden bg-white rounded-lg shadow-md p-6">
    <div id="progress-message" class="text-sm text-gray-600 mb-4"></div>
    <div id="result-content" class="hidden">
      <h3 class="text-lg font-semibold text-gray-900 mb-2">Response:</h3>
      <div id="result-text" class="bg-gray-50 rounded-md p-4 text-gray-800"></div>
    </div>
    <div id="error-content" class="hidden">
      <div class="bg-red-50 border-l-4 border-red-400 p-4">
        <p class="text-red-700" id="error-text"></p>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block javascript %}
  {{ block.super }}
  <script src="{% static 'bundles/js/react-demo-bundle.js' %}" defer></script>
{% endblock javascript %}

{% block inline_javascript %}
<script>
  (function() {
    'use strict';

    const form = document.getElementById('ai-demo-form');
    const submitBtn = document.getElementById('submit-btn');
    const resultContainer = document.getElementById('result-container');
    const progressMessage = document.getElementById('progress-message');
    const resultContent = document.getElementById('result-content');
    const resultText = document.getElementById('result-text');
    const errorContent = document.getElementById('error-content');
    const errorText = document.getElementById('error-text');

    let pollingInterval = null;

    function getCSRFToken() {
      const tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
      return tokenInput ? tokenInput.value : '';
    }

    function stopPolling() {
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
      }
    }

    function pollTaskStatus(taskId) {
      stopPolling();

      pollingInterval = setInterval(async () => {
        try {
          const response = await fetch(`{% url "ai:ai_demo_status" %}?task_id=${taskId}`);
          const data = await response.json();

          if (data.error) {
            stopPolling();
            showError(data.error);
            return;
          }

          if (data.message) {
            progressMessage.textContent = data.message;
          }

          if (data.complete) {
            stopPolling();
            console.log('Task complete, data:', data); // Debug logging
            if (data.result !== undefined && data.result !== null) {
              console.log('Showing result:', data.result); // Debug logging
              showResult(data.result);
            } else if (data.error) {
              showError(data.error);
            } else {
              // Task completed but no result - show the message
              console.log('No result, showing message:', data.message); // Debug logging
              showResult(data.message || 'Task completed');
            }
          }
        } catch (error) {
          console.error('Polling error:', error);
          stopPolling();
          showError('Failed to check task status');
        }
      }, 1000); // Poll every second
    }

    function showResult(result) {
      console.log('showResult called with:', result, typeof result); // Debug logging
      resultContainer.classList.remove('hidden');
      resultContent.classList.remove('hidden');
      errorContent.classList.add('hidden');
      // result is a string from the Celery task
      const resultString = typeof result === 'string' ? result : (result?.message || JSON.stringify(result));
      console.log('Setting result text to:', resultString); // Debug logging
      resultText.textContent = resultString || 'No response received';
      progressMessage.textContent = 'Complete!';
      submitBtn.disabled = false;
    }

    function showError(error) {
      resultContainer.classList.remove('hidden');
      resultContent.classList.add('hidden');
      errorContent.classList.remove('hidden');
      errorText.textContent = error;
      submitBtn.disabled = false;
    }

    function resetForm() {
      resultContainer.classList.add('hidden');
      resultContent.classList.add('hidden');
      errorContent.classList.add('hidden');
      progressMessage.textContent = '';
      resultText.textContent = '';
      errorText.textContent = '';
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const prompt = document.getElementById('prompt').value.trim();
      if (!prompt) {
        return;
      }

      submitBtn.disabled = true;
      resetForm();
      resultContainer.classList.remove('hidden');
      progressMessage.textContent = 'Submitting...';

      try {
        const response = await fetch('{% url "ai:ai_demo_submit" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': getCSRFToken()
          },
          body: new URLSearchParams({
            prompt: prompt
          })
        });

        const data = await response.json();

        if (data.error) {
          showError(data.error);
          return;
        }

        if (data.task_id) {
          progressMessage.textContent = 'Task started, waiting for response...';
          pollTaskStatus(data.task_id);
        }
      } catch (error) {
        console.error('Submit error:', error);
        showError('Failed to submit task');
      }
    });
  })();
</script>
{% endblock %}
