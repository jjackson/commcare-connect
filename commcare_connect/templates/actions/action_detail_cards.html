{% extends 'base.html' %}
{% load static i18n %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-6">
  <!-- Navigation and Prototype Info -->
  <div class="mb-4">
    <div class="flex items-center justify-between">
      <div>
        <a href="{% url 'actions:list' %}" class="text-sm text-brand-indigo hover:text-brand-deep-purple transition-colors">
          <i class="fa-solid fa-arrow-left mr-1"></i> Back to Actions List
        </a>
      </div>
      <div class="flex gap-2">
        <a href="{% url 'actions:detail_timeline' action.id %}"
           class="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded transition-colors">
          <i class="fa-solid fa-stream mr-1"></i> Timeline View
        </a>
        <a href="{% url 'actions:detail_split' action.id %}"
           class="px-3 py-1.5 text-sm bg-gray-100 hover:bg-gray-200 text-gray-700 rounded transition-colors">
          <i class="fa-solid fa-columns mr-1"></i> Split View
        </a>
      </div>
    </div>
    <div class="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
      <div class="flex items-start gap-2">
        <i class="fa-solid fa-info-circle text-green-600 mt-0.5"></i>
        <div>
          <div class="text-sm font-medium text-green-900">Prototype: {{ prototype_name }}</div>
          <div class="text-xs text-green-700">{{ prototype_description }}</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Header -->
  <div class="bg-gradient-to-r from-brand-indigo to-brand-deep-purple rounded-lg shadow-sm p-6 mb-6 text-white">
    <div class="flex items-start justify-between">
      <div>
        <h1 class="text-3xl font-bold mb-2">Action #{{ action.id }}</h1>
        <div class="text-lg opacity-90">{{ action.flw_name }}</div>
        <div class="text-sm opacity-75">{{ action.flw_username }}</div>
      </div>
      <div class="flex flex-col gap-2 items-end">
        {% if action.status == "open" %}
        <span class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium bg-white/20 backdrop-blur">
          <i class="fa-solid fa-folder-open mr-2"></i> Open
        </span>
        {% elif action.status == "nm_review" %}
        <span class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium bg-white/20 backdrop-blur">
          <i class="fa-solid fa-user-check mr-2"></i> NM Review
        </span>
        {% elif action.status == "pm_review" %}
        <span class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium bg-white/20 backdrop-blur">
          <i class="fa-solid fa-clipboard-check mr-2"></i> PM Review
        </span>
        {% elif action.status == "resolved" %}
        <span class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium bg-white/20 backdrop-blur">
          <i class="fa-solid fa-check-circle mr-2"></i> Resolved
        </span>
        {% else %}
        <span class="inline-flex items-center px-4 py-2 rounded-lg text-sm font-medium bg-white/20 backdrop-blur">
          <i class="fa-solid fa-times-circle mr-2"></i> Closed
        </span>
        {% endif %}
        <div class="text-sm opacity-75">Created {{ action.created|date:"M d, Y" }}</div>
      </div>
    </div>
  </div>

  <!-- Card Grid Layout -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

    <!-- Current Status Card -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center gap-2 mb-4">
        <i class="fa-solid fa-info-circle text-brand-indigo text-xl"></i>
        <h2 class="text-lg font-semibold text-gray-900">Current Status</h2>
      </div>

      <div class="space-y-4">
        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span class="text-sm text-gray-600">Status</span>
          <span class="font-medium text-gray-900">{{ action.status|title }}</span>
        </div>

        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span class="text-sm text-gray-600">Priority</span>
          {% if action.priority == "high" %}
          <span class="font-medium text-red-600">
            <i class="fa-solid fa-arrow-up mr-1"></i> High
          </span>
          {% elif action.priority == "medium" %}
          <span class="font-medium text-yellow-600">
            <i class="fa-solid fa-minus mr-1"></i> Medium
          </span>
          {% else %}
          <span class="font-medium text-green-600">
            <i class="fa-solid fa-arrow-down mr-1"></i> Low
          </span>
          {% endif %}
        </div>

        <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
          <span class="text-sm text-gray-600">Action Type</span>
          {% if action.action_type == "warning" %}
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
            <i class="fa-solid fa-exclamation-triangle mr-1"></i> Warning
          </span>
          {% else %}
          <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800">
            <i class="fa-solid fa-ban mr-1"></i> Deactivation
          </span>
          {% endif %}
        </div>

        <div class="pt-4 border-t border-gray-200">
          <button class="w-full px-4 py-2 bg-brand-indigo hover:bg-brand-deep-purple text-white rounded transition-colors text-sm font-medium">
            <i class="fa-solid fa-exchange-alt mr-2"></i> Update Status
          </button>
        </div>
      </div>
    </div>

    <!-- Assignment & Team Card -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center gap-2 mb-4">
        <i class="fa-solid fa-users text-brand-indigo text-xl"></i>
        <h2 class="text-lg font-semibold text-gray-900">Assignment & Team</h2>
      </div>

      <div class="space-y-4">
        <div class="p-3 bg-gray-50 rounded-lg">
          <div class="text-xs text-gray-600 mb-1">Assigned To</div>
          <div class="font-medium text-gray-900">{{ action.assigned_to }}</div>
        </div>

        <div class="p-3 bg-gray-50 rounded-lg">
          <div class="text-xs text-gray-600 mb-1">Created By</div>
          <div class="font-medium text-gray-900">{{ action.created_by }}</div>
        </div>

        <div class="p-3 bg-gray-50 rounded-lg">
          <div class="text-xs text-gray-600 mb-1">Opportunity</div>
          <div class="font-medium text-gray-900">{{ action.opportunity }}</div>
        </div>

        <div class="pt-4 border-t border-gray-200">
          <button class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded transition-colors text-sm font-medium">
            <i class="fa-solid fa-user-plus mr-2"></i> Reassign Action
          </button>
        </div>
      </div>
    </div>

    <!-- Audit Context Card -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center gap-2 mb-4">
        <i class="fa-solid fa-clipboard-list text-brand-indigo text-xl"></i>
        <h2 class="text-lg font-semibold text-gray-900">Audit Context</h2>
      </div>

      <div class="space-y-3">
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-600">Source</span>
          <span class="font-medium text-gray-900">{{ action.source|upper }}</span>
        </div>

        {% if action.audit_session_id %}
        <div class="flex justify-between items-center">
          <span class="text-sm text-gray-600">Audit Session</span>
          <a href="/audit/session/{{ action.audit_session_id }}/"
             class="font-medium text-brand-indigo hover:underline">
            #{{ action.audit_session_id }}
          </a>
        </div>
        {% endif %}

        <div class="mt-4 p-4 bg-red-50 border border-red-200 rounded-lg">
          <div class="flex items-start gap-2">
            <i class="fa-solid fa-exclamation-circle text-red-600 mt-0.5"></i>
            <div class="text-sm text-red-800">
              <div class="font-medium mb-1">Quality Issue Detected</div>
              <div class="text-xs">This action was automatically created due to audit failure. Review the audit session for details.</div>
            </div>
          </div>
        </div>

        <div class="pt-4 border-t border-gray-200">
          <a href="/audit/session/{{ action.audit_session_id }}/"
             class="block w-full px-4 py-2 text-center bg-gray-100 hover:bg-gray-200 text-gray-700 rounded transition-colors text-sm font-medium">
            <i class="fa-solid fa-external-link-alt mr-2"></i> View Audit Session
          </a>
        </div>
      </div>
    </div>

    <!-- FLW History Card -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center gap-2 mb-4">
        <i class="fa-solid fa-history text-brand-indigo text-xl"></i>
        <h2 class="text-lg font-semibold text-gray-900">FLW History</h2>
      </div>

      {% if action.flw_history %}
      <div class="space-y-2">
        {% for history_item in action.flw_history %}
        <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
          <div class="flex justify-between items-start mb-1">
            <span class="text-xs font-medium text-gray-900">#{{ history_item.id }}</span>
            <span class="text-xs text-gray-500">{{ history_item.date|date:"M d, Y" }}</span>
          </div>
          <div class="text-sm text-gray-700 mb-1">{{ history_item.issue }}</div>
          <div class="flex items-center gap-2">
            {% if history_item.action_type == "warning" %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-yellow-100 text-yellow-800">
              Warning
            </span>
            {% else %}
            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-red-100 text-red-800">
              Deactivation
            </span>
            {% endif %}
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
              {{ history_item.status|title }}
            </span>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <div class="text-center py-6 text-gray-500">
        <i class="fa-solid fa-inbox text-2xl mb-2 block text-gray-300"></i>
        <div class="text-sm">No previous actions</div>
      </div>
      {% endif %}

      <div class="pt-4 border-t border-gray-200 mt-4">
        <div class="text-xs text-gray-600">
          Total Previous Actions: <span class="font-medium">{{ action.flw_history|length }}</span>
        </div>
      </div>
    </div>

    <!-- NM Response Card -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center gap-2 mb-4">
        <i class="fa-solid fa-comments text-brand-indigo text-xl"></i>
        <h2 class="text-lg font-semibold text-gray-900">Network Manager Response</h2>
      </div>

      <div class="space-y-3">
        {% if action.status in "nm_review,pm_review,resolved,closed" %}
        <div class="p-3 bg-blue-50 border border-blue-200 rounded-lg">
          <div class="flex items-start gap-2 mb-2">
            <div class="w-8 h-8 rounded-full bg-brand-indigo text-white flex items-center justify-center text-xs font-medium">
              NM
            </div>
            <div class="flex-1">
              <div class="text-xs text-gray-600">{{ action.assigned_to }}</div>
              <div class="text-xs text-gray-500">{{ action.created|timesince }} ago</div>
            </div>
          </div>
          <div class="text-sm text-gray-700 ml-10">
            I've reviewed this case with the FLW. They acknowledged the issue and committed to following proper procedures.
          </div>
        </div>
        {% else %}
        <div class="text-center py-6 text-gray-500">
          <i class="fa-solid fa-clock text-2xl mb-2 block text-gray-300"></i>
          <div class="text-sm">Awaiting Network Manager response</div>
        </div>
        {% endif %}

        <div class="pt-4 border-t border-gray-200">
          <textarea
            class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-brand-indigo focus:border-brand-indigo"
            rows="3"
            placeholder="Add a comment..."></textarea>
          <button class="mt-2 w-full px-4 py-2 bg-brand-indigo hover:bg-brand-deep-purple text-white rounded transition-colors text-sm font-medium">
            <i class="fa-solid fa-paper-plane mr-2"></i> Post Comment
          </button>
        </div>
      </div>
    </div>

    <!-- PM Actions Card -->
    <div class="bg-white rounded-lg shadow-sm p-6">
      <div class="flex items-center gap-2 mb-4">
        <i class="fa-solid fa-tasks text-brand-indigo text-xl"></i>
        <h2 class="text-lg font-semibold text-gray-900">Program Manager Actions</h2>
      </div>

      <div class="space-y-3">
        <button class="w-full px-4 py-2.5 bg-green-100 hover:bg-green-200 text-green-700 rounded transition-colors text-sm font-medium flex items-center justify-center gap-2">
          <i class="fa-solid fa-check-circle"></i> Resolve Action
        </button>

        <button class="w-full px-4 py-2.5 bg-yellow-100 hover:bg-yellow-200 text-yellow-700 rounded transition-colors text-sm font-medium flex items-center justify-center gap-2">
          <i class="fa-solid fa-level-up-alt"></i> Escalate Issue
        </button>

        <button class="w-full px-4 py-2.5 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded transition-colors text-sm font-medium flex items-center justify-center gap-2">
          <i class="fa-solid fa-undo"></i> Reactivate User
        </button>

        <button class="w-full px-4 py-2.5 bg-red-100 hover:bg-red-200 text-red-700 rounded transition-colors text-sm font-medium flex items-center justify-center gap-2">
          <i class="fa-solid fa-times-circle"></i> Close Without Action
        </button>

        <div class="pt-4 border-t border-gray-200 text-xs text-gray-600">
          <div class="mb-2">Quick Actions:</div>
          <div class="space-y-1">
            <div><i class="fa-solid fa-envelope mr-1 text-gray-400"></i> Send follow-up notification</div>
            <div><i class="fa-solid fa-calendar-plus mr-1 text-gray-400"></i> Schedule review meeting</div>
            <div><i class="fa-solid fa-file-export mr-1 text-gray-400"></i> Export action report</div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Notification Details (Full Width) -->
  <div class="bg-white rounded-lg shadow-sm p-6 mt-6">
    <div class="flex items-center gap-2 mb-4">
      <i class="fa-solid fa-envelope text-brand-indigo text-xl"></i>
      <h2 class="text-lg font-semibold text-gray-900">Notification Sent to FLW</h2>
    </div>

    <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
      <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
        <div>
          <span class="text-xs text-gray-600 uppercase">Recipient:</span>
          <div class="font-medium text-gray-900">{{ action.notification.recipient }}</div>
        </div>
        <div>
          <span class="text-xs text-gray-600 uppercase">Sent:</span>
          <div class="font-medium text-gray-900">{{ action.notification.sent_at|date:"M d, Y h:i A" }}</div>
        </div>
      </div>
      <div class="mb-3">
        <span class="text-xs text-gray-600 uppercase">Subject:</span>
        <div class="text-sm font-medium text-gray-900 mt-1">{{ action.notification.subject }}</div>
      </div>
      <div>
        <span class="text-xs text-gray-600 uppercase">Message:</span>
        <div class="text-sm text-gray-700 mt-1 whitespace-pre-line bg-white p-3 rounded border border-gray-200">{{ action.notification.message }}</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
