{% extends "solicitations/public_base.html" %}
{% load static %}
{% load crispy_forms_tags %}


{% block page_title %}Submit Response - {{ solicitation.title }}{% endblock %}

{% block hero_title %}Submit Your Response{% endblock %}

{% block hero_description %}
    {{ solicitation.title }}
{% endblock %}

{% block main_content %}
    <!-- Breadcrumb Navigation -->
    {% include 'components/breadcrumbs.html' with path=path %}

    <!-- Response Form -->
    <div class="max-w-4xl mx-auto">
        <div class="bg-white rounded-xl shadow-sm p-8 mb-8">
            <div class="mb-8">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-2xl font-semibold text-brand-deep-purple mb-2">
                            {% if is_editing_draft %}
                                <i class="fa-solid fa-pencil mr-2 text-yellow-600"></i>
                                Editing Draft Response
                            {% else %}
                                Response Form
                            {% endif %}
                        </h2>
                        <p class="text-gray-600">
                            {% if is_editing_draft %}
                                Continue working on your saved response. You can save your progress or submit when ready.
                            {% else %}
                                Please complete all required fields below to submit your organization's response.
                            {% endif %}
                        </p>
                    </div>
                    {% if is_editing_draft %}
                        <div class="text-right">
                            <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">
                                <i class="fa-solid fa-clock mr-2"></i>
                                Last saved: <time class="local-datetime" datetime="{{ draft.date_modified|date:'c' }}">{{ draft.date_modified|date:"M j, Y g:i A" }}</time>
                            </span>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Solicitation Summary -->
            <div class="flex flex-col p-6 rounded-xl shadow-sm bg-white gap-5 relative mb-8">
                <div class="absolute w-8 bg-brand-mango h-2 top-0 -translate-y-1/2 left-6 rounded-full"></div>

                <div class="flex w-full justify-between">
                    <div class="w-full">
                        <div class="flex items-center gap-3 mb-2">
                            <span class="badge badge-md {% if solicitation.solicitation_type == 'eoi' %}primary-light{% else %}warning-light{% endif %}">
                                {{ solicitation.get_solicitation_type_display }}
                            </span>
                            <div class="flex items-center gap-1 text-sm text-green-600">
                                <div class="w-2 h-2 bg-green-500 rounded-full"></div>
                                <span>Active</span>
                            </div>
                        </div>
                        <p class="card_title">{{ solicitation.title }}</p>
                        <p class="card_description w-full max-w-3xl">{{ solicitation.description|truncatewords:30 }}</p>
                    </div>
                </div>

                <!-- Key Information Row -->
                <div class="bg-neutral-100 rounded-lg w-full px-5 py-4">
                    <div class="flex gap-2 w-full items-center justify-between flex-wrap">
                        <div class="flex gap-2 items-start">
                            <div class="infocard-dark">
                                <i class="fa-solid fa-building"></i>
                                <div>
                                    <h6>Program</h6>
                                    <p>{{ solicitation.program.name }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="w-0.5 h-10 bg-slate-200 bg-opacity-30"></div>

                        <div class="flex gap-2 items-start">
                            <div class="infocard-dark">
                                <i class="fa-solid fa-location-dot"></i>
                                <div>
                                    <h6>Target Population</h6>
                                    <p>{{ solicitation.target_population }}</p>
                                </div>
                            </div>
                        </div>

                        {% if solicitation.estimated_scale %}
                            <div class="w-0.5 h-10 bg-slate-200 bg-opacity-30"></div>

                            <div class="flex gap-2 items-start">
                                <div class="infocard-dark">
                                    <i class="fa-solid fa-chart-bar"></i>
                                    <div>
                                        <h6>Scale</h6>
                                        <p>{{ solicitation.estimated_scale }}</p>
                                    </div>
                                </div>
                            </div>
                        {% endif %}

                        <div class="w-0.5 h-10 bg-slate-200 bg-opacity-30"></div>

                        <div class="flex gap-2 items-start">
                            <div class="infocard-dark">
                                <i class="fa-solid fa-clock"></i>
                                <div>
                                    <h6>Application Deadline</h6>
                                    <p>{{ solicitation.application_deadline|date:"M j, Y" }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="w-0.5 h-10 bg-slate-200 bg-opacity-30"></div>

                        <div class="flex gap-2 items-start">
                            <div class="infocard-dark">
                                <i class="fa-solid fa-calendar-check"></i>
                                <div>
                                    <h6>Start Date</h6>
                                    <p>{{ solicitation.expected_start_date|date:"M Y"|default:"TBD" }}</p>
                                </div>
                            </div>
                        </div>

                        <div class="w-0.5 h-10 bg-slate-200 bg-opacity-30"></div>

                        <div class="flex gap-2 items-start">
                            <div class="infocard-dark">
                                <i class="fa-solid fa-calendar-xmark"></i>
                                <div>
                                    <h6>End Date</h6>
                                    <p>{{ solicitation.expected_end_date|date:"M Y"|default:"TBD" }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Response Form -->
            <form x-data="responseFormHandler()" @submit="handleSubmit($event)" method="post" enctype="multipart/form-data" class="space-y-6" novalidate>
                {% csrf_token %}

                <!-- Organization Info -->
                <div class="bg-white rounded-lg p-6">
                    <h4 class="text-lg font-medium text-brand-deep-purple mb-3">
                        <i class="fa-solid fa-building mr-2"></i>
                        Organization Information
                    </h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div>
                            <span class="font-medium text-gray-700">Organization:</span>
                            <span class="ml-2">{{ user.memberships.first.organization.name }}</span>
                        </div>
                        <div>
                            <span class="font-medium text-gray-700">Submitted by:</span>
                            <span class="ml-2">{{ user.get_full_name }} ({{ user.email }})</span>
                        </div>
                    </div>
                </div>

                <!-- Dynamic Questions -->
                {% if questions %}
                    {% crispy form %}
                {% endif %}

                <!-- Form Actions -->
                <div class="flex items-center justify-between pt-6 border-t border-gray-200">
                    <div class="flex items-center gap-4">
                        <a href="/solicitations/s/{{ solicitation.pk }}/"
                           class="button button-md outline-style">
                            <i class="fa-solid fa-arrow-left mr-2"></i>
                            Back to Solicitation
                        </a>

                        {% if user.memberships.exists %}
                            <a href="{% url 'org_solicitations:draft_list' org_slug=request.org.slug %}"
                               class="button button-md outline-style">
                                <i class="fa-solid fa-file-lines mr-2"></i>
                                My Drafts
                            </a>
                        {% endif %}
                    </div>

                    <div class="flex items-center gap-4">
                        <button type="submit" name="action" value="save_draft"
                                class="button button-md outline-style">
                            <i class="fa-solid fa-floppy-disk mr-2"></i>
                            Save Draft
                        </button>

                        <button type="submit" name="action" value="submit"
                                class="button button-md primary-dark">
                            <i class="fa-solid fa-paper-plane mr-2"></i>
                            Submit Response
                        </button>
                    </div>
                </div>
            </form>
        </div>

        <!-- File Attachments Section (Outside Main Form) -->
        <div class="bg-white rounded-xl shadow-sm p-8">
            <h4 class="text-lg font-medium text-brand-deep-purple mb-3">
                <i class="fa-solid fa-paperclip mr-2"></i>
                Supporting Documents
            </h4>
            <p class="text-sm text-gray-600 mb-4">
                Upload supporting documents for your response (optional). You can upload multiple files one at a time.
            </p>

            <!-- File Upload Form (Separate from main form) -->
            <form method="post" enctype="multipart/form-data" action="{% url 'org_solicitations:upload_attachment' org_slug=request.org.slug pk=solicitation.pk %}" class="mb-6">
                {% csrf_token %}
                <div class="flex items-end gap-3">
                    <div class="flex-1">
                        <input type="file"
                               name="attachment"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-brand-indigo focus:border-brand-indigo"
                               accept=".pdf,.doc,.docx,.xls,.xlsx,.jpg,.jpeg,.png"
                               required>
                    </div>
                    <button type="submit" class="button button-md primary-dark">
                        <i class="fa-solid fa-upload mr-2"></i>
                        Upload File
                    </button>
                </div>
                <p class="text-xs text-gray-500 mt-2">
                    Accepted formats: PDF, DOC, DOCX, XLS, XLSX, JPG, PNG (Max 10MB per file)
                </p>
            </form>

            <!-- Uploaded Files List -->
            {% if existing_attachments %}
                <div class="space-y-2">
                    <h5 class="text-sm font-medium text-gray-700 mb-2">Uploaded Files:</h5>
                    {% for attachment in existing_attachments %}
                        <div class="flex items-center justify-between bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="flex items-center">
                                <i class="fa-solid fa-file-alt text-green-600 mr-3"></i>
                                <div>
                                    <p class="text-sm font-medium text-gray-900">{{ attachment.original_filename }}</p>
                                    <p class="text-xs text-gray-500">{{ attachment.file_size_mb }} MB • Uploaded <time class="local-datetime" datetime="{{ attachment.date_created|date:'c' }}">{{ attachment.date_created|date:"M j, Y g:i A" }}</time></p>
                                </div>
                            </div>
                            <form method="post" action="{% url 'org_solicitations:delete_attachment' org_slug=request.org.slug pk=solicitation.pk attachment_id=attachment.pk %}" class="inline">
                                {% csrf_token %}
                                <button type="submit"
                                        class="text-red-600 hover:text-red-800 p-1"
                                        title="Delete file"
                                        onclick="return confirm('Are you sure you want to delete this file?')">
                                    <i class="fa-solid fa-trash-alt"></i>
                                </button>
                            </form>
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="text-center py-4 text-gray-500 text-sm">
                    No files uploaded yet.
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Notification Area -->
    <div x-data="{ notifications: [] }" @show-notification.window="notifications.push($event.detail); setTimeout(() => notifications.shift(), $event.detail.type === 'error' ? 5000 : 3000)" class="fixed top-4 right-4 z-50 space-y-2">
        <template x-for="(notification, index) in notifications" :key="index">
            <div class="px-4 py-2 rounded-md shadow-lg text-white flex items-center"
                 :class="{
                     'bg-blue-500': notification.type === 'info',
                     'bg-green-500': notification.type === 'success',
                     'bg-red-500': notification.type === 'error'
                 }"
                 x-transition:enter="transform ease-out duration-300 transition"
                 x-transition:enter-start="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
                 x-transition:enter-end="translate-y-0 opacity-100 sm:translate-x-0"
                 x-transition:leave="transition ease-in duration-100"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0">
                <i class="fa-solid mr-2"
                   :class="{
                       'fa-info-circle': notification.type === 'info',
                       'fa-check-circle': notification.type === 'success',
                       'fa-exclamation-triangle-circle': notification.type === 'error'
                   }"></i>
                <span x-text="notification.message"></span>
            </div>
        </template>
    </div>
{% endblock %}

{% block inline_javascript %}
<script>
// Alpine.js Component for Response Form Handler

function responseFormHandler() {
    return {
        autoSaveTimer: null,
        autoSaveDelay: 30000, // 30 seconds

        init() {
            // Set up auto-save on form changes
            this.$el.addEventListener('input', () => {
                clearTimeout(this.autoSaveTimer);
                this.autoSaveTimer = setTimeout(() => this.autoSave(), this.autoSaveDelay);
            });

            this.$el.addEventListener('change', () => {
                clearTimeout(this.autoSaveTimer);
                this.autoSaveTimer = setTimeout(() => this.autoSave(), this.autoSaveDelay);
            });
        },

        collectFormData() {
            const formData = new FormData(this.$el);
            const responses = {};

            // Collect all form fields (excluding files and form actions)
            for (let [key, value] of formData.entries()) {
                if (key !== 'csrfmiddlewaretoken' && key !== 'action') {
                    responses[key] = value;
                }
            }

            return { responses: responses };
        },

        showNotification(message, type = 'info') {
            // Use Alpine.js event system for notifications
            window.dispatchEvent(new CustomEvent('show-notification', {
                detail: { message, type }
            }));
        },

        async autoSave() {
            const data = this.collectFormData();

            try {
                const response = await fetch("{% url 'org_solicitations:save_draft' org_slug=request.org.slug pk=solicitation.pk %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                if (result.success) {
                    this.showNotification('Draft saved automatically', 'success');
                } else {
                    console.error('Auto-save failed:', result.error);
                }
            } catch (error) {
                console.error('Auto-save error:', error);
            }
        },

        handleSubmit(e) {
            // Check if this is a draft save - no validation needed
            const actionButton = e.submitter;
            if (actionButton && actionButton.value === 'save_draft') {
                // Allow draft save without validation
                return true;
            }

            // For submit action, validate required fields
            // Check required fields only for submission
            const requiredFields = this.$el.querySelectorAll('[required]');
            let hasEmptyRequired = false;

            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    hasEmptyRequired = true;
                    field.style.borderColor = '#ef4444';
                    field.style.boxShadow = '0 0 0 1px #ef4444';
                } else {
                    field.style.borderColor = '';
                    field.style.boxShadow = '';
                }
            });

            if (hasEmptyRequired) {
                e.preventDefault();
                this.showNotification('Please fill in all required fields before submitting.', 'error');
                return false;
            }

            // Allow form to submit normally
            return true;
        }
    }
}

// Register Alpine.js component
document.addEventListener('alpine:init', () => {
    Alpine.data('responseFormHandler', responseFormHandler);
});
</script>
{% endblock %}
