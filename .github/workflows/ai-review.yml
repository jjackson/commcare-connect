name: AI Code Review

on:
  pull_request_target:
    types: [opened, synchronize]

concurrency:
  group: ai-review-${{ github.event.pull_request.number }}
  cancel-in-progress: true

permissions:
  pull-requests: write
  contents: read

jobs:
  ai-review:
    runs-on: ubuntu-latest
    steps:
      - name: Get PR diff
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr diff ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} > /tmp/pr_diff.txt
          # Truncate large diffs to stay within Claude's context limits
          head -c 90000 /tmp/pr_diff.txt > /tmp/pr_diff_trimmed.txt

      - name: Run AI Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PAYLOAD=$(jq -n \
            --arg diff "$(</tmp/pr_diff_trimmed.txt)" \
            '{
              "model": "claude-sonnet-4-5-20250929",
              "max_tokens": 4096,
              "system": "You are a senior code reviewer. Review the PR diff provided. Focus on: bugs, logic errors, security issues, performance problems. Classify each finding as ðŸ”´ Critical, ðŸŸ¡ Warning, or ðŸ”µ Suggestion. Be concise. Skip style/formatting issues (handled by linters). If the code looks good, say so briefly. Output clean GitHub-flavored markdown.",
              "messages": [{"role": "user", "content": ("Review this PR diff:\n\n" + $diff)}]
            }')

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "content-type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "$PAYLOAD")

          echo "$RESPONSE" | jq -r '.content[0].text' > /tmp/review.md

      - name: Post review comment
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          {
            echo "## ðŸ¤– AI Code Review"
            echo ""
            cat /tmp/review.md
            echo ""
            echo "---"
            echo "*Powered by Claude â€” auto-generated review*"
          } > /tmp/comment.md

          gh pr comment ${{ github.event.pull_request.number }} \
            --repo ${{ github.repository }} \
            --body-file /tmp/comment.md
